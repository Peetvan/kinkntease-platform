<!-- BUILD: KINKNTEASE-LATEST-DEC01-2024-WATERMARK-DELETE-AVATARS-v5680 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kinkntease - Connect with Like-Minded Adults</title>
<style>
:root{--primary:#e94560;--secondary:#4ecca3;--dark:#1a1a2e;--darker:#16213e;--card:#0f3460}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--dark);color:#fff;min-height:100vh}
a{color:var(--primary);text-decoration:none}
.app{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--darker);border-right:1px solid #333;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;z-index:100}
.sidebar-logo{padding:15px;font-size:18px;font-weight:bold;border-bottom:1px solid #333}
.sidebar-section{padding:5px 0}
.sidebar-title{color:#666;font-size:10px;text-transform:uppercase;padding:8px 15px;letter-spacing:1px}
.sidebar-item{padding:10px 15px;cursor:pointer;display:flex;align-items:center;gap:10px;color:#aaa;transition:all 0.2s;border-left:3px solid transparent;font-size:14px}
.sidebar-item:hover{background:rgba(233,69,96,0.1);color:#fff}
.sidebar-item.active{background:rgba(233,69,96,0.15);color:var(--primary);border-left-color:var(--primary)}
.sidebar-item .badge{background:var(--primary);color:#fff;font-size:9px;padding:2px 6px;border-radius:10px;margin-left:auto}
.main-wrapper{flex:1;margin-left:220px;display:flex;flex-direction:column;min-height:100vh}
.top-nav{background:linear-gradient(135deg,var(--primary),#c0392b);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:99}
.nav-search input{padding:10px 20px;border-radius:25px;border:none;background:rgba(255,255,255,0.2);color:#fff;width:280px}
.nav-search input::placeholder{color:rgba(255,255,255,0.7)}
.nav-actions{display:flex;align-items:center;gap:12px}
.nav-btn{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 12px;border-radius:20px;cursor:pointer;position:relative;display:flex;flex-direction:column;align-items:center;gap:2px;min-width:60px}
.nav-btn:hover{background:rgba(255,255,255,0.3)}
.nav-btn .nav-icon{font-size:20px;display:block}
.nav-btn .nav-label{font-size:10px;display:block;opacity:1;font-weight:600;white-space:nowrap;margin-top:2px}
.nav-btn .badge{position:absolute;top:-2px;right:-2px;background:#ffd700;color:#000;font-size:10px;padding:2px 6px;border-radius:10px;font-weight:bold}
.user-menu{display:flex;align-items:center;gap:12px;position:relative}
.coins-display{background:linear-gradient(135deg,#f39c12,#e67e22);padding:8px 15px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px}
.membership-status{padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;transition:all 0.3s;margin-right:12px;white-space:nowrap}
.membership-status-top{padding:10px 20px;border-radius:25px;cursor:pointer;font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:0.8px;transition:all 0.3s;margin-right:15px;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.membership-status.free,.membership-status-top.free{background:rgba(255,255,255,0.1);color:#aaa;border:2px solid #666}
.membership-status.free:hover,.membership-status-top.free:hover{background:var(--primary);color:#fff;border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(233,69,96,0.4)}
.membership-status.premium,.membership-status-top.premium{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;border:2px solid #f39c12;box-shadow:0 2px 8px rgba(243,156,18,0.4)}
.membership-status.premium:hover,.membership-status-top.premium:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(243,156,18,0.6)}
.user-avatar{min-width:40px;height:40px;border-radius:20px;background:var(--secondary);display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;background-size:cover;background-position:center;border:2px solid #fff;padding:0 12px;font-size:13px;white-space:nowrap;transition:all 0.3s}
.user-avatar:hover{background:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(233,69,96,0.4)}
.user-dropdown{position:absolute;top:50px;right:0;background:var(--darker);border:1px solid #333;border-radius:12px;min-width:200px;display:none;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.user-dropdown.show{display:block}
.user-dropdown-item{padding:12px 20px;cursor:pointer;display:flex;align-items:center;gap:10px;color:#ccc}
.user-dropdown-item:hover{background:rgba(233,69,96,0.1);color:#fff}
.user-dropdown-divider{height:1px;background:#333}
.content{flex:1;padding:25px}
.page-header{margin-bottom:25px}
.page-title{font-size:26px;color:var(--primary);margin-bottom:5px}
.page-subtitle{color:#888;font-size:14px}
.btn{padding:10px 20px;border:none;border-radius:20px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:14px}
.btn-primary{background:linear-gradient(135deg,var(--primary),#c0392b);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(233,69,96,0.4)}
.btn-secondary{background:var(--darker);color:#fff;border:1px solid #444}
.btn-success{background:linear-gradient(135deg,var(--secondary),#27ae60);color:#fff}
.filters-bar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.filter-input,.filter-select{padding:10px 15px;background:var(--darker);border:1px solid #333;border-radius:10px;color:#fff;font-size:14px;width:100%}
.filter-input{min-width:180px}
.filter-input::placeholder{color:#666}
.filter-input:focus,.filter-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(233,69,96,0.1)}
.filter-checkbox{display:inline-flex;align-items:center;gap:8px;color:#aaa;cursor:pointer;padding:8px 16px;background:rgba(255,255,255,0.05);border-radius:8px;border:1px solid transparent;font-size:13px;transition:all 0.2s}
.filter-checkbox:hover{background:rgba(255,255,255,0.08);border-color:#333}
.filter-checkbox input[type="checkbox"]{width:16px;height:16px;cursor:pointer;accent-color:var(--primary)}
.filter-checkbox input[type="checkbox"]:checked + span{color:var(--primary);font-weight:500}
.members-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px}
.member-card{background:var(--darker);border-radius:14px;overflow:hidden;cursor:pointer;transition:all 0.3s;border:1px solid #333}
.member-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(233,69,96,0.2);border-color:var(--primary)}
.member-photo{height:200px;background:var(--card);position:relative;overflow:hidden}
.member-photo img{width:100%;height:100%;object-fit:cover}
.member-photo-placeholder{height:100%;display:flex;align-items:center;justify-content:center;font-size:60px;color:#333}
.badge-online{position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.8);color:var(--secondary);padding:4px 10px;border-radius:12px;font-size:11px}
.badge-premium{position:absolute;top:8px;right:8px;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;padding:4px 8px;border-radius:10px;font-size:10px;font-weight:bold}
.member-info{padding:12px}
.member-name{font-size:15px;font-weight:600;margin-bottom:4px}
.member-name .verified{color:var(--secondary);font-size:12px}
.member-details{color:#888;font-size:12px;margin-bottom:6px}
.member-bio{color:#aaa;font-size:11px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.messages-container{display:flex;height:calc(100vh - 160px);background:var(--darker);border-radius:14px;overflow:hidden;border:1px solid #333}
.conversations-sidebar{width:300px;border-right:1px solid #333;display:flex;flex-direction:column}
.conversations-header{padding:15px;border-bottom:1px solid #333}
.conversations-header h3{font-size:16px;margin-bottom:10px}
.conversations-search{width:100%;padding:10px 15px;background:var(--card);border:1px solid #333;border-radius:10px;color:#fff;font-size:13px}
.conversations-list{flex:1;overflow-y:auto}
.conversation-item{padding:12px 15px;cursor:pointer;display:flex;align-items:center;gap:12px;border-bottom:1px solid #222;transition:background 0.2s}
.conversation-item:hover{background:rgba(233,69,96,0.1)}
.conversation-item.active{background:rgba(233,69,96,0.15);border-left:3px solid var(--primary)}
.conv-avatar{min-width:45px;height:45px;border-radius:22px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:bold;flex-shrink:0;background-size:cover;background-position:center;padding:0 10px;font-size:13px;cursor:pointer;transition:all 0.3s}
.conv-avatar:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(233,69,96,0.4)}
.conv-info{flex:1;min-width:0}
.conv-name{font-weight:600;font-size:14px;margin-bottom:3px}
.conv-preview{color:#888;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-meta{text-align:right}
.conv-time{color:#666;font-size:11px}
.conv-unread{background:var(--primary);color:#fff;font-size:10px;padding:2px 8px;border-radius:10px;margin-top:5px;display:inline-block}
.chat-area{flex:1;display:flex;flex-direction:column}
.chat-header{padding:15px;border-bottom:1px solid #333;display:flex;align-items:center;gap:12px}
.chat-header-info{flex:1}
.chat-header-name{font-weight:600;font-size:15px}
.chat-header-status{color:var(--secondary);font-size:12px}
.chat-messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px}
.message{display:flex;gap:10px;max-width:75%;flex-direction:row-reverse}
.message.sent{margin-left:0;flex-direction:row}
.message-avatar{min-width:32px;height:32px;border-radius:16px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;padding:0 8px;cursor:pointer;transition:all 0.3s}
.message-avatar:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(233,69,96,0.4)}
.message-content{flex:1}
.message-bubble{padding:10px 14px;border-radius:14px;background:var(--card);color:#ddd;line-height:1.5;font-size:14px}
.message.sent .message-bubble{background:var(--primary);color:#fff}
.message-time{font-size:10px;color:#666;margin-top:4px;text-align:right;display:flex;align-items:center;gap:8px;justify-content:flex-end}
.message.sent .message-time{justify-content:flex-start}
.message-delete-btn{background:transparent;border:none;color:#e74c3c;font-size:12px;cursor:pointer;padding:2px 5px;border-radius:3px;opacity:0.6;transition:all 0.2s}
.message-delete-btn:hover{opacity:1;background:rgba(231,76,60,0.1)}
.photo-delete-btn{position:absolute;top:5px;right:5px;background:rgba(231,76,60,0.9);border:none;color:#fff;font-size:16px;cursor:pointer;padding:6px 10px;border-radius:5px;opacity:0.8;transition:all 0.2s;z-index:10}
.photo-delete-btn:hover{opacity:1;background:#e74c3c;transform:scale(1.1)}
.voice-delete-btn{background:rgba(231,76,60,0.9);border:none;color:#fff;font-size:14px;cursor:pointer;padding:5px 10px;border-radius:5px;opacity:0.8;transition:all 0.2s;margin-left:10px}
.voice-delete-btn:hover{opacity:1;background:#e74c3c}
.chat-input-area{padding:15px;border-top:1px solid #333}
.chat-input-wrapper{display:flex;gap:10px;align-items:center}
.chat-input-btn{background:transparent;border:none;color:#888;font-size:18px;cursor:pointer;padding:8px;transition:all 0.2s}
.chat-input-btn:hover{color:var(--primary);transform:scale(1.1)}
.chat-input-btn.active{color:var(--primary)}
.chat-input{flex:1;padding:12px 18px;background:var(--card);border:1px solid #333;border-radius:25px;color:#fff;font-size:14px}
.chat-send-btn{background:var(--primary);border:none;width:44px;height:44px;border-radius:50%;color:#fff;cursor:pointer;font-size:16px;transition:all 0.2s}
.chat-send-btn:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(233,69,96,0.4)}

/* Emoji Picker */
.emoji-picker{position:absolute;bottom:60px;left:10px;background:var(--darker);border:1px solid #333;border-radius:12px;padding:10px;display:none;z-index:100;box-shadow:0 10px 40px rgba(0,0,0,0.5);max-width:320px}
.emoji-picker.show{display:block}
.emoji-category{margin-bottom:10px}
.emoji-category-title{font-size:11px;color:#666;text-transform:uppercase;margin-bottom:5px;padding:5px}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.emoji-btn{background:transparent;border:none;font-size:24px;cursor:pointer;padding:5px;border-radius:5px;transition:all 0.2s}
.emoji-btn:hover{background:rgba(233,69,96,0.1);transform:scale(1.2)}

/* Voice Recording */
.voice-recorder{position:absolute;bottom:60px;left:10px;background:var(--darker);border:1px solid #333;border-radius:12px;padding:20px;display:none;z-index:100;box-shadow:0 10px 40px rgba(0,0,0,0.5);min-width:250px}
.voice-recorder.show{display:flex;flex-direction:column;align-items:center;gap:15px}
.recording-indicator{color:var(--primary);font-size:48px;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.recording-time{font-size:24px;font-weight:bold;color:#fff}
.recording-controls{display:flex;gap:10px}

/* Media Message Types */
.message-photo{max-width:300px;border-radius:10px;cursor:pointer;margin-top:5px}
.message-photo:hover{opacity:0.9}
.message-voice{background:rgba(78,204,163,0.1);padding:10px 15px;border-radius:20px;display:flex;align-items:center;gap:10px;margin-top:5px}
.voice-play-btn{background:var(--secondary);border:none;width:36px;height:36px;border-radius:50%;color:#fff;cursor:pointer;font-size:14px}
.voice-waveform{flex:1;height:30px;background:rgba(78,204,163,0.2);border-radius:15px;position:relative;overflow:hidden}
.voice-progress{background:var(--secondary);height:100%;border-radius:15px;transition:width 0.1s}

/* Voice Recording Items (Profile) */
.voice-recording-item{background:var(--darker);padding:15px;border-radius:10px;display:flex;align-items:center;gap:15px;position:relative}
.voice-recording-item .voice-play-btn{flex-shrink:0}
.voice-recording-item .voice-waveform{flex:1}
.voice-recording-info{flex:1;min-width:0}
.voice-recording-title{font-size:14px;font-weight:600;color:#fff;margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.voice-recording-duration{font-size:11px;color:#888}
.voice-recording-actions{display:flex;gap:5px}
.voice-recording-actions button{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:11px;transition:all 0.2s}
.voice-recording-actions button:hover{background:rgba(255,255,255,0.2)}

/* Video Call */
.video-call-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;display:none;align-items:center;justify-content:center}
.video-call-modal.show{display:flex}
.video-container{width:90%;max-width:1200px;height:80vh;background:var(--card);border-radius:16px;position:relative;overflow:hidden}
.video-main{width:100%;height:100%;background:#000}
.video-self{position:absolute;bottom:20px;right:20px;width:200px;height:150px;background:#000;border-radius:10px;border:2px solid var(--primary)}
.video-controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:15px;background:rgba(0,0,0,0.7);padding:15px 25px;border-radius:50px}
.video-control-btn{background:rgba(255,255,255,0.2);border:none;width:50px;height:50px;border-radius:50%;color:#fff;cursor:pointer;font-size:20px;transition:all 0.2s}
.video-control-btn:hover{background:rgba(255,255,255,0.3)}
.video-control-btn.danger{background:var(--primary)}
.video-control-btn.danger:hover{background:#c0392b}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal.show{display:flex}
.modal-content{background:var(--dark);border:1px solid #333;border-radius:16px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;position:relative}
.modal-content.large{max-width:900px}
.modal-content.medium{max-width:700px}
.modal-content.small{max-width:500px}
@media(min-width:1400px){.modal-content{max-width:800px}.modal-content.large{max-width:1200px}.modal-content.medium{max-width:900px}}
@media(max-width:768px){.modal-content{width:95%;max-width:none;max-height:95vh}.modal-content.large,.modal-content.medium,.modal-content.small{max-width:none}}
.modal-close{position:absolute;top:12px;right:12px;background:rgba(255,255,255,0.1);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;z-index:1}
.modal-header{padding:25px 25px 15px;text-align:center}
.modal-title{font-size:22px;color:var(--primary);margin-bottom:8px}
.modal-subtitle{color:#888;font-size:13px}
.modal-body{padding:0 25px 25px}
.form-group{margin-bottom:18px}
.form-group label{display:block;color:#888;font-size:13px;margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 16px;background:var(--darker);border:1px solid #333;border-radius:10px;color:#fff;font-size:14px}
.form-group textarea{min-height:120px;resize:vertical;font-family:inherit}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.error-box{background:rgba(231,76,60,0.2);border:1px solid #e74c3c;color:#e74c3c;padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px}
.success-box{background:rgba(46,204,113,0.2);border:1px solid #2ecc71;color:#2ecc71;padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px}
.profile-header{padding:25px;text-align:center;background:linear-gradient(135deg,var(--darker),var(--card));border-radius:16px 16px 0 0}
.profile-avatar{width:100px;height:100px;border-radius:50%;margin:0 auto 12px;overflow:hidden;border:3px solid var(--primary);background:var(--card)}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.profile-name{font-size:22px;font-weight:bold;margin-bottom:5px}
.profile-tagline{color:#888;font-size:14px;margin-bottom:12px}
.profile-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.profile-section{padding:18px 25px;border-bottom:1px solid #333}
.profile-section:last-child{border-bottom:none}
.profile-section-title{font-size:13px;color:var(--secondary);margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
.profile-section p{color:#ccc;line-height:1.6;font-size:14px}
.profile-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.profile-detail{background:var(--darker);padding:10px 12px;border-radius:8px}
.profile-detail-label{color:#666;font-size:10px;text-transform:uppercase}
.profile-detail-value{color:#fff;font-weight:500;margin-top:2px;font-size:13px}
.loading{text-align:center;padding:50px}
.spinner{width:40px;height:40px;border:3px solid #333;border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 15px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:50px}
.empty-state-icon{font-size:60px;margin-bottom:15px;opacity:0.5}
.empty-state-title{font-size:18px;margin-bottom:8px}
.empty-state-text{color:#888;margin-bottom:20px;font-size:14px}
.toast{position:fixed;bottom:25px;left:50%;transform:translateX(-50%);padding:12px 25px;border-radius:25px;color:#fff;font-weight:600;z-index:1002;font-size:14px}
.toast.success{background:#27ae60}
.toast.error{background:#e74c3c}
.toast.info{background:#3498db}
.story-card{background:var(--darker);border-radius:14px;padding:20px;border:1px solid #333;transition:all 0.3s;cursor:pointer}
.story-card:hover{border-color:var(--primary);transform:translateY(-3px);box-shadow:0 5px 20px rgba(233,69,96,0.2)}

/* Media Delete Button */
.media-delete-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);border:none;color:#e74c3c;font-size:16px;cursor:pointer;padding:8px 12px;border-radius:8px;opacity:0;transition:all 0.2s;z-index:10}
.story-card:hover .media-delete-btn,div:hover .media-delete-btn{opacity:1}
.media-delete-btn:hover{background:rgba(231,76,60,0.9);color:#fff;transform:scale(1.1)}

.story-title{font-size:18px;font-weight:600;color:#fff;margin-bottom:8px}
.story-meta{color:#888;font-size:12px;margin-bottom:12px}
.story-preview{color:#aaa;line-height:1.6;font-size:14px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.story-tags{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.story-tag{background:rgba(233,69,96,0.2);color:var(--primary);padding:4px 10px;border-radius:12px;font-size:11px}
.photo-upload-area{border:2px dashed #444;border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all 0.3s;background:var(--darker)}
.photo-upload-area:hover{border-color:var(--primary);background:rgba(233,69,96,0.05)}
.photo-upload-area.dragover{border-color:var(--secondary);background:rgba(78,204,163,0.05)}
.room-card{background:var(--darker);border-radius:14px;padding:25px;border:1px solid #333;transition:all 0.3s;cursor:pointer;text-align:center}
.room-card:hover{border-color:var(--primary);transform:translateY(-3px);box-shadow:0 5px 20px rgba(233,69,96,0.2)}
.room-icon{font-size:50px;margin-bottom:12px}
.room-name{font-size:18px;font-weight:600;margin-bottom:8px}
.room-description{color:#888;font-size:13px;margin-bottom:12px}
.room-users{color:var(--secondary);font-size:12px}

/* COMPREHENSIVE PROFILE STYLES */
.profile-photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:15px}
.profile-photo-item{position:relative;aspect-ratio:1;border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid transparent}
.profile-photo-item.primary{border-color:var(--primary)}
.profile-photo-item img{width:100%;height:100%;object-fit:cover}
.profile-photo-badge{position:absolute;top:5px;right:5px;background:var(--primary);color:#fff;font-size:9px;padding:3px 8px;border-radius:10px;font-weight:bold}
.profile-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;padding:20px;background:var(--darker);margin:15px 0;border-radius:12px}
.profile-stat{text-align:center}
.profile-stat-value{font-size:24px;font-weight:bold;color:var(--primary)}
.profile-stat-label{font-size:11px;color:#888;margin-top:4px;text-transform:uppercase}
.profile-field-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-top:15px}
.profile-field{background:var(--card);padding:12px;border-radius:10px}
.profile-field-label{color:#888;font-size:11px;text-transform:uppercase;margin-bottom:5px}
.profile-field-value{color:#fff;font-size:14px;font-weight:500}
.profile-interests{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.interest-tag{background:rgba(233,69,96,0.15);color:var(--primary);padding:6px 14px;border-radius:16px;font-size:12px;border:1px solid rgba(233,69,96,0.3)}
.section-header{font-size:15px;color:var(--secondary);margin:20px 0 12px 0;padding-bottom:8px;border-bottom:1px solid #333;text-transform:uppercase;letter-spacing:1px;font-weight:600}
.checkbox-group{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:8px}
.checkbox-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--card);border-radius:8px;cursor:pointer}
.checkbox-item input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
.checkbox-item label{cursor:pointer;font-size:13px;flex:1}
.photo-manager{background:var(--card);padding:20px;border-radius:12px;margin-bottom:20px}
.current-photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:15px}
.photo-slot{position:relative;aspect-ratio:1;background:var(--darker);border-radius:10px;overflow:hidden;border:2px dashed #444;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-direction:column}
.photo-slot.has-photo{border:2px solid #333}
.photo-slot.primary-photo{border:2px solid var(--primary)}
.photo-slot img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
.photo-slot-actions{position:absolute;top:5px;right:5px;display:flex;gap:3px;opacity:0;transition:opacity 0.3s;z-index:1}
.photo-slot:hover .photo-slot-actions{opacity:1}
.photo-mini-btn{background:rgba(0,0,0,0.8);border:none;color:#fff;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:10px}

@media(max-width:900px){.sidebar{width:60px}.sidebar-logo span,.sidebar-title,.sidebar-item span:not(:first-child){display:none}.sidebar-item{justify-content:center;padding:15px}.main-wrapper{margin-left:60px}}
@media(max-width:768px){.sidebar{display:none}.main-wrapper{margin-left:0}.nav-search input{width:150px}.members-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}.member-photo{height:160px}.conversations-sidebar{width:100%}.chat-area{display:none}.form-row{grid-template-columns:1fr}.profile-stats{grid-template-columns:repeat(2,1fr)}.profile-field-grid{grid-template-columns:1fr}.checkbox-group{grid-template-columns:1fr}}
/* ==================== ADMIN PANEL ==================== */
.admin-tabs{display:flex;gap:10px;margin-bottom:25px;border-bottom:2px solid #333;flex-wrap:wrap}
.admin-tab{background:transparent;border:none;color:#888;padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;border-bottom:3px solid transparent;transition:all 0.3s}
.admin-tab:hover{color:var(--primary)}
.admin-tab.active{color:var(--primary);border-bottom-color:var(--primary)}

.admin-tab-content{animation:fadeIn 0.3s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.admin-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
.admin-stat-card{background:linear-gradient(135deg,var(--darker) 0%,var(--card) 100%);padding:25px;border-radius:14px;text-align:center;border:1px solid #333}
.admin-stat-icon{font-size:40px;margin-bottom:10px}
.admin-stat-value{font-size:32px;font-weight:bold;color:var(--primary);margin-bottom:5px}
.admin-stat-label{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px}

.admin-section{margin-top:30px}
.admin-section h3{color:var(--secondary);margin-bottom:15px;font-size:18px}

.admin-toolbar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.admin-search{flex:1;min-width:250px;padding:12px 18px;background:var(--card);border:1px solid #333;border-radius:10px;color:#fff;font-size:14px}
.admin-filter{padding:12px 18px;background:var(--card);border:1px solid #333;border-radius:10px;color:#fff;font-size:14px;cursor:pointer}
.admin-input{width:100%;padding:10px 14px;background:var(--darker);border:1px solid #333;border-radius:8px;color:#fff;font-size:14px}

.admin-table{width:100%;background:var(--card);border-radius:12px;overflow:hidden}
.admin-table thead{background:var(--darker)}
.admin-table th{padding:15px;text-align:left;font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid #333}
.admin-table td{padding:15px;border-bottom:1px solid #333;color:#fff;font-size:14px}
.admin-table tr:last-child td{border-bottom:none}
.admin-table tr:hover{background:rgba(233,69,96,0.05)}

.admin-table .status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
.status-badge.online{background:rgba(78,204,163,0.2);color:var(--secondary)}
.status-badge.offline{background:rgba(149,165,166,0.2);color:#95a5a6}
.status-badge.banned{background:rgba(231,76,60,0.2);color:#e74c3c}

.admin-table .user-type{padding:3px 8px;border-radius:8px;font-size:11px;font-weight:600}
.user-type.free{background:rgba(149,165,166,0.2);color:#95a5a6}
.user-type.premium{background:rgba(241,196,15,0.2);color:#f1c40f}
.user-type.vip{background:rgba(233,69,96,0.2);color:var(--primary)}

.admin-actions{display:flex;gap:5px}
.admin-action-btn{background:transparent;border:1px solid #333;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s}
.admin-action-btn:hover{border-color:var(--primary);color:var(--primary)}
.admin-action-btn.danger:hover{border-color:#e74c3c;color:#e74c3c}

.admin-room-card{background:var(--card);padding:20px;border-radius:12px;border:1px solid #333;margin-bottom:15px}
.admin-room-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.admin-room-title{font-size:18px;font-weight:bold;color:#fff}
.admin-room-stats{display:flex;gap:20px;font-size:13px;color:#888}
.admin-room-actions{display:flex;gap:8px;margin-top:15px}

.admin-settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.admin-setting-card{background:var(--card);padding:25px;border-radius:12px;border:1px solid #333}
.admin-setting-card h3{color:var(--primary);margin-bottom:20px;font-size:16px}
.admin-setting-item{margin-bottom:20px}
.admin-setting-item:last-child{margin-bottom:0}
.admin-setting-item label{display:block;color:#aaa;font-size:13px;margin-bottom:8px}

.admin-toggle{position:relative;display:inline-block;width:50px;height:26px}
.admin-toggle input{opacity:0;width:0;height:0}
.admin-toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;transition:0.3s;border-radius:26px}
.admin-toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background:#fff;transition:0.3s;border-radius:50%}
.admin-toggle input:checked + .admin-toggle-slider{background:var(--primary)}
.admin-toggle input:checked + .admin-toggle-slider:before{transform:translateX(24px)}

.admin-content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px}
.admin-content-card{background:var(--card);padding:15px;border-radius:10px;border:1px solid #333;position:relative}
.admin-content-card .content-preview{font-size:13px;color:#aaa;margin:10px 0;line-height:1.5}
.admin-content-card .content-meta{font-size:11px;color:#666;display:flex;justify-content:space-between;margin-top:10px}

/* Membership Plans */
.membership-plans{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px;max-width:1200px;margin-left:auto;margin-right:auto}
@media(max-width:1024px){.membership-plans{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.membership-plans{grid-template-columns:1fr}}
.membership-plan{background:var(--card);border:2px solid #333;border-radius:16px;padding:25px 20px;text-align:center;position:relative;transition:all 0.3s}
.membership-plan:hover{transform:translateY(-5px);border-color:var(--primary);box-shadow:0 10px 30px rgba(233,69,96,0.2)}
.membership-plan.popular{border-color:var(--secondary);background:linear-gradient(135deg, var(--card) 0%, rgba(78,204,163,0.1) 100%)}
.membership-plan.premium{border-color:#FFD700;background:linear-gradient(135deg, var(--card) 0%, rgba(255,215,0,0.1) 100%)}
.plan-badge{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:5px 15px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
.plan-badge.popular{background:var(--secondary)}
.plan-badge.premium{background:linear-gradient(135deg, #FFD700, #FFA500);color:#000}
.plan-icon{font-size:50px;margin-bottom:15px}
.plan-name{font-size:24px;font-weight:bold;color:#fff;margin-bottom:10px}
.plan-price{font-size:36px;font-weight:bold;color:var(--primary);margin-bottom:20px}
.plan-price span{font-size:16px;color:#888;font-weight:normal}
.plan-features{text-align:left;margin-bottom:25px;min-height:180px}
.plan-feature{padding:8px 0;color:#aaa;font-size:14px;border-bottom:1px solid #222}
.plan-feature:last-child{border-bottom:none}
.paypal-button-container{min-height:45px}


/* Voice Messages */
.voice-messages-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px}
.voice-message-card{background:var(--darker);border-radius:14px;padding:20px;border:1px solid #333;transition:all 0.3s}
.voice-message-card:hover{border-color:var(--primary);box-shadow:0 5px 15px rgba(233,69,96,0.1)}
.vm-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}
.vm-user{display:flex;align-items:center;gap:12px;cursor:pointer;transition:opacity 0.2s}
.vm-user:hover{opacity:0.8}
.vm-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:18px}
.vm-username{font-weight:600;font-size:14px}
.vm-time{font-size:11px;color:#888;margin-top:2px}
.vm-actions{display:flex;gap:8px}
.vm-action-btn{background:var(--card);border:1px solid #333;padding:6px 10px;border-radius:6px;cursor:pointer;transition:all 0.2s;font-size:14px}
.vm-action-btn:hover{background:var(--darker);border-color:var(--primary)}
.vm-content{margin-bottom:15px}
.vm-title{font-size:16px;font-weight:600;margin-bottom:8px;color:#fff}
.vm-description{font-size:13px;color:#aaa;line-height:1.5}
.vm-player{margin-bottom:15px;position:relative}
.vm-audio{width:100%;border-radius:8px;background:var(--card)}
.vm-duration{position:absolute;bottom:8px;right:10px;background:rgba(0,0,0,0.7);padding:3px 8px;border-radius:4px;font-size:11px;color:#fff;pointer-events:none}
.vm-stats{display:flex;gap:15px;align-items:center}
.vm-stat-btn{background:transparent;border:none;display:flex;align-items:center;gap:5px;cursor:pointer;padding:6px 12px;border-radius:6px;transition:all 0.2s}
.vm-stat-btn:hover{background:var(--card)}
.vm-stat-btn.liked{background:rgba(233,69,96,0.1)}
.vm-stat-btn.liked .vm-stat-icon{animation:heartbeat 0.5s ease}
.vm-stat{display:flex;align-items:center;gap:5px;padding:6px 12px;background:var(--card);border-radius:6px}
.vm-stat-icon{font-size:16px}
.vm-stat-count{font-size:13px;font-weight:600}
@keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
@media(max-width:768px){.voice-messages-grid{grid-template-columns:1fr}}

</style>
<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AWAEMTQx8CyTrcQcJzcNNqxxgnnW68uS7lUiHHzf4wkmgbLqeX5SpMGEa8OnOsqAgfeGbCOpYjCtJ7-r&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

</head>
<body>
<div class="app">
<aside class="sidebar">
<div class="sidebar-logo">üî• <span>Kinkntease</span></div>
<div class="sidebar-section">
<div class="sidebar-title">Discover</div>
<div class="sidebar-item active" data-view="discover"><span>üîç</span> <span>Browse</span></div>
<div class="sidebar-item" data-view="hotornot"><span>üî•</span> <span>Hot or Not</span></div>
<div class="sidebar-item" data-view="favorites"><span>‚≠ê</span> <span>Favorites</span></div>
</div>
<div class="sidebar-section">
<div class="sidebar-title">Content</div>
<div class="sidebar-item" data-view="stories"><span>üìñ</span> <span>Stories</span></div>
<div class="sidebar-item" data-view="gallery"><span>üì∏</span> <span>Gallery</span></div>
<div class="sidebar-item" data-view="rooms"><span>üí¨</span> <span>Chat Rooms</span></div>
</div>
<div class="sidebar-section">
<div class="sidebar-title">Account</div>
<div class="sidebar-item" data-view="messages"><span>‚úâÔ∏è</span> <span>Messages</span><span class="badge" id="sb-msg-badge" style="display:none">0</span></div>
<div class="sidebar-item" data-view="winks"><span>üòâ</span> <span>Winks</span><span class="badge" id="sb-wink-badge" style="display:none">0</span></div>
<div class="sidebar-item" data-view="visitors"><span>üëÄ</span> <span>Visitors</span></div>
</div>
<div class="sidebar-section">
<div class="sidebar-title">Premium</div>
<div class="sidebar-item" onclick="APP.showGiftShop()" style="color:#f39c12"><span>üéÅ</span> <span>Gifts</span></div>
<div class="sidebar-item" onclick="APP.showMembership()" style="color:#ffd700"><span>üíé</span> <span>Upgrade</span></div>
</div>
</aside>
<div class="main-wrapper">
<nav class="top-nav">
<div class="nav-search"><input type="text" id="global-search" placeholder="üîç Search members..." oninput="APP.globalSearch(this.value)"></div>
<div class="nav-actions">
<button class="nav-btn" onclick="APP.showView('messages')">
<span class="nav-icon">üí¨</span>
<span class="nav-label">Messages</span>
<span class="badge" id="nav-msg-badge" style="display:none">0</span>
</button>
<button class="nav-btn" onclick="APP.showVoiceMessages()">
<span class="nav-icon">üéôÔ∏è</span>
<span class="nav-label">Voice</span>
</button>
<button class="nav-btn" onclick="APP.showMyProfile()">
<span class="nav-icon">üë§</span>
<span class="nav-label">Profile</span>
</button>
<button class="nav-btn" onclick="APP.showNotifications()">
<span class="nav-icon">üîî</span>
<span class="nav-label">Alerts</span>
<span class="badge" id="nav-notif-badge" style="display:none">0</span>
</button>
</div>
<div class="user-menu">
<div id="auth-buttons">
<button class="btn btn-primary" onclick="APP.showModal('login')">Login</button>
<button class="btn btn-secondary" onclick="APP.showModal('register')" style="margin-left:8px">Join Free</button>
</div>
<div id="logged-in-menu" style="display:none">
<!-- Membership Status Badge - PROMINENT -->
<div id="membership-badge" class="membership-status-top" onclick="APP.showUpgrade()"></div>
<div class="coins-display" onclick="APP.showBuyCoins()">ü™ô <span id="coins-count">0</span></div>
<div class="user-avatar" id="nav-avatar" onclick="document.getElementById('user-dropdown').classList.toggle('show')" title="Menu">?</div>
<div class="user-dropdown" id="user-dropdown">
<div class="user-dropdown-item" onclick="APP.showMyProfile()">üë§ My Profile</div>
<div class="user-dropdown-item" onclick="APP.showEditProfile()">‚úèÔ∏è Edit Profile</div>
<div class="user-dropdown-item" id="admin-menu-item" onclick="APP.showView('admin')" style="display:none;color:var(--primary)">‚öôÔ∏è Admin Dashboard</div>
<div class="user-dropdown-item" onclick="APP.showMyGifts()">üéÅ My Gifts</div>
<div class="user-dropdown-item" onclick="APP.showPromoCode()">üéüÔ∏è Redeem Promo Code</div>
<div class="user-dropdown-divider"></div>
<div class="user-dropdown-item" onclick="APP.showBlockedUsers()">üö´ Blocked Users</div>
<div class="user-dropdown-divider"></div>
<div class="user-dropdown-item" onclick="APP.logout()" style="color:#e74c3c">üö™ Logout</div>
</div>
</div>
</div>
</nav>
<main class="content">
<div id="view-discover" class="view">
<div class="page-header"><h1 class="page-title">Discover Members</h1><p class="page-subtitle">Find your perfect connection</p></div>

<!-- Enhanced Search Bar -->
<div class="search-container" style="background:var(--card);padding:20px;border-radius:12px;margin-bottom:20px">
    <!-- Main Search -->
    <div style="display:flex;gap:12px;margin-bottom:15px">
        <div style="flex:1;position:relative">
            <input type="text" id="filter-search" class="filter-input" placeholder="üîç Search by name, location, interests, kinks, occupation..." oninput="APP.filterMembers()" style="width:100%;padding:14px 50px 14px 20px;font-size:16px;border-radius:10px">
            <button onclick="document.getElementById('filter-search').value='';APP.filterMembers()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#999;cursor:pointer;font-size:20px;padding:5px 10px" title="Clear search">√ó</button>
        </div>
        <button class="btn btn-secondary" onclick="APP.toggleAdvancedSearch()" style="padding:14px 24px;white-space:nowrap">
            <span id="advanced-toggle-text">‚öôÔ∏è Advanced</span>
        </button>
    </div>
    
    <!-- Results Counter & Sort -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div id="search-results-count" style="color:#aaa;font-size:14px">Showing all members</div>
        <div style="display:flex;gap:10px;align-items:center">
            <label style="color:#aaa;font-size:13px;margin:0">Sort:</label>
            <select id="filter-sort" class="filter-select" onchange="APP.filterMembers()" style="padding:8px 12px;font-size:13px">
                <option value="newest">Newest First</option>
                <option value="active">Most Active</option>
                <option value="name">Name (A-Z)</option>
                <option value="age-asc">Age (Low-High)</option>
                <option value="age-desc">Age (High-Low)</option>
            </select>
        </div>
    </div>
    
    <!-- Active Filter Tags -->
    <div id="active-filters" style="display:none;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>
    
    <!-- Advanced Search Panel (Hidden by default) -->
    <div id="advanced-search" style="display:none;border-top:1px solid #333;padding-top:15px;margin-top:15px">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
            
            <!-- Gender -->
            <div>
                <label style="display:block;color:#aaa;font-size:12px;margin-bottom:6px;text-transform:uppercase">Gender</label>
                <select id="filter-gender" class="filter-select" onchange="APP.filterMembers()">
                    <option value="">All Genders</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="couple">Couple</option>
                    <option value="non-binary">Non-Binary</option>
                </select>
            </div>
            
            <!-- Age Range -->
            <div>
                <label style="display:block;color:#aaa;font-size:12px;margin-bottom:6px;text-transform:uppercase">Age Range</label>
                <select id="filter-age" class="filter-select" onchange="APP.filterMembers()">
                    <option value="">All Ages</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46-55">46-55</option>
                    <option value="56+">56+</option>
                </select>
            </div>
            
            <!-- Location -->
            <div>
                <label style="display:block;color:#aaa;font-size:12px;margin-bottom:6px;text-transform:uppercase">Location</label>
                <input type="text" id="filter-location" class="filter-input" placeholder="City or Country" oninput="APP.filterMembers()">
            </div>
            
            <!-- Body Type -->
            <div>
                <label style="display:block;color:#aaa;font-size:12px;margin-bottom:6px;text-transform:uppercase">Body Type</label>
                <select id="filter-body" class="filter-select" onchange="APP.filterMembers()">
                    <option value="">All Types</option>
                    <option value="slim">Slim</option>
                    <option value="athletic">Athletic</option>
                    <option value="average">Average</option>
                    <option value="curvy">Curvy</option>
                    <option value="muscular">Muscular</option>
                    <option value="bbw">BBW</option>
                </select>
            </div>
            
            <!-- Relationship Status -->
            <div>
                <label style="display:block;color:#aaa;font-size:12px;margin-bottom:6px;text-transform:uppercase">Status</label>
                <select id="filter-relationship" class="filter-select" onchange="APP.filterMembers()">
                    <option value="">All Status</option>
                    <option value="single">Single</option>
                    <option value="relationship">In Relationship</option>
                    <option value="married">Married</option>
                    <option value="complicated">It's Complicated</option>
                    <option value="open">Open Relationship</option>
                </select>
            </div>
            
            <!-- Looking For -->
            <div>
                <label style="display:block;color:#aaa;font-size:12px;margin-bottom:6px;text-transform:uppercase">Looking For</label>
                <select id="filter-looking" class="filter-select" onchange="APP.filterMembers()">
                    <option value="">All</option>
                    <option value="chat">Chat & Friends</option>
                    <option value="dating">Dating</option>
                    <option value="casual">Casual Fun</option>
                    <option value="relationship">Relationship</option>
                    <option value="kink">Kink Exploration</option>
                </select>
            </div>
            
        </div>
        
        <!-- Additional Filters -->
        <div style="display:flex;gap:15px;flex-wrap:wrap;margin-top:15px;padding-top:15px;border-top:1px solid #333">
            <label class="filter-checkbox">
                <input type="checkbox" id="filter-online" onchange="APP.filterMembers()">
                <span>üü¢ Online Now</span>
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" id="filter-verified" onchange="APP.filterMembers()">
                <span>‚úì Verified Only</span>
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" id="filter-photos" onchange="APP.filterMembers()">
                <span>üì∏ Has Photos</span>
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" id="filter-premium" onchange="APP.filterMembers()">
                <span>‚≠ê Premium Members</span>
            </label>
        </div>
        
        <!-- Clear Button -->
        <div style="margin-top:15px;padding-top:15px;border-top:1px solid #333;text-align:right">
            <button class="btn btn-secondary" onclick="APP.clearFilters()" style="padding:10px 24px">
                üóëÔ∏è Clear All Filters
            </button>
        </div>
    </div>
</div>

<div id="members-container"><div class="loading"><div class="spinner"></div><p>Loading members...</p></div></div>
</div>
<div id="view-messages" class="view" style="display:none">
<div class="page-header"><h1 class="page-title">Messages</h1></div>
<div class="messages-container">
<div class="conversations-sidebar">
<div class="conversations-header"><h3>Conversations</h3><input type="text" class="conversations-search" placeholder="Search conversations..."></div>
<div class="conversations-list" id="conversations-list"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div class="chat-area" id="chat-area"><div class="empty-state"><div class="empty-state-icon">üí¨</div><h3 class="empty-state-title">Select a conversation</h3><p class="empty-state-text">Choose someone to start chatting</p></div></div>
</div>
</div>
<div id="view-favorites" class="view" style="display:none">
<div class="page-header"><h1 class="page-title">‚≠ê My Favorites</h1><p class="page-subtitle">Members you've saved</p></div>
<div id="favorites-container"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="view-winks" class="view" style="display:none">
<div class="page-header"><h1 class="page-title">üòâ Winks Received</h1><p class="page-subtitle">People who winked at you</p></div>
<div id="winks-container"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="view-visitors" class="view" style="display:none">
<div class="page-header"><h1 class="page-title">üëÄ Profile Visitors</h1><p class="page-subtitle">See who's been checking you out</p></div>
<div id="visitors-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px">
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center"><div style="font-size:32px;font-weight:bold;color:var(--secondary)" id="stat-today">0</div><div style="color:#888;font-size:13px">Today</div></div>
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center"><div style="font-size:32px;font-weight:bold;color:var(--primary)" id="stat-week">0</div><div style="color:#888;font-size:13px">This Week</div></div>
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center"><div style="font-size:32px;font-weight:bold;color:#9b59b6" id="stat-total">0</div><div style="color:#888;font-size:13px">Total</div></div>
</div>
<div id="visitors-container"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="view-voice-messages" class="view" style="display:none">
<div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
<div><h1 class="page-title">üéôÔ∏è Sexy Voice Messages</h1><p class="page-subtitle">Share and listen to sexy voice messages</p></div>
<button class="btn btn-primary" onclick="APP.showRecordVoiceMessage()">üéôÔ∏è Record Message</button>
</div>

<!-- Voice Message Stats -->
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:25px">
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:var(--secondary)" id="vm-stat-mine">0</div>
<div style="color:#888;font-size:13px">My Messages</div>
</div>
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:var(--primary)" id="vm-stat-plays">0</div>
<div style="color:#888;font-size:13px">Total Plays</div>
</div>
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#9b59b6" id="vm-stat-likes">0</div>
<div style="color:#888;font-size:13px">Likes Received</div>
</div>
<div style="background:var(--darker);padding:20px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#ffd700" id="vm-stat-total">0</div>
<div style="color:#888;font-size:13px">Total Messages</div>
</div>
</div>

<!-- Filter Tabs -->
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn btn-secondary" id="vm-filter-all" onclick="APP.filterVoiceMessages('all')" style="background:var(--primary)">All Messages</button>
<button class="btn btn-secondary" id="vm-filter-mine" onclick="APP.filterVoiceMessages('mine')">My Messages</button>
<button class="btn btn-secondary" id="vm-filter-liked" onclick="APP.filterVoiceMessages('liked')">Liked</button>
<button class="btn btn-secondary" id="vm-filter-popular" onclick="APP.filterVoiceMessages('popular')">Most Popular</button>
</div>

<!-- Voice Messages Container -->
<div id="voice-messages-container">
<div class="loading"><div class="spinner"></div></div>
</div>
</div>
<div id="view-rooms" class="view" style="display:none">
<div class="page-header"><h1 class="page-title">üí¨ Chat Rooms</h1><p class="page-subtitle">Join conversations with like-minded people</p></div>
<div id="rooms-container"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="view-gallery" class="view" style="display:none">
<div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
<div><h1 class="page-title">üì∏ Photo Gallery</h1><p class="page-subtitle">Browse and share photos</p></div>
<button class="btn btn-primary" onclick="APP.showUploadPhoto()">üì§ Upload Photo</button>
</div>
<div id="gallery-categories" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px">
<div class="member-card" onclick="APP.openGallery('hotwife')" style="padding:25px;text-align:center"><div style="font-size:40px;margin-bottom:10px">üíç</div><div style="font-weight:600">My Hotwife</div><div style="color:#888;font-size:12px" id="count-hotwife">0 photos</div></div>
<div class="member-card" onclick="APP.openGallery('girlfriend')" style="padding:25px;text-align:center"><div style="font-size:40px;margin-bottom:10px">üíï</div><div style="font-weight:600">My Girlfriend</div><div style="color:#888;font-size:12px" id="count-girlfriend">0 photos</div></div>
<div class="member-card" onclick="APP.openGallery('couples')" style="padding:25px;text-align:center"><div style="font-size:40px;margin-bottom:10px">üë´</div><div style="font-weight:600">Couples</div><div style="color:#888;font-size:12px" id="count-couples">0 photos</div></div>
<div class="member-card" onclick="APP.openGallery('female')" style="padding:25px;text-align:center"><div style="font-size:40px;margin-bottom:10px">üë©</div><div style="font-weight:600">Single Female</div><div style="color:#888;font-size:12px" id="count-female">0 photos</div></div>
<div class="member-card" onclick="APP.openGallery('male')" style="padding:25px;text-align:center"><div style="font-size:40px;margin-bottom:10px">üë®</div><div style="font-weight:600">Single Male</div><div style="color:#888;font-size:12px" id="count-male">0 photos</div></div>
</div>
<div id="gallery-photos" style="display:none"><button class="btn btn-secondary" onclick="APP.backToGallery()" style="margin-bottom:20px">‚Üê Back</button><div id="gallery-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px"></div></div>
</div>
<div id="view-stories" class="view" style="display:none">
<div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
<div><h1 class="page-title">üìñ Stories</h1><p class="page-subtitle">Read and share stories</p></div>
<button class="btn btn-primary" onclick="APP.showWriteStory()">‚úçÔ∏è Write Story</button>
</div>
<div id="stories-container"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="view-hotornot" class="view" style="display:none">
<div class="page-header" style="text-align:center"><h1 class="page-title">üî• Hot or Not</h1><p class="page-subtitle">Rate members and find matches!</p></div>
<div style="max-width:400px;margin:0 auto;text-align:center">
<div style="display:flex;justify-content:center;gap:30px;margin:25px 0">
<div><div style="font-size:28px;font-weight:bold" id="hon-rated">0</div><div style="color:#888;font-size:12px">Rated</div></div>
<div><div style="font-size:28px;font-weight:bold;color:var(--primary)" id="hon-hot">0</div><div style="color:#888;font-size:12px">üî• Hot</div></div>
<div onclick="APP.showMatches()" style="cursor:pointer"><div style="font-size:28px;font-weight:bold;color:var(--secondary)" id="hon-matches">0</div><div style="color:#888;font-size:12px">üíï Matches</div></div>
</div>
<div id="hon-card-container" style="height:450px;position:relative;margin-bottom:25px"><div class="loading"><div class="spinner"></div></div></div>
<div style="display:flex;justify-content:center;gap:20px">
<button class="btn" onclick="APP.honVote('nope')" style="width:60px;height:60px;border-radius:50%;background:#e74c3c;font-size:24px">‚ùå</button>
<button class="btn" onclick="APP.honSkip()" style="width:50px;height:50px;border-radius:50%;background:#95a5a6;font-size:18px">‚è≠Ô∏è</button>
<button class="btn" onclick="APP.honVote('hot')" style="width:60px;height:60px;border-radius:50%;background:var(--primary);font-size:24px">üî•</button>
</div>
<p style="color:#666;font-size:12px;margin-top:15px">‚å®Ô∏è ‚Üê Nope ‚Ä¢ ‚Üì Skip ‚Ä¢ ‚Üí Hot</p>
</div>
</div>

<!-- Admin View -->
<div id="view-admin" class="view" style="display:none">
<div class="page-header">
<h1 class="page-title">‚öôÔ∏è Admin Dashboard</h1>
<p class="page-subtitle">Manage your platform</p>
</div>

<!-- Admin Tabs -->
<div class="admin-tabs">
<button class="admin-tab active" onclick="APP.showAdminTab('overview')">üìä Overview</button>
<button class="admin-tab" onclick="APP.showAdminTab('users')">üë• Users</button>
<button class="admin-tab" onclick="APP.showAdminTab('rooms')">üí¨ Chat Rooms</button>
<button class="admin-tab" onclick="APP.showAdminTab('content')">üóëÔ∏è Content</button>
<button class="admin-tab" onclick="APP.showAdminTab('payments')">üí∞ Payments</button>
<button class="admin-tab" onclick="APP.showAdminTab('reports')">üö© Reports</button>
<button class="admin-tab" onclick="APP.showAdminTab('settings')">‚öôÔ∏è Settings</button>
</div>

<!-- Overview Tab -->
<div id="admin-tab-overview" class="admin-tab-content">
<div class="admin-stats-grid">
<div class="admin-stat-card">
<div class="admin-stat-icon">üë•</div>
<div class="admin-stat-value" id="admin-total-users">0</div>
<div class="admin-stat-label">Total Users</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üü¢</div>
<div class="admin-stat-value" id="admin-online-users">0</div>
<div class="admin-stat-label">Online Now</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üí¨</div>
<div class="admin-stat-value" id="admin-total-messages">0</div>
<div class="admin-stat-label">Total Messages</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üìñ</div>
<div class="admin-stat-value" id="admin-total-stories">0</div>
<div class="admin-stat-label">Stories</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üì∏</div>
<div class="admin-stat-value" id="admin-total-photos">0</div>
<div class="admin-stat-label">Gallery Photos</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üö´</div>
<div class="admin-stat-value" id="admin-banned-users">0</div>
<div class="admin-stat-label">Banned Users</div>
</div>
</div>

<div class="admin-section">
<h3>Recent Activity</h3>
<div id="admin-recent-activity" style="background:var(--card);padding:20px;border-radius:12px">
<div class="loading"><div class="spinner"></div></div>
</div>
</div>
</div>

<!-- Users Tab -->
<div id="admin-tab-users" class="admin-tab-content" style="display:none">
<div class="admin-toolbar">
<button class="btn btn-primary" onclick="APP.showCreateUser()">‚ûï Create User</button>
<input type="text" id="admin-user-search" placeholder="üîç Search users..." class="admin-search" oninput="APP.searchAdminUsers()">
<select id="admin-user-filter" class="admin-filter" onchange="APP.filterAdminUsers()">
<option value="all">All Users</option>
<option value="online">Online</option>
<option value="banned">Banned</option>
<option value="premium">Premium</option>
<option value="new">New (Last 7 days)</option>
</select>
<button class="btn btn-secondary" onclick="APP.loadAdminUsers()">üîÑ Refresh</button>
</div>

<div id="admin-users-table-container">
<table class="admin-table">
<thead>
<tr>
<th>ID</th>
<th>Username</th>
<th>Email</th>
<th>Status</th>
<th>Type</th>
<th>Joined</th>
<th>Last Login</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="admin-users-table">
<tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr>
</tbody>
</table>
</div>
</div>

<!-- Chat Rooms Tab -->
<div id="admin-tab-rooms" class="admin-tab-content" style="display:none">
<div class="admin-toolbar">
<button class="btn btn-primary" onclick="APP.showCreateRoom()">‚ûï Create Room</button>
<button class="btn btn-secondary" onclick="APP.loadAdminRooms()">üîÑ Refresh</button>
</div>

<div id="admin-rooms-container">
<div class="loading"><div class="spinner"></div></div>
</div>
</div>

<!-- Content Moderation Tab -->
<div id="admin-tab-content" class="admin-tab-content" style="display:none">
<div class="admin-toolbar">
<select id="admin-content-type" class="admin-filter" onchange="APP.loadAdminContent()">
<option value="messages">Messages</option>
<option value="stories">Stories</option>
<option value="gallery">Gallery Photos</option>
<option value="profiles">Profiles</option>
</select>
<input type="text" id="admin-content-search" placeholder="üîç Search..." class="admin-search" oninput="APP.searchAdminContent()">
<button class="btn btn-secondary" onclick="APP.loadAdminContent()">üîÑ Refresh</button>
</div>

<div id="admin-content-container">
<div class="loading"><div class="spinner"></div></div>
</div>
</div>

<!-- Payments Tab -->
<div id="admin-tab-payments" class="admin-tab-content" style="display:none">
<div class="admin-toolbar">
<h3 style="color:#fff;margin:0">üí∞ Payment Transactions</h3>
<button class="btn btn-secondary" onclick="APP.loadAdminPayments()">üîÑ Refresh</button>
</div>

<div id="admin-payments-container">
<div class="loading"><div class="spinner"></div></div>
</div>

<div style="margin-top:30px;padding:20px;background:var(--card);border-radius:12px">
<h3 style="color:var(--secondary);margin-bottom:20px">Revenue Summary</h3>
<div class="admin-stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
<div class="admin-stat-card">
<div class="admin-stat-icon">üíµ</div>
<div class="admin-stat-value" id="admin-total-revenue">$0</div>
<div class="admin-stat-label">Total Revenue</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üìÖ</div>
<div class="admin-stat-value" id="admin-monthly-revenue">$0</div>
<div class="admin-stat-label">This Month</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üë•</div>
<div class="admin-stat-value" id="admin-paying-users">0</div>
<div class="admin-stat-label">Paying Users</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üÜì</div>
<div class="admin-stat-value" id="admin-free-count">0</div>
<div class="admin-stat-label">Free Members</div>
</div>
<div class="admin-stat-card">
<div class="admin-stat-icon">üíé</div>
<div class="admin-stat-value" id="admin-premium-count">0</div>
<div class="admin-stat-label">Premium Members</div>
</div>
</div>
</div>
</div>

<!-- Reports Tab -->
<div id="admin-tab-reports" class="admin-tab-content" style="display:none">
<div class="admin-toolbar">
<select id="admin-report-filter" class="admin-filter" onchange="APP.loadAdminReports()">
<option value="pending">Pending</option>
<option value="all">All Reports</option>
<option value="resolved">Resolved</option>
</select>
<button class="btn btn-secondary" onclick="APP.loadAdminReports()">üîÑ Refresh</button>
</div>

<div id="admin-reports-container">
<p style="text-align:center;color:#666;padding:40px">Report system coming soon...</p>
</div>
</div>

<!-- Settings Tab -->
<div id="admin-tab-settings" class="admin-tab-content" style="display:none">
<div class="admin-settings-grid">
<div class="admin-setting-card">
<h3>Platform Settings</h3>
<div class="admin-setting-item">
<label>Site Name</label>
<input type="text" value="KinknTease" class="admin-input">
</div>
<div class="admin-setting-item">
<label>Registration</label>
<select class="admin-input">
<option value="open">Open</option>
<option value="approval">Requires Approval</option>
<option value="closed">Closed</option>
</select>
</div>
<div class="admin-setting-item">
<label>Maintenance Mode</label>
<label class="admin-toggle">
<input type="checkbox">
<span class="admin-toggle-slider"></span>
</label>
</div>
</div>

<div class="admin-setting-card">
<h3>Content Settings</h3>
<div class="admin-setting-item">
<label>Auto-moderate Content</label>
<label class="admin-toggle">
<input type="checkbox">
<span class="admin-toggle-slider"></span>
</label>
</div>
<div class="admin-setting-item">
<label>Max Photos per User</label>
<input type="number" value="12" class="admin-input">
</div>
<div class="admin-setting-item">
<label>Max Voice Recordings</label>
<input type="number" value="5" class="admin-input">
</div>
</div>

<div class="admin-setting-card">
<h3>Security</h3>
<div class="admin-setting-item">
<label>Require Email Verification</label>
<label class="admin-toggle">
<input type="checkbox">
<span class="admin-toggle-slider"></span>
</label>
</div>
<div class="admin-setting-item">
<label>Enable 2FA</label>
<label class="admin-toggle">
<input type="checkbox">
<span class="admin-toggle-slider"></span>
</label>
</div>
</div>
</div>

<button class="btn btn-primary" style="margin-top:20px">üíæ Save Settings</button>
</div>
</div>

</main>
</div>
</div>

<!-- Age Verification Modal -->
<div id="modal-age" class="modal">
<div class="modal-content" style="text-align:center;padding:40px;max-width:600px">
<div style="font-size:70px;margin-bottom:15px">üîû</div>
<h2 style="color:var(--primary);margin-bottom:12px">Adults Only (18+)</h2>
<p style="color:#888;margin-bottom:25px;line-height:1.6">This website contains adult content. By entering, you confirm you are 18 or older and agree to our terms and policies.</p>
<div style="display:flex;gap:12px;justify-content:center;margin-bottom:25px">
<button class="btn btn-primary" style="padding:14px 35px;font-size:16px" onclick="APP.confirmAge()">I am 18+ Enter</button>
<button class="btn btn-secondary" style="padding:14px 35px" onclick="APP.exitSite()">Exit</button>
</div>

<!-- Legal Links -->
<div style="display:flex;gap:20px;justify-content:center;padding-top:20px;border-top:1px solid #333;font-size:13px">
<a href="#" onclick="APP.showLegalModal('terms'); return false;" style="color:#aaa;text-decoration:none;transition:color 0.2s">
üìÑ Terms of Service
</a>
<a href="#" onclick="APP.showLegalModal('privacy'); return false;" style="color:#aaa;text-decoration:none;transition:color 0.2s">
üîí Privacy Policy
</a>
<a href="#" onclick="APP.showLegalModal('disclaimer'); return false;" style="color:#aaa;text-decoration:none;transition:color 0.2s">
‚ö†Ô∏è Disclaimer
</a>
</div>
</div>
</div>

<!-- Login Modal -->
<div id="modal-login" class="modal">
<div class="modal-content">
<button class="modal-close" onclick="APP.closeModal('login')">√ó</button>
<div class="modal-header"><h2 class="modal-title">Welcome Back</h2><p class="modal-subtitle">Login to your account</p></div>
<div class="modal-body">
<div id="login-error" class="error-box" style="display:none"></div>
<form id="login-form" onsubmit="return APP.login(event)">
<div class="form-group">
<label>Username or Email Address</label>
<input type="text" id="login-username" required placeholder="Enter your username OR email">
<p style="color:#888;font-size:12px;margin:5px 0 0 0">üí° You can use either your username or email to login</p>
</div>
<div class="form-group"><label>Password</label><input type="password" id="login-password" required placeholder="Enter your password"></div>
<button type="submit" class="btn btn-primary" style="width:100%;padding:14px">Login</button>
</form>
<p style="text-align:center;margin-top:18px;color:#888;font-size:13px">Don't have an account? <a href="#" onclick="APP.closeModal('login');APP.showModal('register')">Register Free</a></p>
</div>
</div>
</div>

<!-- Register Modal -->
<div id="modal-register" class="modal">
<div class="modal-content">
<button class="modal-close" onclick="APP.closeModal('register')">√ó</button>
<div class="modal-header"><h2 class="modal-title">Join Kinkntease</h2><p class="modal-subtitle">Create your free account</p></div>
<div class="modal-body">
<div id="register-error" class="error-box" style="display:none"></div>
<div id="register-success" class="success-box" style="display:none"></div>
<form id="register-form" onsubmit="return APP.register(event)">
<div class="form-group"><label>Username *</label><input type="text" id="reg-username" required placeholder="Choose username" minlength="3" maxlength="20"></div>
<div class="form-group"><label>Email *</label><input type="email" id="reg-email" required placeholder="Your email"></div>
<div class="form-group"><label>Password *</label><input type="password" id="reg-password" required placeholder="Min 6 characters" minlength="6"></div>
<div class="form-row">
<div class="form-group"><label>Date of Birth *</label><input type="date" id="reg-dob" required></div>
<div class="form-group"><label>Gender</label><select id="reg-gender"><option value="">Select...</option><option value="male">Male</option><option value="female">Female</option><option value="couple">Couple</option><option value="other">Other</option></select></div>
</div>
<p style="color:#666;font-size:11px;margin-bottom:15px">By registering, you confirm you are 18+ and agree to our Terms.</p>
<button type="submit" class="btn btn-primary" style="width:100%;padding:14px">Create Account</button>
</form>
<p style="text-align:center;margin-top:18px;color:#888;font-size:13px">Already have an account? <a href="#" onclick="APP.closeModal('register');APP.showModal('login')">Login</a></p>
</div>
</div>
</div>

<!-- Profile Modal -->
<div id="modal-profile" class="modal">
<div class="modal-content medium">
<button class="modal-close" onclick="APP.closeModal('profile')">√ó</button>
<div id="profile-content"><div class="loading"><div class="spinner"></div></div></div>
</div>
</div>

<!-- Edit Profile Modal -->
<div id="modal-edit-profile" class="modal">
<div class="modal-content large">
<button class="modal-close" onclick="APP.closeModal('edit-profile')">√ó</button>
<div class="modal-header">
<h2 class="modal-title">‚úèÔ∏è Edit Your Profile</h2>
<p class="modal-subtitle">Make your profile stand out</p>
</div>
<div class="modal-body">
<div id="edit-profile-error" class="error-box" style="display:none"></div>
<div id="edit-profile-success" class="success-box" style="display:none"></div>

<form id="edit-profile-form" onsubmit="return APP.saveProfile(event)">

<!-- Photo Manager -->
<div class="section-header">üì∏ Profile Photos</div>
<div class="photo-manager">
<div class="current-photos" id="profile-photo-slots">
<!-- Dynamic photo slots -->
</div>
<input type="file" id="profile-photo-input" accept="image/*" style="display:none" onchange="APP.handleProfilePhotoSelect(event)">
<button type="button" class="btn btn-secondary" onclick="document.getElementById('profile-photo-input').click()">
üì§ Add Photo
</button>
<p style="font-size:11px;color:#666;margin-top:8px">Add up to 12 photos. Click star to set as primary.</p>
</div>

<!-- Voice Recordings Manager -->
<div class="section-header">üéôÔ∏è Voice Recordings</div>
<div class="photo-manager">
<div id="profile-voice-recordings-list" style="display:flex;flex-direction:column;gap:10px;margin-bottom:15px">
<!-- Dynamic voice recordings -->
</div>
<div style="display:flex;gap:10px;align-items:center">
<input type="text" id="voice-recording-title" placeholder="Recording title (optional)" style="flex:1;padding:10px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
<button type="button" class="btn btn-secondary" onclick="APP.startProfileVoiceRecording()" id="record-voice-btn">
üéôÔ∏è Record
</button>
</div>
<p style="font-size:11px;color:#666;margin-top:8px">Record up to 5 voice intros (max 2 min each). Great for sharing your personality!</p>
<!-- Voice Recorder UI -->
<div id="profile-voice-recorder" style="display:none;background:var(--darker);padding:20px;border-radius:12px;margin-top:15px">
<div style="text-align:center">
<div class="recording-indicator" style="font-size:48px">üéôÔ∏è</div>
<div class="recording-time" id="profile-recording-time" style="font-size:24px;font-weight:bold;color:#fff;margin:10px 0">00:00</div>
<div style="display:flex;gap:10px;justify-content:center">
<button type="button" class="btn btn-danger" onclick="APP.cancelProfileVoiceRecording()">Cancel</button>
<button type="button" class="btn btn-primary" onclick="APP.stopProfileVoiceRecording()">‚úì Save</button>
</div>
</div>
</div>
</div>

<!-- Basic Info -->
<div class="section-header">üë§ Basic Information</div>
<div class="form-row">
<div class="form-group">
<label>Display Name *</label>
<input type="text" id="edit-display-name" required placeholder="How should others see you?">
</div>
<div class="form-group">
<label>Tagline</label>
<input type="text" id="edit-tagline" placeholder="A short catchy phrase..." maxlength="100">
</div>
</div>

<div class="form-group">
<label>About Me *</label>
<textarea id="edit-about-me" required placeholder="Tell people about yourself..." minlength="50" style="min-height:120px"></textarea>
<div style="font-size:11px;color:#666;margin-top:5px">Minimum 50 characters - be descriptive!</div>
</div>

<div class="form-row">
<div class="form-group">
<label>Gender</label>
<select id="edit-gender">
<option value="">Prefer not to say</option>
<option value="male">Male</option>
<option value="female">Female</option>
<option value="couple">Couple</option>
<option value="trans-male">Trans Male</option>
<option value="trans-female">Trans Female</option>
<option value="non-binary">Non-Binary</option>
<option value="other">Other</option>
</select>
</div>
<div class="form-group">
<label>Sexual Orientation</label>
<select id="edit-orientation">
<option value="">Prefer not to say</option>
<option value="straight">Straight</option>
<option value="gay">Gay</option>
<option value="lesbian">Lesbian</option>
<option value="bisexual">Bisexual</option>
<option value="pansexual">Pansexual</option>
<option value="curious">Curious</option>
<option value="open">Open to anything</option>
</select>
</div>
</div>

<!-- Location -->
<div class="section-header">üìç Location</div>
<div class="form-row">
<div class="form-group">
<label>Country</label>
<input type="text" id="edit-country" placeholder="e.g., Australia">
</div>
<div class="form-group">
<label>City/State</label>
<input type="text" id="edit-city" placeholder="e.g., Perth, WA">
</div>
</div>

<!-- Physical Attributes -->
<div class="section-header">üí™ Physical Attributes</div>
<div class="form-row">
<div class="form-group">
<label>Body Type</label>
<select id="edit-body-type">
<option value="">Prefer not to say</option>
<option value="slim">Slim</option>
<option value="athletic">Athletic</option>
<option value="average">Average</option>
<option value="curvy">Curvy</option>
<option value="full">Full Figured</option>
<option value="muscular">Muscular</option>
</select>
</div>
<div class="form-group">
<label>Height</label>
<input type="text" id="edit-height" placeholder="e.g., 175cm or 5'9''">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label>Hair Color</label>
<select id="edit-hair-color">
<option value="">Prefer not to say</option>
<option value="blonde">Blonde</option>
<option value="brunette">Brunette</option>
<option value="black">Black</option>
<option value="red">Red</option>
<option value="grey">Grey/Silver</option>
<option value="other">Other</option>
</select>
</div>
<div class="form-group">
<label>Eye Color</label>
<select id="edit-eye-color">
<option value="">Prefer not to say</option>
<option value="blue">Blue</option>
<option value="brown">Brown</option>
<option value="green">Green</option>
<option value="hazel">Hazel</option>
<option value="grey">Grey</option>
</select>
</div>
</div>

<!-- Lifestyle -->
<div class="section-header">üéØ Lifestyle & Interests</div>
<div class="form-row">
<div class="form-group">
<label>Relationship Status</label>
<select id="edit-relationship-status">
<option value="">Prefer not to say</option>
<option value="single">Single</option>
<option value="attached">Attached</option>
<option value="married">Married</option>
<option value="open-relationship">Open Relationship</option>
<option value="its-complicated">It's Complicated</option>
</select>
</div>
<div class="form-group">
<label>Smoker</label>
<select id="edit-smoker">
<option value="">Prefer not to say</option>
<option value="non-smoker">Non-Smoker</option>
<option value="social">Social Smoker</option>
<option value="regular">Regular Smoker</option>
</select>
</div>
</div>

<div class="form-row">
<div class="form-group">
<label>Drinker</label>
<select id="edit-drinker">
<option value="">Prefer not to say</option>
<option value="non-drinker">Non-Drinker</option>
<option value="social">Social Drinker</option>
<option value="regular">Regular Drinker</option>
</select>
</div>
<div class="form-group">
<label>Occupation</label>
<input type="text" id="edit-occupation" placeholder="Your profession">
</div>
</div>

<!-- What I'm Looking For -->
<div class="section-header">üîç What I'm Looking For</div>
<div class="form-group">
<label>Looking For</label>
<div class="checkbox-group">
<div class="checkbox-item">
<input type="checkbox" id="looking-friendship" value="friendship">
<label for="looking-friendship">Friendship</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="looking-fun" value="fun">
<label for="looking-fun">Fun & Adventure</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="looking-dating" value="dating">
<label for="looking-dating">Dating</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="looking-relationship" value="relationship">
<label for="looking-relationship">Relationship</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="looking-couples" value="couples">
<label for="looking-couples">Couples</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="looking-groups" value="groups">
<label for="looking-groups">Groups</label>
</div>
</div>
</div>

<div class="form-group">
<label>Age Preference (Looking for)</label>
<div class="form-row">
<input type="number" id="edit-age-pref-min" placeholder="Min" min="18" max="99" style="width:100%">
<input type="number" id="edit-age-pref-max" placeholder="Max" min="18" max="99" style="width:100%">
</div>
</div>

<!-- Interests -->
<div class="section-header">‚ù§Ô∏è Interests & Kinks</div>
<div class="form-group">
<label>Interests (comma separated)</label>
<input type="text" id="edit-interests" placeholder="e.g., travel, fitness, wine, adventure, photography...">
</div>

<div class="form-group">
<label>Kinks & Preferences (comma separated - optional)</label>
<input type="text" id="edit-kinks" placeholder="e.g., roleplay, outdoor, toys...">
<div style="font-size:11px;color:#666;margin-top:5px">Be honest about what you enjoy</div>
</div>

<!-- Privacy Settings -->
<div class="section-header">üîí Privacy Settings</div>
<div class="checkbox-group">
<div class="checkbox-item">
<input type="checkbox" id="privacy-show-age">
<label for="privacy-show-age">Show my age on profile</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="privacy-show-location">
<label for="privacy-show-location">Show my location</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="privacy-show-online">
<label for="privacy-show-online">Show when I'm online</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="privacy-profile-visitors">
<label for="privacy-profile-visitors">Allow profile visitor tracking</label>
</div>
</div>

<div style="margin-top:25px;padding-top:25px;border-top:1px solid #333;display:flex;gap:12px">
<button type="submit" class="btn btn-primary" style="flex:1">üíæ Save Changes</button>
<button type="button" class="btn btn-secondary" onclick="APP.closeModal('edit-profile')">Cancel</button>
</div>

</form>
</div>
</div>
</div>

<!-- Write Story Modal -->
<div id="modal-write-story" class="modal">
<div class="modal-content medium">
<button class="modal-close" onclick="APP.closeModal('write-story')">√ó</button>
<div class="modal-header"><h2 class="modal-title">‚úçÔ∏è Write Your Story</h2><p class="modal-subtitle">Share your experience</p></div>
<div class="modal-body">
<div id="story-error" class="error-box" style="display:none"></div>
<div id="story-success" class="success-box" style="display:none"></div>
<form id="story-form" onsubmit="return APP.submitStory(event)">
<div class="form-group">
<label>Story Title *</label>
<input type="text" id="story-title" required placeholder="Give your story a catchy title" maxlength="100">
</div>
<div class="form-group">
<label>Category *</label>
<select id="story-category" required>
<option value="">Select category...</option>
<option value="fantasy">Fantasy</option>
<option value="true">True Story</option>
<option value="confession">Confession</option>
<option value="experience">Experience</option>
<option value="fiction">Fiction</option>
</select>
</div>
<div class="form-group">
<label>Tags (comma separated)</label>
<input type="text" id="story-tags" placeholder="e.g. hotwife, couples, adventure">
</div>
<div class="form-group">
<label>Your Story *</label>
<textarea id="story-content" required placeholder="Write your story here..." minlength="100" style="min-height:250px"></textarea>
<div style="color:#666;font-size:11px;margin-top:5px">Minimum 100 characters</div>
</div>
<button type="submit" class="btn btn-primary" style="width:100%;padding:14px">üìñ Publish Story</button>
</form>
</div>
</div>
</div>

<!-- Read Story Modal -->
<div id="modal-read-story" class="modal">
<div class="modal-content medium">
<button class="modal-close" onclick="APP.closeModal('read-story')">√ó</button>
<div id="story-read-content"></div>
</div>
</div>

<!-- Upload Photo Modal -->
<div id="modal-upload-photo" class="modal">
<div class="modal-content medium">
<button class="modal-close" onclick="APP.closeModal('upload-photo')">√ó</button>
<div class="modal-header"><h2 class="modal-title">üì§ Upload Photo</h2><p class="modal-subtitle">Share your photos with the community</p></div>
<div class="modal-body">
<div id="upload-error" class="error-box" style="display:none"></div>
<div id="upload-success" class="success-box" style="display:none"></div>
<form id="upload-form" onsubmit="return APP.submitPhoto(event)">
<div class="form-group">
<label>Category *</label>
<select id="upload-category" required>
<option value="">Select category...</option>
<option value="hotwife">My Hotwife</option>
<option value="girlfriend">My Girlfriend</option>
<option value="couples">Couples</option>
<option value="female">Single Female</option>
<option value="male">Single Male</option>
</select>
</div>
<div class="form-group">
<label>Photo *</label>
<div class="photo-upload-area" id="photo-drop-zone" onclick="document.getElementById('photo-file').click()">
<div style="font-size:50px;margin-bottom:10px">üì∏</div>
<div style="font-size:14px;color:#aaa;margin-bottom:8px">Click to select or drag & drop</div>
<div style="font-size:12px;color:#666">JPG, PNG, GIF up to 10MB</div>
<input type="file" id="photo-file" accept="image/*" style="display:none" onchange="APP.handlePhotoSelect(event)" required>
</div>
<div id="photo-preview" style="display:none;margin-top:15px">
<img id="preview-image" style="max-width:100%;border-radius:10px">
</div>
</div>
<div class="form-group">
<label>Caption (optional)</label>
<textarea id="photo-caption" placeholder="Add a caption..." style="min-height:80px"></textarea>
</div>
<button type="submit" class="btn btn-primary" style="width:100%;padding:14px">üì§ Upload Photo</button>
</form>
</div>
</div>
</div>

<!-- Chat Room Modal -->
<div id="modal-chat-room" class="modal">
<div class="modal-content large">
<button class="modal-close" onclick="APP.leaveChatRoom()">√ó</button>
<div id="room-chat-container" style="display:flex;flex-direction:column;height:80vh">
<div id="room-header" style="padding:20px;border-bottom:1px solid #333;text-align:center">
<h2 id="room-title" style="color:var(--primary);margin-bottom:5px"></h2>
<div id="room-user-count" style="color:#888;font-size:13px"></div>
</div>
<div id="room-messages" style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px"></div>
<div style="padding:15px;border-top:1px solid #333;position:relative">
<!-- Emoji Picker for Room -->
<div class="emoji-picker" id="emoji-picker-room"></div>
<!-- Voice Recorder for Room -->
<div class="voice-recorder" id="voice-recorder-room">
<div class="recording-indicator">üéôÔ∏è</div>
<div class="recording-time" id="recording-time-room">00:00</div>
<div class="recording-controls">
<button class="btn btn-danger" onclick="APP.cancelVoiceRecording()">Cancel</button>
<button class="btn btn-primary" onclick="APP.stopVoiceRecording()">‚úì Send</button>
</div>
</div>
<form id="room-message-form" onsubmit="return APP.sendRoomMessage(event)" style="display:flex;gap:10px;align-items:center">
<input type="file" id="room-photo-input" accept="image/*" style="display:none" onchange="APP.sendPhoto(event, 'room')">
<button type="button" class="chat-input-btn" onclick="document.getElementById('room-photo-input').click()" title="Send photo">üì∑</button>
<button type="button" class="chat-input-btn" onclick="APP.toggleEmojiPicker('room')" title="Emojis">üòä</button>
<button type="button" class="chat-input-btn" onclick="APP.startVoiceRecording('room')" title="Voice message">üéôÔ∏è</button>
<input type="text" id="room-message-input" placeholder="Type a message..." style="flex:1;padding:12px 18px;background:var(--card);border:1px solid #333;border-radius:25px;color:#fff;font-size:14px" autocomplete="off">
<button type="submit" class="chat-send-btn">‚û§</button>
</form>
</div>
</div>
</div>
</div>

<!-- Video Call Modal -->
<div class="video-call-modal" id="video-call-modal">
<div class="video-container">
<video id="video-remote" class="video-main" autoplay playsinline></video>
<video id="video-self" class="video-self" autoplay playsinline muted></video>
<div class="video-controls">
<button class="video-control-btn" onclick="APP.toggleVideo()" id="video-toggle" title="Toggle camera">üìπ</button>
<button class="video-control-btn" onclick="APP.toggleAudio()" id="audio-toggle" title="Toggle microphone">üé§</button>
<button class="video-control-btn danger" onclick="APP.endVideoCall()" title="End call">üìû</button>
</div>
<div style="position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:20px;color:#fff">
<span id="call-status">Connecting...</span>
</div>
</div>
</div>

<!-- Membership Plans Modal -->
<div id="modal-membership" class="modal">
<div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto">
<button class="modal-close" onclick="APP.closeModal('membership')">√ó</button>
<h2 style="color:var(--primary);margin-bottom:10px;text-align:center">üíé Upgrade Your Membership</h2>
<p style="text-align:center;color:#aaa;margin-bottom:25px">Unlock premium features and enhance your experience</p>

<div class="membership-plans">
<!-- Free Plan -->
<div class="membership-plan">
<div class="plan-badge">Current</div>
<div class="plan-icon">üÜì</div>
<div class="plan-name">Free</div>
<div class="plan-price">$0<span>/month</span></div>
<div class="plan-features">
<div class="plan-feature">‚úì Basic profile</div>
<div class="plan-feature">‚úì 5 messages/day</div>
<div class="plan-feature">‚úì View profiles</div>
<div class="plan-feature">‚úì Join chat rooms</div>
<div class="plan-feature">‚úì Upload photos</div>
</div>
<button class="btn btn-secondary" disabled style="margin-top:15px">Current Plan</button>
</div>

<!-- Premium Monthly Plan -->
<div class="membership-plan premium">
<div class="plan-icon">üíé</div>
<div class="plan-name">Premium</div>
<div class="plan-price">$9.99<span>/month</span></div>
<div class="plan-features">
<div class="plan-feature">‚úì <strong>Unlimited messages</strong></div>
<div class="plan-feature">‚úì See who viewed you</div>
<div class="plan-feature">‚úì VIP badge & boost</div>
<div class="plan-feature">‚úì No ads</div>
<div class="plan-feature">‚úì Priority support</div>
<div class="plan-feature">‚úì + 7 more features</div>
</div>
<div id="paypal-premium-monthly" class="paypal-button-container" style="margin-top:15px"></div>
</div>

<!-- Premium Yearly Plan -->
<div class="membership-plan premium">
<div class="plan-badge premium">üí∞ Save $20!</div>
<div class="plan-icon">üíé</div>
<div class="plan-name">Premium Annual</div>
<div class="plan-price">$99<span>/year</span></div>
<div class="plan-savings" style="color:var(--secondary);font-size:12px;font-weight:600;margin:-8px 0 12px">Save $20.88 vs monthly!</div>
<div class="plan-features">
<div class="plan-feature">‚úì <strong>Everything in Premium</strong></div>
<div class="plan-feature">‚úì Unlimited messages</div>
<div class="plan-feature">‚úì See who viewed you</div>
<div class="plan-feature">‚úì VIP badge & boost</div>
<div class="plan-feature">‚úì No ads</div>
<div class="plan-feature" style="color:var(--secondary);font-weight:bold">‚≠ê Best Value!</div>
</div>
<div id="paypal-premium-yearly" class="paypal-button-container" style="margin-top:15px"></div>
</div>
</div>

<div style="text-align:center;margin-top:20px;padding:15px;background:rgba(78,204,163,0.1);border-radius:12px">
<p style="color:#aaa;font-size:12px;margin-bottom:8px">üîí Secure payment powered by PayPal</p>
<p style="color:#666;font-size:11px">Cancel anytime ‚Ä¢ No hidden fees ‚Ä¢ Instant activation</p>
</div>
</div>
</div>

<!-- Record Voice Message Modal -->
<div id="modal-record-voice" class="modal">
<div class="modal-content" style="max-width:600px">
<div class="modal-header">
<h2>üéôÔ∏è Record Sexy Voice Message</h2>
<button class="modal-close" onclick="APP.closeModal('record-voice')">&times;</button>
</div>
<div class="modal-body">
<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Title</label>
<input type="text" id="vm-title" placeholder="Give your message a sexy title..." style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
</div>

<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Description (Optional)</label>
<textarea id="vm-description" placeholder="Describe what's in your message..." style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff;min-height:80px;resize:vertical"></textarea>
</div>

<div style="margin-bottom:20px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="vm-public" checked>
<span>Make this message public (others can listen)</span>
</label>
</div>

<!-- Recorder UI -->
<div id="vm-recorder-ui" style="background:var(--darker);padding:30px;border-radius:12px;text-align:center">
<div id="vm-recorder-ready">
<div style="font-size:80px;margin-bottom:20px">üéôÔ∏è</div>
<p style="color:#aaa;margin-bottom:20px">Click record to start your sexy voice message</p>
<p style="color:#666;font-size:13px;margin-bottom:20px">Maximum 2 minutes ‚Ä¢ High quality audio</p>
<button class="btn btn-primary" onclick="APP.startVMRecording()" style="padding:15px 40px;font-size:18px">üî¥ Start Recording</button>
</div>

<div id="vm-recorder-recording" style="display:none">
<div style="font-size:80px;margin-bottom:20px;animation:pulse 1.5s ease-in-out infinite">üî¥</div>
<div style="font-size:32px;font-weight:bold;color:var(--primary);margin-bottom:10px" id="vm-recording-time">00:00</div>
<p style="color:#aaa;margin-bottom:20px">Recording... Speak your mind!</p>
<div style="display:flex;gap:15px;justify-content:center">
<button class="btn btn-danger" onclick="APP.cancelVMRecording()">‚ùå Cancel</button>
<button class="btn btn-primary" onclick="APP.stopVMRecording()">‚èπÔ∏è Stop & Save</button>
</div>
</div>

<div id="vm-recorder-preview" style="display:none">
<div style="font-size:80px;margin-bottom:20px">‚úÖ</div>
<div style="font-size:24px;font-weight:bold;margin-bottom:10px" id="vm-preview-duration">00:00</div>
<audio id="vm-preview-player" controls style="width:100%;margin-bottom:20px"></audio>
<p style="color:#aaa;margin-bottom:20px">Listen to your message before posting</p>
<div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap">
<button class="btn btn-secondary" onclick="APP.retryVMRecording()">üîÑ Re-record</button>
<button class="btn btn-primary" onclick="APP.uploadVoiceMessage()" id="vm-upload-btn">üì§ Post Message</button>
</div>
</div>

<div id="vm-recorder-uploading" style="display:none">
<div style="font-size:80px;margin-bottom:20px">‚è≥</div>
<p style="color:#aaa;margin-bottom:20px">Uploading your sexy message...</p>
<div class="loading"><div class="spinner"></div></div>
</div>
</div>
</div>
</div>
</div>

<!-- Blocked Users Modal -->
<div id="modal-blocked-users" class="modal">
<div class="modal-content" style="max-width:700px">
<div class="modal-header">
<h2>üö´ Blocked Users</h2>
<button class="modal-close" onclick="APP.closeModal('blocked-users')">&times;</button>
</div>
<div class="modal-body">
<p style="color:#aaa;margin-bottom:20px">Blocked users cannot message you, view your profile, or interact with your content.</p>
<div id="blocked-users-list">
<div class="loading"><div class="spinner"></div></div>
</div>
</div>
</div>
</div>

<!-- Notifications Modal -->
<div id="modal-notifications" class="modal">
<div class="modal-content" style="max-width:700px;max-height:85vh">
<div class="modal-header">
<h2>üîî Notifications</h2>
<button class="modal-close" onclick="APP.closeModal('notifications')">&times;</button>
</div>
<div class="modal-body" style="max-height:calc(85vh - 80px);overflow-y:auto">
<div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid #333;padding-bottom:10px">
<button class="btn btn-sm" id="notif-filter-all" onclick="APP.filterNotifications('all')" style="flex:1">All</button>
<button class="btn btn-sm" id="notif-filter-messages" onclick="APP.filterNotifications('messages')" style="flex:1">üí¨ Messages</button>
<button class="btn btn-sm" id="notif-filter-views" onclick="APP.filterNotifications('views')" style="flex:1">üëÅÔ∏è Views</button>
<button class="btn btn-sm" id="notif-filter-social" onclick="APP.filterNotifications('social')" style="flex:1">‚ù§Ô∏è Social</button>
</div>
<div id="notifications-list"></div>
<div id="notifications-empty" style="display:none;text-align:center;padding:40px;color:#666">
<div style="font-size:48px;margin-bottom:15px">üîî</div>
<h3 style="margin-bottom:8px">No notifications yet</h3>
<p>You'll see notifications here when people interact with you</p>
</div>
</div>
</div>
</div>

<!-- Admin Create User Modal -->
<div id="modal-create-user" class="modal">
<div class="modal-content" style="max-width:600px">
<div class="modal-header">
<h2>‚ûï Create New User</h2>
<button class="modal-close" onclick="APP.closeModal('create-user')">&times;</button>
</div>
<div class="modal-body">
<form id="create-user-form" onsubmit="return APP.createUserSubmit(event)">
<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Username *</label>
<input type="text" id="cu-username" required placeholder="Enter username" style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
</div>

<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Email *</label>
<input type="email" id="cu-email" required placeholder="user@example.com" style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
</div>

<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Password *</label>
<input type="password" id="cu-password" required placeholder="Minimum 6 characters" minlength="6" style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
</div>

<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Gender</label>
<select id="cu-gender" style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
<option value="">Select gender (optional)</option>
<option value="male">Male</option>
<option value="female">Female</option>
<option value="couple">Couple</option>
<option value="other">Other</option>
</select>
</div>

<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;font-weight:600">Date of Birth</label>
<input type="date" id="cu-dob" style="width:100%;padding:12px;background:var(--card);border:1px solid #333;border-radius:8px;color:#fff">
</div>

<div style="margin-bottom:20px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="cu-premium">
<span>Grant Premium membership</span>
</label>
</div>

<div style="margin-bottom:20px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="cu-admin">
<span>Make admin</span>
</label>
</div>

<div style="display:flex;gap:10px;justify-content:flex-end">
<button type="button" class="btn btn-secondary" onclick="APP.closeModal('create-user')">Cancel</button>
<button type="submit" class="btn btn-primary">‚ûï Create User</button>
</div>
</form>
</div>
</div>
</div>

<!-- Terms of Service Modal -->
<div id="modal-terms" class="modal">
<div class="modal-content" style="max-width:800px;max-height:85vh">
<div class="modal-header">
<h2>üìÑ Terms of Service</h2>
<button class="modal-close" onclick="APP.closeModal('terms')">&times;</button>
</div>
<div class="modal-body" style="max-height:calc(85vh - 80px);overflow-y:auto;padding:30px;line-height:1.8">

<h3 style="color:var(--primary);margin-top:0">1. Acceptance of Terms</h3>
<p style="color:#aaa;margin-bottom:20px">
By accessing and using Kink N Tease ("the Site"), you accept and agree to be bound by the terms and provision of this agreement. If you do not agree to these Terms of Service, please do not use the Site.
</p>

<h3 style="color:var(--primary)">2. Age Restriction</h3>
<p style="color:#aaa;margin-bottom:20px">
You must be at least 18 years of age to access or use the Site. By using the Site, you represent and warrant that you are 18 years of age or older. We reserve the right to request proof of age at any time.
</p>

<h3 style="color:var(--primary)">3. User Conduct</h3>
<p style="color:#aaa;margin-bottom:10px">You agree NOT to:</p>
<ul style="color:#aaa;margin-bottom:20px;padding-left:25px">
<li>Post content that is illegal, harmful, threatening, abusive, harassing, defamatory, vulgar, obscene, or otherwise objectionable</li>
<li>Impersonate any person or entity or falsely state or misrepresent your affiliation with a person or entity</li>
<li>Post content that infringes any patent, trademark, trade secret, copyright, or other proprietary rights</li>
<li>Use the Site for any illegal or unauthorized purpose</li>
<li>Harass, abuse, or harm another person</li>
<li>Share contact information publicly that could lead to off-platform contact without consent</li>
</ul>

<h3 style="color:var(--primary)">4. Account Security</h3>
<p style="color:#aaa;margin-bottom:20px">
You are responsible for maintaining the confidentiality of your account and password. You agree to accept responsibility for all activities that occur under your account. You must immediately notify us of any unauthorized use of your account.
</p>

<h3 style="color:var(--primary)">5. Content Ownership</h3>
<p style="color:#aaa;margin-bottom:20px">
You retain all rights to the content you post on the Site. However, by posting content, you grant Kink N Tease a non-exclusive, royalty-free, worldwide license to use, display, and distribute your content on the Site.
</p>

<h3 style="color:var(--primary)">6. Privacy</h3>
<p style="color:#aaa;margin-bottom:20px">
Your use of the Site is also governed by our Privacy Policy. Please review our Privacy Policy to understand our practices.
</p>

<h3 style="color:var(--primary)">7. Termination</h3>
<p style="color:#aaa;margin-bottom:20px">
We reserve the right to terminate or suspend your account at any time, with or without notice, for conduct that we believe violates these Terms of Service or is harmful to other users, us, or third parties, or for any other reason.
</p>

<h3 style="color:var(--primary)">8. Disclaimer of Warranties</h3>
<p style="color:#aaa;margin-bottom:20px">
THE SITE IS PROVIDED "AS IS" WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT.
</p>

<h3 style="color:var(--primary)">9. Limitation of Liability</h3>
<p style="color:#aaa;margin-bottom:20px">
IN NO EVENT SHALL KINK N TEASE BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES ARISING OUT OF OR RELATED TO YOUR USE OF THE SITE.
</p>

<h3 style="color:var(--primary)">10. Changes to Terms</h3>
<p style="color:#aaa;margin-bottom:20px">
We reserve the right to modify these Terms of Service at any time. Changes will be effective immediately upon posting. Your continued use of the Site following the posting of changes constitutes your acceptance of such changes.
</p>

<h3 style="color:var(--primary)">11. Contact</h3>
<p style="color:#aaa;margin-bottom:10px">
If you have any questions about these Terms, please contact us at:
</p>
<p style="color:var(--primary);margin-bottom:20px">
üìß <a href="/cdn-cgi/l/email-protection#52212722223d202612393b3c393c26373321377c313d3f" style="color:var(--primary)"><span class="__cf_email__" data-cfemail="35464045455a4741755e5c5b5e5b41505446501b565a58">[email&#160;protected]</span></a>
</p>

<p style="color:#666;font-size:12px;margin-top:30px;padding-top:20px;border-top:1px solid #333">
Last Updated: December 2024
</p>

</div>
</div>
</div>

<!-- Privacy Policy Modal -->
<div id="modal-privacy" class="modal">
<div class="modal-content" style="max-width:800px;max-height:85vh">
<div class="modal-header">
<h2>üîí Privacy Policy</h2>
<button class="modal-close" onclick="APP.closeModal('privacy')">&times;</button>
</div>
<div class="modal-body" style="max-height:calc(85vh - 80px);overflow-y:auto;padding:30px;line-height:1.8">

<h3 style="color:var(--primary);margin-top:0">1. Information We Collect</h3>
<p style="color:#aaa;margin-bottom:10px">We collect information you provide directly to us, including:</p>
<ul style="color:#aaa;margin-bottom:20px;padding-left:25px">
<li>Account information (username, email, password, date of birth)</li>
<li>Profile information (photos, bio, interests, preferences)</li>
<li>Messages and content you post</li>
<li>Payment information (processed securely through third-party providers)</li>
<li>Usage data (pages visited, features used, interactions)</li>
</ul>

<h3 style="color:var(--primary)">2. How We Use Your Information</h3>
<p style="color:#aaa;margin-bottom:10px">We use your information to:</p>
<ul style="color:#aaa;margin-bottom:20px;padding-left:25px">
<li>Provide and improve our services</li>
<li>Match you with compatible users</li>
<li>Process transactions and send notifications</li>
<li>Communicate with you about your account</li>
<li>Ensure safety and prevent fraud</li>
<li>Comply with legal obligations</li>
</ul>

<h3 style="color:var(--primary)">3. Information Sharing</h3>
<p style="color:#aaa;margin-bottom:20px">
We do NOT sell your personal information. We may share your information with:
</p>
<ul style="color:#aaa;margin-bottom:20px;padding-left:25px">
<li><strong>Other Users:</strong> Your profile information is visible to other users as per your privacy settings</li>
<li><strong>Service Providers:</strong> Third parties who help us operate the Site (payment processors, hosting providers)</li>
<li><strong>Legal Requirements:</strong> When required by law or to protect rights and safety</li>
</ul>

<h3 style="color:var(--primary)">4. Data Security</h3>
<p style="color:#aaa;margin-bottom:20px">
We implement reasonable security measures to protect your information from unauthorized access, alteration, disclosure, or destruction. However, no internet transmission is completely secure, and we cannot guarantee absolute security.
</p>

<h3 style="color:var(--primary)">5. Your Privacy Controls</h3>
<p style="color:#aaa;margin-bottom:10px">You can:</p>
<ul style="color:#aaa;margin-bottom:20px;padding-left:25px">
<li>Update your profile information at any time</li>
<li>Control who can see your profile and photos</li>
<li>Delete your account and associated data</li>
<li>Block users you don't want to interact with</li>
<li>Opt out of promotional communications</li>
</ul>

<h3 style="color:var(--primary)">6. Cookies and Tracking</h3>
<p style="color:#aaa;margin-bottom:20px">
We use cookies and similar technologies to remember your preferences, understand how you use the Site, and improve your experience. You can control cookies through your browser settings.
</p>

<h3 style="color:var(--primary)">7. Data Retention</h3>
<p style="color:#aaa;margin-bottom:20px">
We retain your information for as long as your account is active or as needed to provide services. If you delete your account, we will delete or anonymize your information within 30 days, except where retention is required by law.
</p>

<h3 style="color:var(--primary)">8. International Users</h3>
<p style="color:#aaa;margin-bottom:20px">
Your information may be transferred to and processed in countries other than your country of residence. By using the Site, you consent to such transfers.
</p>

<h3 style="color:var(--primary)">9. Children's Privacy</h3>
<p style="color:#aaa;margin-bottom:20px">
The Site is not intended for users under 18. We do not knowingly collect information from anyone under 18. If we become aware of such collection, we will delete the information immediately.
</p>

<h3 style="color:var(--primary)">10. Changes to Privacy Policy</h3>
<p style="color:#aaa;margin-bottom:20px">
We may update this Privacy Policy from time to time. We will notify you of significant changes by posting a notice on the Site or sending an email.
</p>

<h3 style="color:var(--primary)">11. Contact Us</h3>
<p style="color:#aaa;margin-bottom:10px">
For privacy questions or requests, contact us at:
</p>
<p style="color:var(--primary);margin-bottom:20px">
üìß <a href="/cdn-cgi/l/email-protection#71020401011e0305311a181f1a1f05141002145f121e1c" style="color:var(--primary)"><span class="__cf_email__" data-cfemail="1c6f696c6c736e685c777572777268797d6f79327f7371">[email&#160;protected]</span></a>
</p>

<p style="color:#666;font-size:12px;margin-top:30px;padding-top:20px;border-top:1px solid #333">
Last Updated: December 2024
</p>

</div>
</div>
</div>

<!-- Disclaimer Modal -->
<div id="modal-disclaimer" class="modal">
<div class="modal-content" style="max-width:800px;max-height:85vh">
<div class="modal-header">
<h2>‚ö†Ô∏è Disclaimer</h2>
<button class="modal-close" onclick="APP.closeModal('disclaimer')">&times;</button>
</div>
<div class="modal-body" style="max-height:calc(85vh - 80px);overflow-y:auto;padding:30px;line-height:1.8">

<h3 style="color:var(--primary);margin-top:0">Important Notice</h3>
<p style="color:#aaa;margin-bottom:30px">
Please read this disclaimer carefully before using Kink N Tease. By using this site, you acknowledge and agree to the following:
</p>

<h3 style="color:var(--primary)">1. Adult Content</h3>
<p style="color:#aaa;margin-bottom:20px">
This website contains adult-oriented content and is intended for adults only (18+). If you are under 18 or if it is illegal to view such material in your jurisdiction, you must leave immediately.
</p>

<h3 style="color:var(--primary)">2. No Guarantees</h3>
<p style="color:#aaa;margin-bottom:20px">
Kink N Tease does not guarantee that you will find a match, relationship, or any specific outcome from using the Site. Success depends on many factors beyond our control, including user effort, compatibility, and timing.
</p>

<h3 style="color:var(--primary)">3. User Verification</h3>
<p style="color:#aaa;margin-bottom:20px">
While we make efforts to verify users, we cannot guarantee the accuracy of information provided by users. You are responsible for your own safety when interacting with other users.
</p>

<h3 style="color:var(--primary)">4. Safety Recommendations</h3>
<p style="color:#aaa;margin-bottom:10px">
For your safety, we strongly recommend:
</p>
<ul style="color:#aaa;margin-bottom:20px;padding-left:25px">
<li>Meet in public places for first meetings</li>
<li>Tell a friend or family member about your plans</li>
<li>Never share financial information</li>
<li>Never send money to someone you haven't met in person</li>
<li>Trust your instincts - if something feels wrong, it probably is</li>
<li>Report suspicious behavior immediately</li>
</ul>

<h3 style="color:var(--primary)">5. Third-Party Content</h3>
<p style="color:#aaa;margin-bottom:20px">
The Site may contain links to third-party websites or content. We are not responsible for the content, accuracy, or practices of third-party sites. Use of third-party sites is at your own risk.
</p>

<h3 style="color:var(--primary)">6. No Professional Advice</h3>
<p style="color:#aaa;margin-bottom:20px">
Information on the Site is for general informational purposes only and should not be considered professional advice (medical, legal, financial, or otherwise). Consult qualified professionals for specific advice.
</p>

<h3 style="color:var(--primary)">7. User-Generated Content</h3>
<p style="color:#aaa;margin-bottom:20px">
Content posted by users represents their own views and opinions, not those of Kink N Tease. We do not endorse, support, or guarantee the accuracy of user-generated content.
</p>

<h3 style="color:var(--primary)">8. Technical Issues</h3>
<p style="color:#aaa;margin-bottom:20px">
While we strive to provide uninterrupted service, we cannot guarantee the Site will be available at all times. Technical issues, maintenance, or other factors may cause temporary unavailability.
</p>

<h3 style="color:var(--primary)">9. Limitation of Liability</h3>
<p style="color:#aaa;margin-bottom:20px">
TO THE FULLEST EXTENT PERMITTED BY LAW, KINK N TEASE SHALL NOT BE LIABLE FOR ANY DAMAGES ARISING FROM YOUR USE OF THE SITE, INCLUDING BUT NOT LIMITED TO DIRECT, INDIRECT, INCIDENTAL, PUNITIVE, AND CONSEQUENTIAL DAMAGES.
</p>

<h3 style="color:var(--primary)">10. Jurisdiction</h3>
<p style="color:#aaa;margin-bottom:20px">
By using the Site, you agree that any disputes will be governed by the laws of the jurisdiction where Kink N Tease operates, without regard to conflict of law principles.
</p>

<h3 style="color:var(--primary)">11. Contact for Questions</h3>
<p style="color:#aaa;margin-bottom:10px">
If you have questions about this disclaimer, please contact:
</p>
<p style="color:var(--primary);margin-bottom:20px">
üìß <a href="/cdn-cgi/l/email-protection#f0838580809f8284b09b999e9b9e8495918395de939f9d" style="color:var(--primary)"><span class="__cf_email__" data-cfemail="1665636666796462567d7f787d7862737765733875797b">[email&#160;protected]</span></a>
</p>

<div style="background:rgba(231,76,60,0.1);border-left:3px solid var(--primary);padding:15px;margin-top:30px;border-radius:5px">
<p style="color:var(--primary);font-weight:600;margin-bottom:8px">‚ö†Ô∏è Use at Your Own Risk</p>
<p style="color:#aaa;font-size:13px;margin:0">
By using Kink N Tease, you acknowledge that you do so at your own risk and agree to take full responsibility for your interactions, decisions, and safety.
</p>
</div>

<p style="color:#666;font-size:12px;margin-top:30px;padding-top:20px;border-top:1px solid #333">
Last Updated: December 2024
</p>

</div>
</div>
</div>
<!-- Promo Code Modal -->
<div id="modal-promo" class="modal">
<div class="modal-content" style="max-width:500px">
<span class="close" onclick="APP.closeModal('promo')">&times;</span>
<h2 style="margin-bottom:20px">üéÅ Redeem Promo Code</h2>
<div style="background:rgba(233,69,96,0.1);padding:20px;border-radius:12px;margin-bottom:20px">
<p style="font-size:14px;color:#ccc;margin:0">
Have a promo code from Facebook or another source? Enter it here to unlock your benefits!
</p>
</div>
<div style="margin-bottom:20px">
<label style="display:block;margin-bottom:8px;color:#ccc">Promo Code:</label>
<input type="text" id="promo-code-input" placeholder="Enter code (e.g., FB1MONTH)" style="width:100%;padding:12px;background:var(--darker);border:1px solid #333;border-radius:8px;color:#fff;font-size:16px;text-transform:uppercase" maxlength="20">
<div id="promo-error" style="color:#e74c3c;margin-top:8px;font-size:14px;display:none"></div>
<div id="promo-success" style="color:var(--secondary);margin-top:8px;font-size:14px;display:none"></div>
</div>
<div style="display:flex;gap:10px">
<button class="btn btn-secondary" onclick="APP.closeModal('promo')" style="flex:1">Cancel</button>
<button class="btn btn-primary" onclick="APP.redeemPromoCode()" style="flex:1">‚úì Redeem Code</button>
</div>
<div style="margin-top:20px;padding-top:20px;border-top:1px solid #333">
<p style="font-size:13px;color:#888;margin:0 0 10px 0">
<strong style="color:var(--primary)">Available Promo Codes:</strong>
</p>
<div style="background:var(--darker);padding:12px;border-radius:8px;font-family:monospace">
<div style="margin-bottom:8px"><strong style="color:#fff">FB1MONTH</strong> - 1 month free premium</div>
<div style="margin-bottom:8px"><strong style="color:#fff">WELCOME100</strong> - 100 free coins</div>
<div><strong style="color:#fff">PREMIUM7DAY</strong> - 7 days free premium</div>
</div>
</div>
</div>
</div>


<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const API = 'https://kinkntease.com/api/index.php';
const KEY = 'kinkntease_secret_key_2024';

const APP = {
    user: null,
    members: [],
    conversations: [],
    currentConv: null,
    currentView: 'discover',
    honCandidates: [],
    honIndex: 0,
    honStats: { rated: 0, hot: 0, matches: 0 },
    currentRoom: null,
    roomPollInterval: null,

    async init() {
        console.log('üöÄ App initializing...');
        if (!localStorage.getItem('age_verified')) {
            this.showModal('age');
            return;
        }
        this.setupEvents();
        await this.checkAuth();
        await this.loadMembers();
        if (this.user) this.startPolling();
    },

    setupEvents() {
        document.querySelectorAll('.sidebar-item[data-view]').forEach(item => {
            item.addEventListener('click', () => this.showView(item.dataset.view));
        });
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('user-dropdown')?.classList.remove('show');
            }
        });
        document.addEventListener('keydown', (e) => {
            if (this.currentView === 'hotornot') {
                if (e.key === 'ArrowLeft') this.honVote('nope');
                if (e.key === 'ArrowRight') this.honVote('hot');
                if (e.key === 'ArrowDown') this.honSkip();
            }
        });
        
        // Photo drag & drop
        const dropZone = document.getElementById('photo-drop-zone');
        if (dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });
            
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    document.getElementById('photo-file').files = files;
                    this.handlePhotoSelect({ target: { files } });
                }
            }, false);
        }
    },

    async api(endpoint, action, method = 'GET', data = null) {
        const url = `${API}?endpoint=${endpoint}&action=${action}`;
        const opts = {
            method,
            headers: { 'X-API-Key': KEY, 'Content-Type': 'application/json' },
            credentials: 'include'
        };
        if (data && method !== 'GET') opts.body = JSON.stringify(data);
        try {
            const r = await fetch(url, opts);
            const json = await r.json();
            console.log(`üì° ${endpoint}/${action}:`, json);
            return json;
        } catch (e) {
            console.error(`‚ùå API Error:`, e);
            return { success: false, error: e.message };
        }
    },

    async apiGet(endpoint, action, params = {}) {
        let url = `${API}?endpoint=${endpoint}&action=${action}`;
        Object.keys(params).forEach(k => url += `&${k}=${encodeURIComponent(params[k])}`);
        try {
            const r = await fetch(url, { headers: { 'X-API-Key': KEY }, credentials: 'include' });
            return await r.json();
        } catch (e) {
            return { success: false, error: e.message };
        }
    },

    async uploadFile(endpoint, action, formData) {
        const url = `${API}?endpoint=${endpoint}&action=${action}`;
        try {
            const r = await fetch(url, {
                method: 'POST',
                headers: { 'X-API-Key': KEY },
                credentials: 'include',
                body: formData
            });
            return await r.json();
        } catch (e) {
            return { success: false, error: e.message };
        }
    },

    async checkAuth() {
        const r = await this.api('auth', 'check');
        if (r.success && (r.user || r.data?.user)) {
            this.user = r.user || r.data.user;
            this.updateAuthUI();
        }
    },

    updateAuthUI() {
        document.getElementById('auth-buttons').style.display = 'none';
        document.getElementById('logged-in-menu').style.display = 'flex';
        document.getElementById('coins-count').textContent = this.user.coins || 0;
        const avatar = document.getElementById('nav-avatar');
        const displayName = this.user.display_name || this.user.username;
        
        if (this.user.avatar_url) {
            avatar.style.backgroundImage = `url(https://kinkntease.com${this.user.avatar_url})`;
            avatar.textContent = '';
        } else {
            avatar.textContent = displayName;
            avatar.style.backgroundImage = 'none';
        }
        
        // Update membership badge
        this.updateMembershipBadge();
        
        // Show admin menu if user is admin
        if (this.user.is_admin) {
            document.getElementById('admin-menu-item').style.display = 'block';
        }
        
        // Start notification polling
        this.startNotificationPolling();
    },
    
    updateMembershipBadge() {
        const badge = document.getElementById('membership-badge');
        if (!badge) return;
        
        const isPremium = this.user.is_premium || this.user.membership_tier;
        
        if (isPremium) {
            badge.className = 'membership-status-top premium';
            badge.innerHTML = '‚≠ê PREMIUM MEMBER';
            badge.title = 'You are a Premium Member - Click to manage';
        } else {
            badge.className = 'membership-status-top free';
            badge.innerHTML = '‚¨ÜÔ∏è UPGRADE TO PREMIUM';
            badge.title = 'Upgrade to Premium - Unlock all features!';
        }
    },
    
    startNotificationPolling() {
        // Update immediately
        this.updateNotificationBadge();
        
        // Then update every 30 seconds
        if (this.notificationPollInterval) clearInterval(this.notificationPollInterval);
        this.notificationPollInterval = setInterval(() => {
            this.updateNotificationBadge();
        }, 30000); // 30 seconds
    },
    
    playNotificationSound() {
        // Create audio context for notification sound
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Pleasant notification sound (two tones)
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
            
            // Second tone
            setTimeout(() => {
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1000;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.3);
            }, 100);
        } catch (e) {
            console.log('Could not play notification sound:', e);
        }
    },

    async login(e) {
        e.preventDefault();
        const errBox = document.getElementById('login-error');
        errBox.style.display = 'none';
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const r = await this.api('auth', 'login', 'POST', { username, password });
        if (r.success && (r.user || r.data?.user)) {
            this.user = r.user || r.data.user;
            this.updateAuthUI();
            this.closeModal('login');
            this.toast('Welcome back!', 'success');
            this.loadMembers();
            this.startPolling();
        } else {
            // Enhanced error messages with helpful hints
            let errorMsg = r.error || 'Login failed';
            
            if (errorMsg.includes('Invalid credentials')) {
                errorMsg = '‚ùå Invalid username/email or password. Please check and try again.';
            } else if (errorMsg.includes('verify your email')) {
                errorMsg = 'üìß ' + errorMsg + '<br><small style="color:#aaa">Tip: Check your email inbox (and spam folder) for the verification link.</small>';
            }
            
            errBox.innerHTML = errorMsg;
            errBox.style.display = 'block';
        }
        return false;
    },

    async register(e) {
        e.preventDefault();
        const errBox = document.getElementById('register-error');
        const successBox = document.getElementById('register-success');
        errBox.style.display = 'none';
        successBox.style.display = 'none';
        const dob = document.getElementById('reg-dob').value;
        if (dob) {
            const age = Math.floor((Date.now() - new Date(dob).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
            if (age < 18) { errBox.textContent = 'You must be 18 or older'; errBox.style.display = 'block'; return false; }
        }
        const r = await this.api('auth', 'register', 'POST', {
            username: document.getElementById('reg-username').value.trim(),
            email: document.getElementById('reg-email').value.trim(),
            password: document.getElementById('reg-password').value,
            date_of_birth: dob,
            gender: document.getElementById('reg-gender').value
        });
        if (r.success) {
            const message = r.message || 'Account created!';
            
            // Check if email verification is required
            if (message.includes('check your email') || message.includes('verify')) {
                successBox.innerHTML = `
                    <strong>‚úÖ Registration Successful!</strong><br>
                    <span style="font-size:14px;color:#aaa;margin-top:8px;display:block">
                        üìß Please check your email inbox (and spam folder) for a verification link.<br>
                        You must verify your email before you can login.
                    </span>
                `;
            } else {
                successBox.textContent = 'Account created! You can now login.';
            }
            
            successBox.style.display = 'block';
            document.getElementById('register-form').reset();
            setTimeout(() => { this.closeModal('register'); this.showModal('login'); }, 4000);
        } else {
            errBox.textContent = r.error || 'Registration failed';
            errBox.style.display = 'block';
        }
        return false;
    },

    async logout() {
        await this.api('auth', 'logout', 'POST');
        this.user = null;
        document.getElementById('auth-buttons').style.display = 'flex';
        document.getElementById('logged-in-menu').style.display = 'none';
        this.toast('Logged out', 'info');
        location.reload();
    },
    
    async redeemPromoCode() {
        const input = document.getElementById('promo-code-input');
        const code = input.value.trim().toUpperCase();
        const errorDiv = document.getElementById('promo-error');
        const successDiv = document.getElementById('promo-success');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        
        if (!code) {
            errorDiv.textContent = 'Please enter a promo code';
            errorDiv.style.display = 'block';
            return;
        }
        
        try {
            const r = await this.api('promo', 'redeem', 'POST', { code: code });
            
            if (r.success) {
                successDiv.textContent = r.message || 'Promo code redeemed successfully! üéâ';
                successDiv.style.display = 'block';
                input.value = '';
                
                if (r.user) {
                    this.user = r.user;
                    this.updateUI();
                }
                
                this.toast('üéâ ' + (r.message || 'Promo code redeemed!'), 'success');
                
                setTimeout(() => {
                    this.closeModal('promo');
                }, 2000);
                
            } else {
                errorDiv.textContent = r.error || 'Invalid promo code';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'Error redeeming code. Please try again.';
            errorDiv.style.display = 'block';
        }
    },
    
    showPromoCode() {
        this.showModal('promo');
        setTimeout(() => {
            document.getElementById('promo-code-input').focus();
        }, 100);
    },
    
    showUpgrade() {
        if (!this.user) {
            this.showModal('login');
            return;
        }
        // Show the existing membership modal with PayPal buttons
        this.showModal('membership');
        this.initPayPalButtons();
    },

    async loadMembers() {
        const container = document.getElementById('members-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
        const r = await this.api('users', 'list');
        this.members = r.data?.users || r.users || [];
        this.renderMembers(this.members);
    },

    renderMembers(list) {
        const container = document.getElementById('members-container');
        if (!list.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><h3 class="empty-state-title">No members found</h3><p class="empty-state-text">Try different filters</p></div>';
            return;
        }
        
        container.innerHTML = '<div class="members-grid">' + list.map(m => this.memberCard(m)).join('') + '</div>';
    },

    memberCard(m) {
        const photo = m.primary_photo || m.avatar_url;
        const name = this.esc(m.display_name || m.username);
        const age = m.age || '?';
        const loc = m.city ? `${m.city}, ${m.country || ''}` : (m.country || '');
        return `<div class="member-card" onclick="APP.viewProfile(${m.id})">
            <div class="member-photo">${photo ? `<img src="https://kinkntease.com${photo}" alt="${name}">` : '<div class="member-photo-placeholder">üë§</div>'}
                ${m.is_online ? '<div class="badge-online">‚óè Online</div>' : ''}
                ${m.subscription_type === 'premium' || m.subscription_type === 'vip' ? '<div class="badge-premium">üíé</div>' : ''}
            </div>
            <div class="member-info">
                <div class="member-name">${name} ${m.is_verified ? '<span class="verified">‚úì</span>' : ''}</div>
                <div class="member-details">${age} ${m.gender ? '‚Ä¢ ' + m.gender : ''} ${loc ? '‚Ä¢ ' + loc : ''}</div>
                <div class="member-bio">${this.esc(m.about_me || 'No bio yet')}</div>
            </div>
        </div>`;
    },

    filterMembers() {
        const search = document.getElementById('filter-search').value.toLowerCase().trim();
        const gender = document.getElementById('filter-gender').value;
        const ageRange = document.getElementById('filter-age').value;
        const online = document.getElementById('filter-online').checked;
        const location = document.getElementById('filter-location')?.value.toLowerCase().trim() || '';
        const bodyType = document.getElementById('filter-body')?.value || '';
        const relationship = document.getElementById('filter-relationship')?.value || '';
        const lookingFor = document.getElementById('filter-looking')?.value || '';
        const verified = document.getElementById('filter-verified')?.checked || false;
        const hasPhotos = document.getElementById('filter-photos')?.checked || false;
        const premium = document.getElementById('filter-premium')?.checked || false;
        const sortBy = document.getElementById('filter-sort')?.value || 'newest';
        
        let filtered = this.members.filter(m => {
            // Comprehensive search across multiple fields
            if (search) {
                const searchTerms = search.split(' ').filter(t => t.length > 0);
                const searchableFields = [
                    m.display_name || '',
                    m.username || '',
                    m.about_me || '',
                    m.tagline || '',
                    m.interests || '',
                    m.kinks || '',
                    m.occupation || '',
                    m.city || '',
                    m.country || '',
                    m.body_type || '',
                    m.hair_color || '',
                    m.eye_color || '',
                    m.relationship_status || '',
                    m.looking_for || ''
                ].join(' ').toLowerCase();
                
                // Check if all search terms are found in the combined fields
                const matches = searchTerms.every(term => searchableFields.includes(term));
                if (!matches) return false;
            }
            
            // Gender filter
            if (gender && m.gender !== gender) return false;
            
            // Age filter
            if (ageRange && m.age) {
                const [min, max] = ageRange.replace('+', '-999').split('-').map(Number);
                if (m.age < min || m.age > max) return false;
            }
            
            // Location filter
            if (location) {
                const memberLocation = `${m.city || ''} ${m.country || ''}`.toLowerCase();
                if (!memberLocation.includes(location)) return false;
            }
            
            // Body type filter
            if (bodyType && m.body_type !== bodyType) return false;
            
            // Relationship status filter
            if (relationship && m.relationship_status !== relationship) return false;
            
            // Looking for filter
            if (lookingFor && m.looking_for && !m.looking_for.toLowerCase().includes(lookingFor)) return false;
            
            // Online filter
            if (online && !m.is_online) return false;
            
            // Verified filter
            if (verified && !m.is_verified) return false;
            
            // Has photos filter
            if (hasPhotos && (!m.photo_count || m.photo_count === 0)) return false;
            
            // Premium filter
            if (premium && !m.is_premium) return false;
            
            return true;
        });
        
        // Sort results
        filtered.sort((a, b) => {
            switch(sortBy) {
                case 'newest':
                    return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                case 'active':
                    return (b.last_active || 0) - (a.last_active || 0);
                case 'name':
                    return (a.display_name || a.username || '').localeCompare(b.display_name || b.username || '');
                case 'age-asc':
                    return (a.age || 999) - (b.age || 999);
                case 'age-desc':
                    return (b.age || 0) - (a.age || 0);
                default:
                    return 0;
            }
        });
        
        // Update results counter
        this.updateResultsCounter(filtered.length, this.members.length);
        
        // Update active filter tags
        this.updateActiveFilters({search, gender, ageRange, location, bodyType, relationship, lookingFor, online, verified, hasPhotos, premium});
        
        this.renderMembers(filtered);
    },
    
    updateResultsCounter(shown, total) {
        const counter = document.getElementById('search-results-count');
        if (counter) {
            if (shown === total) {
                counter.innerHTML = `<strong>${total}</strong> members`;
            } else {
                counter.innerHTML = `Showing <strong>${shown}</strong> of <strong>${total}</strong> members`;
            }
            counter.style.color = shown === 0 ? '#e74c3c' : '#4ecaa3';
        }
    },
    
    updateActiveFilters(filters) {
        const container = document.getElementById('active-filters');
        if (!container) return;
        
        const tags = [];
        
        if (filters.search) tags.push({label: `"${filters.search}"`, key: 'search'});
        if (filters.gender) tags.push({label: `Gender: ${filters.gender}`, key: 'gender'});
        if (filters.ageRange) tags.push({label: `Age: ${filters.ageRange}`, key: 'age'});
        if (filters.location) tags.push({label: `üìç ${filters.location}`, key: 'location'});
        if (filters.bodyType) tags.push({label: `Body: ${filters.bodyType}`, key: 'body'});
        if (filters.relationship) tags.push({label: `Status: ${filters.relationship}`, key: 'relationship'});
        if (filters.lookingFor) tags.push({label: `Looking: ${filters.lookingFor}`, key: 'looking'});
        if (filters.online) tags.push({label: 'üü¢ Online', key: 'online'});
        if (filters.verified) tags.push({label: '‚úì Verified', key: 'verified'});
        if (filters.hasPhotos) tags.push({label: 'üì∏ Photos', key: 'photos'});
        if (filters.premium) tags.push({label: '‚≠ê Premium', key: 'premium'});
        
        if (tags.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        container.innerHTML = tags.map(tag => `
            <div style="background:rgba(233,69,96,0.2);border:1px solid var(--primary);color:var(--primary);padding:6px 12px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:8px">
                <span>${tag.label}</span>
                <button onclick="APP.removeFilter('${tag.key}')" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:14px;padding:0;line-height:1">√ó</button>
            </div>
        `).join('');
    },
    
    removeFilter(key) {
        const filterMap = {
            'search': 'filter-search',
            'gender': 'filter-gender',
            'age': 'filter-age',
            'location': 'filter-location',
            'body': 'filter-body',
            'relationship': 'filter-relationship',
            'looking': 'filter-looking',
            'online': 'filter-online',
            'verified': 'filter-verified',
            'photos': 'filter-photos',
            'premium': 'filter-premium'
        };
        
        const elementId = filterMap[key];
        const element = document.getElementById(elementId);
        
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = false;
            } else {
                element.value = '';
            }
            this.filterMembers();
        }
    },
    
    toggleAdvancedSearch() {
        const panel = document.getElementById('advanced-search');
        const toggleText = document.getElementById('advanced-toggle-text');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            toggleText.innerHTML = '‚öôÔ∏è Hide Advanced';
        } else {
            panel.style.display = 'none';
            toggleText.innerHTML = '‚öôÔ∏è Advanced';
        }
    },

    clearFilters() {
        // Clear all filter inputs
        document.getElementById('filter-search').value = '';
        document.getElementById('filter-gender').value = '';
        document.getElementById('filter-age').value = '';
        document.getElementById('filter-online').checked = false;
        
        // Clear advanced filters
        const advancedFilters = ['filter-location', 'filter-body', 'filter-relationship', 'filter-looking', 'filter-verified', 'filter-photos', 'filter-premium'];
        advancedFilters.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = false;
                } else {
                    el.value = '';
                }
            }
        });
        
        // Reset sort
        const sortEl = document.getElementById('filter-sort');
        if (sortEl) sortEl.value = 'newest';
        
        // Rerender all members
        this.renderMembers(this.members);
        this.updateResultsCounter(this.members.length, this.members.length);
        this.updateActiveFilters({});
    },

    globalSearch(val) { document.getElementById('filter-search').value = val; this.filterMembers(); },

    async viewProfile(userId) {
        if (!this.user) return this.showModal('login');
        this.currentProfileId = userId;
        this.showModal('profile');
        document.getElementById('profile-content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.apiGet('profile', 'get', { user_id: userId });
        if (r.success) {
            const p = r.data?.profile || r.profile;
            const photos = r.data?.photos || r.photos || [];
            const voiceRecordings = r.data?.voice_recordings || r.voice_recordings || [];
            this.renderProfile(p, photos, voiceRecordings);
        } else {
            document.getElementById('profile-content').innerHTML = `<div class="empty-state"><p style="color:#e74c3c">${r.error || 'Failed to load'}</p></div>`;
        }
    },

    renderProfile(p, photos, voiceRecordings = []) {
        this.currentProfileId = p.id;
        const photo = photos.find(x => x.is_primary) || photos[0];
        const name = this.esc(p.display_name || p.username);
        const isMe = String(p.id) === String(this.user?.id) || p.user_id === this.user?.id;
        
        // Debug logging
        console.log('Profile Debug:', {
            profileId: p.id,
            profileUserId: p.user_id,
            currentUserId: this.user?.id,
            isMe: isMe,
            photosCount: photos.length
        });
        
        // Profile Header
        let html = `<div class="profile-header">
            <div class="profile-avatar">${photo ? `<img src="https://kinkntease.com${photo.photo_url}">` : '<div style="height:100%;display:flex;align-items:center;justify-content:center;font-size:40px">üë§</div>'}</div>
            <div class="profile-name">${name} ${p.is_verified ? '<span style="color:var(--secondary)">‚úì</span>' : ''}</div>
            ${p.tagline ? `<div style="color:#aaa;font-size:14px;font-style:italic;margin:8px 0">"${this.esc(p.tagline)}"</div>` : ''}
            <div class="profile-tagline">
                ${p.show_age !== false && p.age ? p.age + ' ‚Ä¢ ' : ''}
                ${p.gender || ''}
                ${p.show_location !== false && p.city ? ' ‚Ä¢ ' + this.esc(p.city) : ''}
            </div>
            ${p.show_online !== false && p.is_online ? '<div style="color:var(--secondary);font-size:13px;margin-top:8px">‚óè Online Now</div>' : ''}
            ${!isMe ? `<div class="profile-actions">
                <button class="btn btn-primary" onclick="APP.messageUser(${p.id},'${name}')">üí¨ Message</button>
                <button class="btn btn-secondary" onclick="APP.sendWink(${p.id})">üòâ Wink</button>
                <button class="btn btn-secondary" onclick="APP.toggleFavorite(${p.id})">‚≠ê</button>
                <button class="btn btn-secondary" onclick="APP.sendGift(${p.id})">üéÅ Gift</button>
                <button class="btn" style="background:#e74c3c" onclick="APP.blockUser(${p.id}); APP.closeModal('profile');" title="Block user">üö´ Block</button>
            </div>` : '<button class="btn btn-primary" onclick="APP.showEditProfile()" style="margin-top:15px">‚úèÔ∏è Edit Profile</button>'}
        </div>`;
        
        // Photo Gallery
        if (photos && photos.length > 0) {
            html += `<div class="profile-section">
                <div class="profile-section-title">üì∏ Photos (${photos.length})</div>
                <div class="profile-photos-grid">
                    ${photos.map(ph => {
                        const avgRating = ph.rating || 0;
                        const isLocked = ph.is_locked == 1;
                        const isLockedForViewer = ph.is_locked_for_viewer;
                        
                        // Create clickable stars for non-self profiles
                        const clickableStars = !isMe ? [1,2,3,4,5].map(starNum => {
                            const filled = starNum <= avgRating;
                            const star = filled ? '‚≠ê' : '‚òÜ';
                            return `<span onclick="event.stopPropagation(); APP.ratePhoto(${ph.id}, ${starNum});" style="cursor:pointer;font-size:20px;display:inline-block;transition:all 0.2s;filter:${filled ? 'drop-shadow(0 0 3px gold)' : 'none'};" onmouseover="this.style.transform='scale(1.3)';this.style.filter='drop-shadow(0 0 5px gold) brightness(1.5)';" onmouseout="this.style.transform='scale(1)';this.style.filter='${filled ? 'drop-shadow(0 0 3px gold)' : 'none'}';">${star}</span>`;
                        }).join('') : '';
                        
                        // Locked photo display
                        if (isLockedForViewer) {
                            return `<div class="profile-photo-item" style="position:relative;background:#1a1a1a">
                                <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
                                    <div style="font-size:60px;margin-bottom:10px">üîí</div>
                                    <div style="font-size:14px;color:#4ECCA3;font-weight:bold">LOCKED PHOTO</div>
                                    <div style="font-size:11px;color:#aaa;margin-top:5px;text-align:center">Premium members only</div>
                                </div>
                            </div>`;
                        }
                        
                        return `<div class="profile-photo-item ${ph.is_primary ? 'primary' : ''}" style="position:relative">
                            ${isLocked && isMe ? '<div style="position:absolute;top:5px;right:5px;z-index:10;background:rgba(0,0,0,0.8);padding:5px 10px;border-radius:5px;color:#ffd700;font-size:12px;font-weight:bold">üîí LOCKED</div>' : ''}
                            <img src="https://kinkntease.com${ph.photo_url}" alt="Photo" onclick="window.open('https://kinkntease.com${ph.photo_url}', '_blank')" style="cursor:pointer">
                            ${ph.is_primary ? '<div class="profile-photo-badge">PRIMARY</div>' : ''}
                            ${!isMe ? `<div style="position:absolute;bottom:5px;left:5px;right:5px;background:rgba(0,0,0,0.9);padding:8px;border-radius:5px;text-align:center;">${clickableStars}<div style="font-size:11px;color:#ffd700;margin-top:3px;font-weight:bold;text-shadow:0 0 3px rgba(0,0,0,0.8);">${avgRating > 0 ? '‚≠ê ' + avgRating.toFixed(1) + ' (' + (ph.rating_count || 0) + ' ratings)' : 'Click to rate'}</div></div>` : ''}
                            ${isMe ? `
                                <button class="photo-delete-btn" onclick="event.stopPropagation(); APP.deletePhoto(${ph.id});" title="Delete Photo">üóëÔ∏è</button>
                                <button class="photo-lock-btn" onclick="event.stopPropagation(); APP.togglePhotoLock(${ph.id});" title="${isLocked ? 'Unlock Photo' : 'Lock Photo'}" style="position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.9);border:none;padding:8px 12px;border-radius:5px;cursor:pointer;font-size:16px">${isLocked ? 'üîì' : 'üîí'}</button>
                            ` : ''}
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }
        
        // Voice Recordings
        if (voiceRecordings && voiceRecordings.length > 0) {
            html += `<div class="profile-section">
                <div class="profile-section-title">üéôÔ∏è Voice Recordings</div>
                <div style="display:flex;flex-direction:column;gap:10px">
                    ${voiceRecordings.map((v, i) => `
                        <div class="voice-recording-item" style="position:relative">
                            <button class="voice-play-btn" onclick="APP.playVoiceMessage('${v.audio_url}')">‚ñ∂</button>
                            <div class="voice-recording-info">
                                <div class="voice-recording-title">${this.esc(v.title || 'Recording ' + (i+1))}</div>
                                <div class="voice-recording-duration">${v.duration || '0:00'}</div>
                            </div>
                            ${isMe ? `<button class="voice-delete-btn" onclick="event.stopPropagation(); APP.deleteVoiceRecording(${v.id});" title="Delete Recording">üóëÔ∏è</button>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }
        
        // About Me
        if (p.about_me) {
            html += `<div class="profile-section">
                <div class="profile-section-title">About Me</div>
                <p style="line-height:1.6">${this.esc(p.about_me)}</p>
            </div>`;
        }
        
        // Stats
        html += `<div class="profile-stats">
            <div class="profile-stat">
                <div class="profile-stat-value">${p.profile_views || 0}</div>
                <div class="profile-stat-label">Views</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">${p.winks_received || 0}</div>
                <div class="profile-stat-label">Winks</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">${p.favorites_count || 0}</div>
                <div class="profile-stat-label">Favorites</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">${p.rating || '?'}</div>
                <div class="profile-stat-label">Rating</div>
            </div>
        </div>`;
        
        // Details
        html += `<div class="profile-section">
            <div class="profile-section-title">Details</div>
            <div class="profile-field-grid">`;
        
        if (p.orientation) html += `<div class="profile-field"><div class="profile-field-label">Orientation</div><div class="profile-field-value">${this.esc(p.orientation)}</div></div>`;
        if (p.body_type) html += `<div class="profile-field"><div class="profile-field-label">Body Type</div><div class="profile-field-value">${this.esc(p.body_type)}</div></div>`;
        if (p.height) html += `<div class="profile-field"><div class="profile-field-label">Height</div><div class="profile-field-value">${this.esc(p.height)}</div></div>`;
        if (p.hair_color) html += `<div class="profile-field"><div class="profile-field-label">Hair Color</div><div class="profile-field-value">${this.esc(p.hair_color)}</div></div>`;
        if (p.eye_color) html += `<div class="profile-field"><div class="profile-field-label">Eye Color</div><div class="profile-field-value">${this.esc(p.eye_color)}</div></div>`;
        if (p.relationship_status) html += `<div class="profile-field"><div class="profile-field-label">Status</div><div class="profile-field-value">${this.esc(p.relationship_status)}</div></div>`;
        if (p.smoker) html += `<div class="profile-field"><div class="profile-field-label">Smoker</div><div class="profile-field-value">${this.esc(p.smoker)}</div></div>`;
        if (p.drinker) html += `<div class="profile-field"><div class="profile-field-label">Drinker</div><div class="profile-field-value">${this.esc(p.drinker)}</div></div>`;
        if (p.occupation) html += `<div class="profile-field"><div class="profile-field-label">Occupation</div><div class="profile-field-value">${this.esc(p.occupation)}</div></div>`;
        
        html += `</div></div>`;
        
        // Looking For
        if (p.looking_for) {
            const lookingFor = p.looking_for.split(',').filter(x => x);
            if (lookingFor.length > 0) {
                html += `<div class="profile-section">
                    <div class="profile-section-title">Looking For</div>
                    <div class="profile-interests">
                        ${lookingFor.map(l => `<div class="interest-tag">${this.esc(l)}</div>`).join('')}
                    </div>
                </div>`;
            }
        }
        
        // Interests
        if (p.interests) {
            const interests = p.interests.split(',').filter(x => x);
            if (interests.length > 0) {
                html += `<div class="profile-section">
                    <div class="profile-section-title">Interests</div>
                    <div class="profile-interests">
                        ${interests.map(i => `<div class="interest-tag">${this.esc(i)}</div>`).join('')}
                    </div>
                </div>`;
            }
        }
        
        // Kinks (only show if viewing own profile or if user has kinks listed)
        if (p.kinks && (isMe || p.kinks.trim())) {
            const kinks = p.kinks.split(',').filter(x => x);
            if (kinks.length > 0) {
                html += `<div class="profile-section">
                    <div class="profile-section-title">Kinks & Preferences</div>
                    <div class="profile-interests">
                        ${kinks.map(k => `<div class="interest-tag">${this.esc(k)}</div>`).join('')}
                    </div>
                </div>`;
            }
        }
        
        // Age Preference (only show on own profile)
        if (isMe && (p.age_pref_min || p.age_pref_max)) {
            html += `<div class="profile-section">
                <div class="profile-section-title">Age Preference</div>
                <p style="color:#aaa">Looking for ages: ${p.age_pref_min || '18'} - ${p.age_pref_max || '99'}</p>
            </div>`;
        }
        
        document.getElementById('profile-content').innerHTML = html;
    },

    showMyProfile() { if (this.user) this.viewProfile(this.user.id); },

    async loadConversations() {
        const container = document.getElementById('conversations-list');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.api('messages', 'conversations');
        this.conversations = r.data?.conversations || [];
        if (!this.conversations.length) { container.innerHTML = '<div style="padding:30px;text-align:center;color:#666">No conversations yet</div>'; return; }
        container.innerHTML = this.conversations.map(c => {
            const avatar = c.avatar_url ? `https://kinkntease.com${c.avatar_url}` : '';
            const name = this.esc(c.display_name || c.username);
            return `<div class="conversation-item" onclick="APP.selectConversation(${c.user_id},'${name}','${avatar}')">
                <div class="conv-avatar" style="${avatar ? `background-image:url('${avatar}')` : ''}" onclick="event.stopPropagation(); APP.viewProfile(${c.user_id})" title="View profile">${!avatar ? name : ''}</div>
                <div class="conv-info"><div class="conv-name">${name}</div><div class="conv-preview">${this.esc(c.last_message || 'No messages')}</div></div>
                <div class="conv-meta"><div class="conv-time">${this.timeAgo(c.last_message_time)}</div>${c.unread_count > 0 ? `<div class="conv-unread">${c.unread_count}</div>` : ''}</div>
            </div>`;
        }).join('');
    },

    async selectConversation(userId, name, avatar) {
        this.currentConv = { userId, name, avatar };
        document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
        event?.target?.closest('.conversation-item')?.classList.add('active');
        const chatArea = document.getElementById('chat-area');
        chatArea.innerHTML = `<div class="chat-header">
            <div class="conv-avatar" style="${avatar ? `background-image:url('${avatar}')` : ''}" onclick="APP.viewProfile(${userId})" title="View profile">${!avatar ? name : ''}</div>
            <div class="chat-header-info"><div class="chat-header-name">${name}</div><div class="chat-header-status">Online</div></div>
            <button class="btn" style="background:#e74c3c;padding:8px 15px;margin-left:auto" onclick="APP.blockUser(${userId}); APP.showView('messages');" title="Block user">üö´ Block</button>
        </div>
        <div class="chat-messages" id="chat-messages"><div class="loading"><div class="spinner"></div></div></div>
        <div class="chat-input-area" style="position:relative">
            <!-- Emoji Picker -->
            <div class="emoji-picker" id="emoji-picker-dm"></div>
            <!-- Voice Recorder -->
            <div class="voice-recorder" id="voice-recorder-dm">
                <div class="recording-indicator">üéôÔ∏è</div>
                <div class="recording-time" id="recording-time-dm">00:00</div>
                <div class="recording-controls">
                    <button class="btn btn-danger" onclick="APP.cancelVoiceRecording()">Cancel</button>
                    <button class="btn btn-primary" onclick="APP.stopVoiceRecording()">‚úì Send</button>
                </div>
            </div>
            <form class="chat-input-wrapper" onsubmit="return APP.sendMessage(event)">
                <input type="file" id="dm-photo-input" accept="image/*" style="display:none" onchange="APP.sendPhoto(event, 'dm')">
                <button type="button" class="chat-input-btn" onclick="document.getElementById('dm-photo-input').click()" title="Send photo">üì∑</button>
                <button type="button" class="chat-input-btn" onclick="APP.toggleEmojiPicker('dm')" title="Emojis">üòä</button>
                <button type="button" class="chat-input-btn" onclick="APP.startVoiceRecording('dm')" title="Voice message">üéôÔ∏è</button>
                <button type="button" class="chat-input-btn" onclick="APP.startVideoCall(${userId})" title="Video call">üìπ</button>
                <input type="text" id="msg-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
                <button type="submit" class="chat-send-btn">‚û§</button>
            </form>
        </div>`;
        await this.loadMessages(userId);
    },

    async loadMessages(userId) {
        const r = await this.apiGet('messages', 'get', { with_user_id: userId });
        const messages = r.data?.messages || [];
        const container = document.getElementById('chat-messages');
        if (!messages.length) { container.innerHTML = '<div style="text-align:center;padding:40px;color:#666">No messages yet. Say hello!</div>'; return; }
        container.innerHTML = messages.map(m => {
            const isMe = m.sender_id === this.user.id;
            let content = '';
            
            // Render based on message type
            if (m.message_type === 'photo') {
                content = `<img src="${m.message_text}" class="message-photo" onclick="window.open('${m.message_text}', '_blank')" alt="Photo">`;
            } else if (m.message_type === 'voice') {
                content = `<div class="message-voice">
                    <button class="voice-play-btn" onclick="APP.playVoiceMessage('${m.message_text}')">‚ñ∂</button>
                    <div class="voice-waveform"><div class="voice-progress" style="width:0"></div></div>
                </div>`;
            } else {
                content = this.esc(m.message_text);
            }
            
            return `<div class="message ${isMe ? 'sent' : ''}" data-message-id="${m.id}">
                <div class="message-avatar">${isMe ? 'Me' : this.currentConv.name.charAt(0)}</div>
                <div class="message-content">
                    <div class="message-bubble">${content}</div>
                    <div class="message-time">
                        ${this.timeAgo(m.created_at)}
                        ${isMe && m.is_read == 1 ? '<span style="color:#4ECCA3;margin-left:5px" title="Read ' + (m.read_at ? this.timeAgo(m.read_at) : '') + '">‚úì‚úì</span>' : ''}
                        ${isMe && m.is_read == 0 ? '<span style="color:#666;margin-left:5px" title="Sent">‚úì</span>' : ''}
                        ${isMe ? `<button class="message-delete-btn" onclick="APP.deleteMessage(${m.id}, 'dm')" title="Delete">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
        this.api('messages', 'read', 'POST', { with_user_id: userId });
    },

    async sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !this.currentConv) return false;
        input.value = '';
        await this.api('messages', 'send', 'POST', { to_user_id: this.currentConv.userId, message_text: text, message_type: 'text' });
        await this.loadMessages(this.currentConv.userId);
        return false;
    },

    messageUser(userId, name) { this.closeModal('profile'); this.showView('messages'); setTimeout(() => this.selectConversation(userId, name, ''), 300); },

    async sendWink(userId) {
        if (!this.user) return this.showModal('login');
        const r = await this.api('social', 'send-wink', 'POST', { to_user_id: userId });
        this.toast(r.success ? 'üòâ Wink sent!' : (r.error || 'Failed'), r.success ? 'success' : 'error');
    },
    
    async ratePhoto(photoId, rating) {
        if (!this.user) {
            this.toast('Please login to rate photos', 'error');
            return;
        }
        
        const r = await this.api('profile', 'rate-photo', 'POST', { photo_id: photoId, rating });
        
        if (r.success) {
            this.toast(`‚≠ê Rated ${rating} stars!`, 'success');
            // Reload the profile to show updated rating
            const profileContent = document.getElementById('profile-content');
            if (profileContent && this.currentProfileId) {
                const resp = await this.apiGet('profile', 'get', { user_id: this.currentProfileId });
                if (resp.success) {
                    const p = resp.data?.profile || resp.profile;
                    const photos = resp.data?.photos || resp.photos || [];
                    const voiceRecordings = resp.data?.voice_recordings || resp.voice_recordings || [];
                    this.renderProfile(p, photos, voiceRecordings);
                }
            }
        } else {
            this.toast(r.error || 'Failed to rate photo', 'error');
        }
    },

    async toggleFavorite(userId) {
        if (!this.user) return this.showModal('login');
        const r = await this.api('social', 'toggle-favorite', 'POST', { user_id: userId });
        if (r.success) this.toast(r.data?.is_favorited ? '‚≠ê Added to favorites!' : 'Removed from favorites', 'success');
    },

    async loadFavorites() {
        if (!this.user) return;
        const container = document.getElementById('favorites-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.api('social', 'get-favorites', 'GET', { user_id: this.user.id });
        const favs = r.data?.favorites || [];
        if (!favs.length) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><h3>No favorites yet</h3></div>'; return; }
        container.innerHTML = '<div class="members-grid">' + favs.map(f => this.memberCard({ 
            id: f.favorited_user_id, 
            display_name: f.display_name, 
            username: f.username, 
            avatar_url: f.avatar_url, 
            primary_photo: f.primary_photo,
            age: f.age, 
            is_online: f.is_online,
            subscription_type: f.subscription_type,
            gender: f.gender
        })).join('') + '</div>';
    },

    async loadWinks() {
        if (!this.user) return;
        const container = document.getElementById('winks-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.api('social', 'get-winks', 'GET', { user_id: this.user.id });
        const winks = r.data?.winks || [];
        if (!winks.length) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòâ</div><h3>No winks yet</h3></div>'; return; }
        container.innerHTML = '<div class="members-grid">' + winks.map(w => this.memberCard({ 
            id: w.from_user_id, 
            display_name: w.display_name, 
            username: w.username, 
            avatar_url: w.avatar_url,
            primary_photo: w.primary_photo,
            age: w.age, 
            is_online: w.is_online,
            subscription_type: w.subscription_type,
            gender: w.gender
        })).join('') + '</div>';
    },

    async loadVisitors() {
        if (!this.user) return;
        const container = document.getElementById('visitors-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.api('social', 'get-profile-views', 'GET', { user_id: this.user.id });
        const views = r.data?.profile_views || [];
        const stats = r.data?.stats || {};
        document.getElementById('stat-today').textContent = stats.today || 0;
        document.getElementById('stat-week').textContent = stats.week || 0;
        document.getElementById('stat-total').textContent = stats.total || 0;
        if (!views.length) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëÄ</div><h3>No visitors yet</h3></div>'; return; }
        container.innerHTML = '<div class="members-grid">' + views.map(v => this.memberCard({ 
            id: v.viewer_id, 
            display_name: v.display_name, 
            username: v.username, 
            avatar_url: v.avatar_url,
            primary_photo: v.primary_photo,
            age: v.age, 
            is_online: v.is_online,
            subscription_type: v.subscription_type,
            gender: v.gender
        })).join('') + '</div>';
    },

    // ==================== STORIES ====================
    async loadStories() {
        const container = document.getElementById('stories-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.api('stories', 'list');
        const stories = r.data?.stories || r.stories || [];
        
        if (!stories.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìñ</div><h3 class="empty-state-title">No stories yet</h3><p class="empty-state-text">Be the first to share your story!</p></div>';
            return;
        }
        
        container.innerHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px">' + 
            stories.map(s => {
                const isMyStory = s.user_id === this.user.id;
                return `
                <div class="story-card" onclick="APP.readStory(${s.id})" style="position:relative">
                    ${isMyStory ? `<button class="media-delete-btn" onclick="event.stopPropagation(); APP.deleteStory(${s.id})" title="Delete" style="top:10px;right:10px">üóëÔ∏è</button>` : ''}
                    <div class="story-title">${this.esc(s.title)}</div>
                    <div class="story-meta">
                        By ${this.esc(s.display_name || s.username)} ‚Ä¢ 
                        ${this.timeAgo(s.created_at)} ‚Ä¢ 
                        ${s.category || 'Story'}
                    </div>
                    <div class="story-preview">${this.esc(s.content).substring(0, 200)}...</div>
                    ${s.tags ? `<div class="story-tags">${s.tags.split(',').map(t => `<span class="story-tag">${this.esc(t.trim())}</span>`).join('')}</div>` : ''}
                </div>
                `;
            }).join('') + 
        '</div>';
    },

    showWriteStory() {
        if (!this.user) return this.showModal('login');
        document.getElementById('story-form').reset();
        document.getElementById('story-error').style.display = 'none';
        document.getElementById('story-success').style.display = 'none';
        this.showModal('write-story');
    },

    async submitStory(e) {
        e.preventDefault();
        const errBox = document.getElementById('story-error');
        const successBox = document.getElementById('story-success');
        errBox.style.display = 'none';
        successBox.style.display = 'none';

        const title = document.getElementById('story-title').value.trim();
        const category = document.getElementById('story-category').value;
        const tags = document.getElementById('story-tags').value.trim();
        const content = document.getElementById('story-content').value.trim();

        if (content.length < 100) {
            errBox.textContent = 'Story must be at least 100 characters';
            errBox.style.display = 'block';
            return false;
        }

        const r = await this.api('stories', 'create', 'POST', {
            title,
            category,
            tags,
            content
        });

        if (r.success) {
            successBox.textContent = '‚úÖ Story published successfully!';
            successBox.style.display = 'block';
            document.getElementById('story-form').reset();
            setTimeout(() => {
                this.closeModal('write-story');
                this.loadStories();
            }, 1500);
        } else {
            errBox.textContent = r.error || 'Failed to publish story';
            errBox.style.display = 'block';
        }
        return false;
    },

    async readStory(storyId) {
        this.showModal('read-story');
        document.getElementById('story-read-content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.apiGet('stories', 'get', { story_id: storyId });
        
        if (r.success) {
            const s = r.data?.story || r.story;
            document.getElementById('story-read-content').innerHTML = `
                <div class="profile-header">
                    <div class="profile-name">${this.esc(s.title)}</div>
                    <div class="profile-tagline">
                        By ${this.esc(s.display_name || s.username)} ‚Ä¢ 
                        ${this.timeAgo(s.created_at)} ‚Ä¢ 
                        ${s.category || 'Story'}
                    </div>
                    ${s.tags ? `<div class="story-tags" style="margin-top:12px;justify-content:center">${s.tags.split(',').map(t => `<span class="story-tag">${this.esc(t.trim())}</span>`).join('')}</div>` : ''}
                </div>
                <div class="profile-section">
                    <div style="color:#ddd;line-height:1.8;font-size:15px;white-space:pre-wrap">${this.esc(s.content)}</div>
                </div>
            `;
        } else {
            document.getElementById('story-read-content').innerHTML = `
                <div class="empty-state">
                    <p style="color:#e74c3c">${r.error || 'Failed to load story'}</p>
                </div>
            `;
        }
    },

    // ==================== GALLERY ====================
    async loadGallery() {
        const r = await this.api('gallery', 'list');
        const counts = r.data?.counts || {};
        document.getElementById('count-hotwife').textContent = `${counts.hotwife || 0} photos`;
        document.getElementById('count-girlfriend').textContent = `${counts.girlfriend || 0} photos`;
        document.getElementById('count-couples').textContent = `${counts.couples || 0} photos`;
        document.getElementById('count-female').textContent = `${counts.female || 0} photos`;
        document.getElementById('count-male').textContent = `${counts.male || 0} photos`;
    },

    async openGallery(category) {
        if (!this.user) return this.showModal('login');
        document.getElementById('gallery-categories').style.display = 'none';
        document.getElementById('gallery-photos').style.display = 'block';
        const grid = document.getElementById('gallery-grid');
        grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.apiGet('gallery', 'list', { category });
        const photos = r.data?.photos || [];
        
        if (!photos.length) {
            grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì∏</div><h3>No photos yet</h3><p class="empty-state-text">Be the first to upload!</p></div>';
            return;
        }
        
        grid.innerHTML = photos.map(p => {
            const isMyPhoto = p.user_id === this.user.id;
            const avatarUrl = p.primary_photo ? `https://kinkntease.com${p.primary_photo}` : '';
            const username = p.username || 'Anonymous';
            const displayName = p.display_name || username;
            
            return `
            <div style="position:relative;border-radius:10px;overflow:hidden;background:var(--card)">
                <!-- User Info Header -->
                <div style="display:flex;align-items:center;padding:8px;gap:8px;cursor:pointer;background:rgba(0,0,0,0.05)" onclick="APP.renderProfile(${p.user_id})">
                    <div style="width:30px;height:30px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;color:#fff;${avatarUrl ? `background-image:url('${avatarUrl}');background-size:cover;background-position:center;` : ''}">
                        ${avatarUrl ? '' : displayName.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex:1;min-width:0">
                        <div style="font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${this.esc(displayName)}</div>
                    </div>
                </div>
                
                <!-- Photo -->
                <div style="position:relative;aspect-ratio:1;cursor:pointer;background:#000" onclick="window.open('https://kinkntease.com${p.photo_url}','_blank')">
                    <img src="https://kinkntease.com${p.photo_url}" style="width:100%;height:100%;object-fit:cover">
                    ${p.caption ? `<div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.8));padding:10px;color:#fff;font-size:12px">${this.esc(p.caption)}</div>` : ''}
                    ${isMyPhoto ? `<button class="media-delete-btn" onclick="event.stopPropagation(); APP.deleteGalleryPhoto(${p.id}, '${category}')" title="Delete">üóëÔ∏è</button>` : ''}
                </div>
            </div>
            `;
        }).join('');
    },

    backToGallery() {
        document.getElementById('gallery-categories').style.display = 'grid';
        document.getElementById('gallery-photos').style.display = 'none';
    },

    showUploadPhoto() {
        if (!this.user) return this.showModal('login');
        document.getElementById('upload-form').reset();
        document.getElementById('upload-error').style.display = 'none';
        document.getElementById('upload-success').style.display = 'none';
        document.getElementById('photo-preview').style.display = 'none';
        this.showModal('upload-photo');
    },

    handlePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            this.toast('Please select an image file', 'error');
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            this.toast('File too large. Max 10MB', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('preview-image').src = e.target.result;
            document.getElementById('photo-preview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    },

    async submitPhoto(e) {
        e.preventDefault();
        const errBox = document.getElementById('upload-error');
        const successBox = document.getElementById('upload-success');
        errBox.style.display = 'none';
        successBox.style.display = 'none';

        const category = document.getElementById('upload-category').value;
        const caption = document.getElementById('photo-caption').value.trim();
        const file = document.getElementById('photo-file').files[0];

        if (!file) {
            errBox.textContent = 'Please select a photo';
            errBox.style.display = 'block';
            return false;
        }

        const formData = new FormData();
        formData.append('photo', file);
        formData.append('category', category);
        formData.append('caption', caption);

        const r = await this.uploadFile('gallery', 'upload', formData);

        if (r.success) {
            successBox.textContent = '‚úÖ Photo uploaded successfully!';
            successBox.style.display = 'block';
            document.getElementById('upload-form').reset();
            document.getElementById('photo-preview').style.display = 'none';
            setTimeout(() => {
                this.closeModal('upload-photo');
                this.loadGallery();
            }, 1500);
        } else {
            errBox.textContent = r.error || 'Failed to upload photo';
            errBox.style.display = 'block';
        }
        return false;
    },

    // ==================== CHAT ROOMS ====================
    async loadRooms() {
        const container = document.getElementById('rooms-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const r = await this.api('chat-rooms', 'list');
        const rooms = r.data?.rooms || r.rooms || [];
        
        if (!rooms.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><h3 class="empty-state-title">No chat rooms</h3></div>';
            return;
        }
        
        container.innerHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px">' + 
            rooms.map(rm => `
                <div class="room-card" onclick="APP.joinRoom(${rm.id},'${this.esc(rm.name)}')">
                    <div class="room-icon">${rm.icon || 'üí¨'}</div>
                    <div class="room-name">${this.esc(rm.name)}</div>
                    <div class="room-description">${this.esc(rm.description || 'Join the conversation')}</div>
                    <div class="room-users">üë• ${rm.active_users || 0} online</div>
                </div>
            `).join('') + 
        '</div>';
    },

    async joinRoom(roomId, roomName) {
        if (!this.user) return this.showModal('login');
        
        this.currentRoom = { id: roomId, name: roomName };
        document.getElementById('room-title').textContent = roomName;
        document.getElementById('room-user-count').textContent = 'Loading...';
        document.getElementById('room-messages').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        document.getElementById('room-message-input').value = '';
        
        this.showModal('chat-room');
        await this.loadRoomMessages();
        
        // Start polling for new messages
        if (this.roomPollInterval) clearInterval(this.roomPollInterval);
        this.roomPollInterval = setInterval(() => this.loadRoomMessages(), 3000);
    },

    async loadRoomMessages() {
        if (!this.currentRoom) return;
        
        const r = await this.apiGet('chat-rooms', 'messages', { room_id: this.currentRoom.id });
        
        if (r.success) {
            const messages = r.data?.messages || r.messages || [];
            const userCount = r.data?.active_users || 0;
            
            document.getElementById('room-user-count').textContent = `üë• ${userCount} user${userCount !== 1 ? 's' : ''} online`;
            
            const container = document.getElementById('room-messages');
            if (!messages.length) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#666">No messages yet. Start the conversation!</div>';
                return;
            }
            
            const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            
            container.innerHTML = messages.map(m => {
                const isMe = m.user_id === this.user.id;
                let content = '';
                
                // Render based on message type
                if (m.message_type === 'photo') {
                    content = `
                        <div style="position:relative;border-radius:10px;overflow:hidden">
                            <img src="${m.message_text}" class="message-photo" ${!isMe ? `onclick="APP.renderProfile(${m.user_id})" style="cursor:pointer" title="View ${this.esc(m.display_name || m.username)}'s profile"` : 'style="cursor:default"'} alt="Photo">
                            ${!isMe ? `
                                <div style="position:absolute;bottom:5px;left:5px;background:rgba(0,0,0,0.8);padding:4px 8px;border-radius:5px;font-size:11px;color:#fff;pointer-events:none">
                                    üì∏ ${this.esc(m.display_name || m.username)}
                                </div>
                            ` : ''}
                            <button onclick="event.stopPropagation();window.open('${m.message_text}', '_blank')" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.8);border:none;color:#fff;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:14px" title="Open full size">üîç</button>
                        </div>
                    `;
                } else if (m.message_type === 'voice') {
                    content = `<div class="message-voice">
                        <button class="voice-play-btn" onclick="APP.playVoiceMessage('${m.message_text}')">‚ñ∂</button>
                        <div class="voice-waveform"><div class="voice-progress" style="width:0"></div></div>
                    </div>`;
                } else {
                    content = this.esc(m.message_text);
                }
                
                // Get user's profile photo or use default avatar
                const avatarUrl = m.primary_photo ? `https://kinkntease.com${m.primary_photo}` : '';
                const avatarStyle = avatarUrl ? `background-image:url('${avatarUrl}');background-size:cover;background-position:center;` : '';
                const avatarText = avatarUrl ? '' : (isMe ? 'Me' : (m.display_name || m.username));
                
                return `
                    <div class="message ${isMe ? 'sent' : ''}" data-message-id="${m.id}">
                        ${isMe ? '' : `
                            <div class="message-avatar" onclick="APP.renderProfile(${m.user_id})" style="cursor:pointer;${avatarStyle}" title="View ${this.esc(m.display_name || m.username)}'s profile">
                                ${avatarText}
                            </div>
                        `}
                        ${isMe ? `
                            <div class="message-avatar" style="${avatarStyle}">${avatarText}</div>
                        ` : ''}
                        <div class="message-content">
                            ${!isMe ? `<div style="font-size:11px;color:#888;margin-bottom:3px;cursor:pointer" onclick="APP.renderProfile(${m.user_id})" title="View profile">${this.esc(m.display_name || m.username)}</div>` : ''}
                            <div class="message-bubble">${content}</div>
                            <div class="message-time">
                                ${this.timeAgo(m.created_at)}
                                ${isMe ? `<button class="message-delete-btn" onclick="APP.deleteMessage(${m.id}, 'room')" title="Delete">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (wasScrolledToBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
    },

    async sendRoomMessage(e) {
        e.preventDefault();
        const input = document.getElementById('room-message-input');
        const text = input.value.trim();
        
        if (!text || !this.currentRoom) return false;
        
        input.value = '';
        
        const r = await this.api('chat-rooms', 'send', 'POST', {
            room_id: this.currentRoom.id,
            message: text
        });
        
        if (r.success) {
            await this.loadRoomMessages();
        } else {
            this.toast(r.error || 'Failed to send message', 'error');
        }
        
        return false;
    },

    leaveChatRoom() {
        if (this.roomPollInterval) {
            clearInterval(this.roomPollInterval);
            this.roomPollInterval = null;
        }
        this.currentRoom = null;
        document.getElementById('modal-chat-room')?.classList.remove('show');
    },

    // ==================== HOT OR NOT ====================
    async loadHotOrNot() {
        if (!this.user) return this.showModal('login');
        const container = document.getElementById('hon-card-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        const statsR = await this.api('hotornot', 'stats');
        if (statsR.success && statsR.data) {
            this.honStats = statsR.data;
            document.getElementById('hon-rated').textContent = this.honStats.rated || 0;
            document.getElementById('hon-hot').textContent = this.honStats.hot || 0;
            document.getElementById('hon-matches').textContent = this.honStats.matches || 0;
        }
        const r = await this.api('hotornot', 'candidates');
        this.honCandidates = r.data?.candidates || [];
        this.honIndex = 0;
        this.renderHonCard();
    },

    renderHonCard() {
        const container = document.getElementById('hon-card-container');
        if (this.honIndex >= this.honCandidates.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéâ</div><h3>All caught up!</h3><button class="btn btn-primary" onclick="APP.loadHotOrNot()">Refresh</button></div>';
            return;
        }
        const m = this.honCandidates[this.honIndex];
        const photo = m.primary_photo || m.avatar_url;
        container.innerHTML = `<div style="width:100%;height:100%;background:var(--darker);border-radius:16px;overflow:hidden">
            <div style="height:320px;background:var(--card);${photo ? `background-image:url(https://kinkntease.com${photo});background-size:cover;background-position:center` : 'display:flex;align-items:center;justify-content:center;font-size:80px'}">${!photo ? 'üë§' : ''}</div>
            <div style="padding:20px">
                <div style="font-size:22px;font-weight:bold">${this.esc(m.display_name || m.username)}</div>
                <div style="color:#888;font-size:14px">${m.age || '?'} ${m.gender ? '‚Ä¢ ' + m.gender : ''} ${m.city ? '‚Ä¢ ' + m.city : ''}</div>
            </div>
        </div>`;
    },

    async honVote(vote) {
        if (!this.honCandidates[this.honIndex]) return;
        const userId = this.honCandidates[this.honIndex].id;
        const r = await this.api('hotornot', 'vote', 'POST', { user_id: userId, vote });
        if (r.success) {
            this.honStats.rated++;
            if (vote === 'hot') this.honStats.hot++;
            document.getElementById('hon-rated').textContent = this.honStats.rated;
            document.getElementById('hon-hot').textContent = this.honStats.hot;
            if (r.data?.is_match) { this.honStats.matches++; document.getElementById('hon-matches').textContent = this.honStats.matches; this.toast('üíï It\'s a match!', 'success'); }
        }
        this.honIndex++;
        this.renderHonCard();
    },

    honSkip() { this.honIndex++; this.renderHonCard(); },
    showMatches() { this.toast('Matches coming soon!', 'info'); },

    // ==================== UTILITY ====================
    startPolling() { this.fetchCounts(); setInterval(() => this.fetchCounts(), 30000); },

    async fetchCounts() {
        const r = await this.api('social', 'get-unread-counts');
        if (r.success && r.data) {
            this.updateBadge('nav-msg-badge', r.data.messages);
            this.updateBadge('sb-msg-badge', r.data.messages);
            this.updateBadge('nav-notif-badge', r.data.notifications);
            this.updateBadge('sb-wink-badge', r.data.winks);
        }
    },

    updateBadge(id, count) {
        const el = document.getElementById(id);
        if (el) { el.textContent = count; el.style.display = count > 0 ? 'inline-block' : 'none'; }
    },

    showNotifications() {
        if (!this.user) return this.showModal('login');
        this.showModal('notifications');
        this.currentNotifFilter = 'all';
        this.loadNotifications();
    },
    
    async loadNotifications() {
        const filter = this.currentNotifFilter || 'all';
        
        const container = document.getElementById('notifications-list');
        const empty = document.getElementById('notifications-empty');
        
        // Show loading spinner
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        empty.style.display = 'none';
        
        try {
            const r = await this.apiGet('notifications', 'list', { filter });
            
            if (r.success) {
                const notifications = r.notifications || [];
                
                // Update filter buttons
                document.querySelectorAll('[id^="notif-filter-"]').forEach(btn => btn.classList.remove('btn-primary'));
                document.getElementById(`notif-filter-${filter}`)?.classList.add('btn-primary');
                
                if (!notifications.length) {
                    container.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }
                
                empty.style.display = 'none';
                container.innerHTML = notifications.map(n => {
                    const time = this.timeAgo(n.created_at);
                    const isUnread = n.is_read == 0;
                    const bgColor = isUnread ? 'rgba(78,204,163,0.1)' : 'transparent';
                    
                    let icon = 'üîî';
                    let action = '';
                    let clickAction = '';
                    
                    switch(n.type) {
                        case 'message':
                            icon = 'üí¨';
                            action = `sent you a message`;
                            clickAction = `onclick="APP.closeModal('notifications');APP.showView('messages');APP.selectConversation(${n.from_user_id})"`;
                            break;
                        case 'wink':
                            icon = 'üòâ';
                            action = `winked at you`;
                            clickAction = `onclick="APP.closeModal('notifications');APP.renderProfile(${n.from_user_id})"`;
                            break;
                        case 'view':
                            icon = 'üëÅÔ∏è';
                            action = `viewed your profile`;
                            clickAction = `onclick="APP.closeModal('notifications');APP.renderProfile(${n.from_user_id})"`;
                            break;
                        case 'favorite':
                            icon = '‚≠ê';
                            action = `added you to favorites`;
                            clickAction = `onclick="APP.closeModal('notifications');APP.renderProfile(${n.from_user_id})"`;
                            break;
                        case 'vm_like':
                            icon = '‚ù§Ô∏è';
                            action = `liked your voice message`;
                            clickAction = `onclick="APP.closeModal('notifications');APP.showVoiceMessages()"`;
                            break;
                        case 'gift':
                            icon = 'üéÅ';
                            action = `sent you a gift`;
                            clickAction = `onclick="APP.closeModal('notifications');APP.showMyGifts()"`;
                            break;
                    }
                    
                    return `
                        <div class="notification-item" style="padding:15px;margin-bottom:10px;background:${bgColor};border-radius:10px;cursor:pointer;border-left:3px solid ${isUnread ? 'var(--primary)' : 'transparent'}" ${clickAction}>
                            <div style="display:flex;gap:12px;align-items:center">
                                <div style="font-size:24px;flex-shrink:0">${icon}</div>
                                <div style="flex:1;min-width:0">
                                    <div style="font-weight:${isUnread ? '600' : '400'};margin-bottom:4px">
                                        <span style="color:var(--primary)">${this.esc(n.from_username || 'Someone')}</span>
                                        ${action}
                                    </div>
                                    ${n.message ? `<div style="color:#aaa;font-size:13px;margin-bottom:6px">"${this.esc(n.message.substring(0, 60))}${n.message.length > 60 ? '...' : ''}"</div>` : ''}
                                    <div style="color:#666;font-size:11px">${time}</div>
                                </div>
                                ${isUnread ? '<div style="width:8px;height:8px;background:var(--primary);border-radius:50%;flex-shrink:0"></div>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Mark as read after viewing
                setTimeout(() => this.markNotificationsRead(), 2000);
            } else {
                throw new Error(r.error || 'Failed to load notifications');
            }
        } catch (err) {
            console.error('Error loading notifications:', err);
            container.innerHTML = '';
            empty.style.display = 'block';
        }
    },
    
    async markNotificationsRead() {
        await this.api('notifications', 'mark-read', 'POST');
        this.updateNotificationBadge();
    },
    
    filterNotifications(filter) {
        this.currentNotifFilter = filter;
        this.loadNotifications();
    },
    
    async updateNotificationBadge() {
        if (!this.user) return;
        
        const r = await this.apiGet('notifications', 'count');
        if (r.success) {
            const count = r.unread_count || 0;
            const badge = document.getElementById('nav-notif-badge');
            
            // Play sound if count increased
            if (count > 0 && (!this.lastNotifCount || count > this.lastNotifCount)) {
                this.playNotificationSound();
            }
            this.lastNotifCount = count;
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
            
            // Also update message badge
            const msgCount = r.unread_messages || 0;
            const msgBadge = document.getElementById('nav-msg-badge');
            if (msgCount > 0) {
                msgBadge.textContent = msgCount > 99 ? '99+' : msgCount;
                msgBadge.style.display = 'block';
            } else {
                msgBadge.style.display = 'none';
            }
        }
    },
    
    async submitReport(e) {
        e.preventDefault();
        
        const type = document.getElementById('report-type').value;
        const username = document.getElementById('report-username').value.trim();
        const details = document.getElementById('report-details').value.trim();
        
        if (!type || !details) {
            this.toast('Please fill in all required fields', 'error');
            return;
        }
        
        // Send report email
        const subject = `üö® User Report: ${type}`;
        const body = `Report Type: ${type}%0D%0AReported User: ${username || 'Not specified'}%0D%0AReporter: ${this.user ? this.user.username : 'Not logged in'}%0D%0A%0D%0ADetails:%0D%0A${encodeURIComponent(details)}`;
        
        window.location.href = `mailto:support@kinkntease.com?subject=${subject}&body=${body}`;
        
        this.toast('‚úÖ Report submitted! Thank you for helping keep our community safe.', 'success');
        this.closeModal('report');
        
        // Reset form
        document.getElementById('report-type').value = '';
        document.getElementById('report-username').value = '';
        document.getElementById('report-details').value = '';
    },
    
    showVoiceMessages() {
        this.showView('voice-messages');
        this.loadVoiceMessages('all');
    },
    
    async loadVoiceMessages(filter = 'all') {
        const container = document.getElementById('voice-messages-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.api('voice-messages', 'list', 'GET', { filter });
        const messages = r.data?.messages || [];
        const stats = r.data?.stats || {};
        
        // Update stats
        document.getElementById('vm-stat-mine').textContent = stats.mine || 0;
        document.getElementById('vm-stat-plays').textContent = stats.plays || 0;
        document.getElementById('vm-stat-likes').textContent = stats.likes || 0;
        document.getElementById('vm-stat-total').textContent = stats.total || 0;
        
        // Update filter buttons
        document.querySelectorAll('[id^="vm-filter-"]').forEach(btn => {
            btn.style.background = '';
        });
        document.getElementById(`vm-filter-${filter}`).style.background = 'var(--primary)';
        
        // Render messages
        if (!messages.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéôÔ∏è</div><h3>No voice messages yet</h3><p>Be the first to record a sexy message!</p></div>';
            return;
        }
        
        container.innerHTML = '<div class="voice-messages-grid">' + messages.map(m => this.voiceMessageCard(m)).join('') + '</div>';
    },
    
    voiceMessageCard(m) {
        const isOwn = this.user && m.user_id === this.user.id;
        const isLiked = m.is_liked;
        return `
            <div class="voice-message-card">
                <div class="vm-header">
                    <div class="vm-user" onclick="APP.viewProfile(${m.user_id})">
                        <div class="vm-avatar">${m.username?.charAt(0).toUpperCase() || '?'}</div>
                        <div>
                            <div class="vm-username">${this.esc(m.username)}</div>
                            <div class="vm-time">${this.timeAgo(m.created_at)}</div>
                        </div>
                    </div>
                    ${isOwn ? `
                        <div class="vm-actions">
                            <button class="vm-action-btn" onclick="APP.editVoiceMessage(${m.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="vm-action-btn" onclick="APP.deleteVoiceMessage(${m.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    ` : ''}
                </div>
                
                <div class="vm-content">
                    <h3 class="vm-title">${this.esc(m.title)}</h3>
                    ${m.description ? `<p class="vm-description">${this.esc(m.description)}</p>` : ''}
                </div>
                
                <div class="vm-player">
                    <audio controls class="vm-audio" data-id="${m.id}" onplay="APP.trackPlay(${m.id})">
                        <source src="https://kinkntease.com${m.audio_url}" type="audio/mpeg">
                    </audio>
                    <div class="vm-duration">${this.formatDuration(m.duration)}</div>
                </div>
                
                <div class="vm-stats">
                    <button class="vm-stat-btn ${isLiked ? 'liked' : ''}" onclick="APP.toggleVMLike(${m.id})" ${!this.user ? 'disabled' : ''}>
                        <span class="vm-stat-icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                        <span class="vm-stat-count">${m.likes_count || 0}</span>
                    </button>
                    <div class="vm-stat">
                        <span class="vm-stat-icon">‚ñ∂Ô∏è</span>
                        <span class="vm-stat-count">${m.plays_count || 0}</span>
                    </div>
                    ${!isOwn && this.user ? `
                        <button class="vm-stat-btn" onclick="APP.blockUser(${m.user_id})" title="Block user">
                            <span class="vm-stat-icon">üö´</span>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    },
    
    filterVoiceMessages(filter) {
        this.loadVoiceMessages(filter);
    },
    
    showRecordVoiceMessage() {
        if (!this.user) {
            this.toast('Please login to record voice messages', 'error');
            return;
        }
        this.showModal('record-voice');
        this.resetVMRecorder();
    },
    
    resetVMRecorder() {
        document.getElementById('vm-title').value = '';
        document.getElementById('vm-description').value = '';
        document.getElementById('vm-public').checked = true;
        document.getElementById('vm-recorder-ready').style.display = 'block';
        document.getElementById('vm-recorder-recording').style.display = 'none';
        document.getElementById('vm-recorder-preview').style.display = 'none';
        document.getElementById('vm-recorder-uploading').style.display = 'none';
        if (this.vmMediaRecorder) {
            this.vmMediaRecorder.stop();
            this.vmMediaRecorder = null;
        }
        if (this.vmStream) {
            this.vmStream.getTracks().forEach(track => track.stop());
            this.vmStream = null;
        }
    },
    
    async startVMRecording() {
        try {
            this.vmStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.vmChunks = [];
            
            // Determine the best supported audio format
            const mimeTypes = [
                'audio/webm',
                'audio/webm;codecs=opus',
                'audio/ogg;codecs=opus',
                'audio/mp4',
                'audio/mpeg'
            ];
            
            let selectedMimeType = '';
            for (const type of mimeTypes) {
                if (MediaRecorder.isTypeSupported(type)) {
                    selectedMimeType = type;
                    break;
                }
            }
            
            if (!selectedMimeType) {
                // Fallback to default
                this.vmMediaRecorder = new MediaRecorder(this.vmStream);
                selectedMimeType = this.vmMediaRecorder.mimeType;
            } else {
                this.vmMediaRecorder = new MediaRecorder(this.vmStream, { mimeType: selectedMimeType });
            }
            
            this.vmMimeType = selectedMimeType;
            this.vmStartTime = Date.now();
            
            console.log('[VOICE RECORDING] Using MIME type:', selectedMimeType);
            
            this.vmMediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) this.vmChunks.push(e.data);
            };
            
            this.vmMediaRecorder.onstop = () => {
                this.vmBlob = new Blob(this.vmChunks, { type: this.vmMimeType });
                console.log('[VOICE RECORDING] Created blob with type:', this.vmMimeType, 'size:', this.vmBlob.size);
                this.showVMPreview();
            };
            
            this.vmMediaRecorder.start();
            
            document.getElementById('vm-recorder-ready').style.display = 'none';
            document.getElementById('vm-recorder-recording').style.display = 'block';
            
            // Update timer
            this.vmTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - this.vmStartTime) / 1000);
                if (elapsed >= 120) { // 2 minute max
                    this.stopVMRecording();
                    return;
                }
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('vm-recording-time').textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
            
        } catch (err) {
            console.error('Recording error:', err);
            this.toast('Could not access microphone', 'error');
        }
    },
    
    stopVMRecording() {
        if (this.vmMediaRecorder && this.vmMediaRecorder.state === 'recording') {
            this.vmMediaRecorder.stop();
        }
        if (this.vmStream) {
            this.vmStream.getTracks().forEach(track => track.stop());
        }
        if (this.vmTimerInterval) {
            clearInterval(this.vmTimerInterval);
        }
    },
    
    cancelVMRecording() {
        this.stopVMRecording();
        this.resetVMRecorder();
    },
    
    showVMPreview() {
        const url = URL.createObjectURL(this.vmBlob);
        const audio = document.getElementById('vm-preview-player');
        audio.src = url;
        
        const duration = Math.floor((Date.now() - this.vmStartTime) / 1000);
        const mins = Math.floor(duration / 60);
        const secs = duration % 60;
        document.getElementById('vm-preview-duration').textContent = 
            `Duration: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        
        document.getElementById('vm-recorder-recording').style.display = 'none';
        document.getElementById('vm-recorder-preview').style.display = 'block';
    },
    
    retryVMRecording() {
        this.resetVMRecorder();
    },
    
    async uploadVoiceMessage() {
        const title = document.getElementById('vm-title').value.trim();
        if (!title) {
            this.toast('Please add a title', 'error');
            return;
        }
        
        document.getElementById('vm-recorder-preview').style.display = 'none';
        document.getElementById('vm-recorder-uploading').style.display = 'block';
        document.getElementById('vm-upload-btn').disabled = true;
        
        // Determine file extension based on MIME type
        let extension = 'webm'; // default
        if (this.vmMimeType) {
            if (this.vmMimeType.includes('webm')) extension = 'webm';
            else if (this.vmMimeType.includes('ogg')) extension = 'ogg';
            else if (this.vmMimeType.includes('mp4')) extension = 'm4a';
            else if (this.vmMimeType.includes('mpeg') || this.vmMimeType.includes('mp3')) extension = 'mp3';
            else if (this.vmMimeType.includes('wav')) extension = 'wav';
        }
        
        const filename = `voice-message.${extension}`;
        console.log('[VOICE UPLOAD] Uploading as:', filename, 'MIME:', this.vmMimeType, 'Size:', this.vmBlob.size);
        
        const formData = new FormData();
        formData.append('audio', this.vmBlob, filename);
        formData.append('title', title);
        formData.append('description', document.getElementById('vm-description').value.trim());
        formData.append('is_public', document.getElementById('vm-public').checked ? '1' : '0');
        formData.append('duration', Math.floor((Date.now() - this.vmStartTime) / 1000));
        
        const opts = {
            method: 'POST',
            headers: { 'X-API-Key': KEY },
            credentials: 'include',
            body: formData
        };
        
        try {
            console.log('[VOICE UPLOAD] Sending request...');
            console.log('[VOICE UPLOAD] Endpoint:', `${API}?endpoint=voice-messages&action=upload`);
            console.log('[VOICE UPLOAD] FormData keys:', Array.from(formData.keys()));
            
            const resp = await fetch(`${API}?endpoint=voice-messages&action=upload`, opts);
            console.log('[VOICE UPLOAD] Response status:', resp.status, resp.statusText);
            
            const r = await resp.json();
            console.log('[VOICE UPLOAD] Response:', r);
            
            if (r.success) {
                this.toast('‚úÖ Voice message posted!', 'success');
                this.closeModal('record-voice');
                this.loadVoiceMessages('all');
            } else {
                // Show specific error message
                let errorMsg = r.error || 'Upload failed';
                if (errorMsg.includes('Invalid file type')) {
                    errorMsg += ` (Your browser recorded as: ${this.vmMimeType}). Try a different browser or clear cache.`;
                }
                throw new Error(errorMsg);
            }
        } catch (err) {
            console.error('[VOICE UPLOAD] Upload error:', err);
            console.error('[VOICE UPLOAD] Error details:', err.message);
            this.toast(`‚ùå ${err.message}`, 'error');
            document.getElementById('vm-recorder-preview').style.display = 'block';
            document.getElementById('vm-recorder-uploading').style.display = 'none';
            document.getElementById('vm-upload-btn').disabled = false;
        }
    },
    
    async trackPlay(messageId) {
        await this.api('voice-messages', 'track-play', 'POST', { message_id: messageId });
    },
    
    async toggleVMLike(messageId) {
        if (!this.user) {
            this.toast('Please login to like messages', 'error');
            return;
        }
        const r = await this.api('voice-messages', 'toggle-like', 'POST', { message_id: messageId });
        if (r.success) {
            this.loadVoiceMessages(document.querySelector('[id^="vm-filter-"][style*="primary"]')?.id.replace('vm-filter-', '') || 'all');
        }
    },
    
    async deleteVoiceMessage(messageId) {
        if (!confirm('Delete this voice message?')) return;
        const r = await this.api('voice-messages', 'delete', 'POST', { message_id: messageId });
        if (r.success) {
            this.toast('üóëÔ∏è Message deleted', 'success');
            this.loadVoiceMessages(document.querySelector('[id^="vm-filter-"][style*="primary"]')?.id.replace('vm-filter-', '') || 'all');
        }
    },
    
    async deletePhoto(photoId) {
        if (!confirm('Delete this photo? This cannot be undone.')) return;
        const r = await this.api('photos', 'delete', 'POST', { photo_id: photoId });
        if (r.success) {
            this.toast('üóëÔ∏è Photo deleted', 'success');
            // Reload profile to show updated photos
            if (this.user) {
                this.showMyProfile();
            }
        } else {
            this.toast(r.error || 'Failed to delete photo', 'error');
        }
    },
    
    async togglePhotoLock(photoId) {
        const r = await this.api('profile', 'toggle-photo-lock', 'POST', { photo_id: photoId });
        if (r.success) {
            const lockStatus = r.is_locked ? 'üîí Locked' : 'üîì Unlocked';
            this.toast(`Photo ${lockStatus} - Only premium members can view locked photos`, 'success');
            // Reload profile to show updated lock status
            if (this.user) {
                this.showMyProfile();
            }
        } else {
            this.toast(r.error || 'Failed to toggle lock', 'error');
        }
    },
    
    async blockUser(userId) {
        if (!confirm('Block this user? They will no longer be able to message you.')) return;
        const r = await this.api('social', 'block-user', 'POST', { blocked_id: userId });
        if (r.success) {
            this.toast('üö´ User blocked', 'success');
            this.closeModal('profile');
        } else {
            this.toast(r.error || 'Failed to block user', 'error');
        }
    },
    
    async unblockUser(userId) {
        if (!confirm('Unblock this user?')) return;
        const r = await this.api('social', 'unblock-user', 'POST', { blocked_id: userId });
        if (r.success) {
            this.toast('‚úÖ User unblocked', 'success');
        } else {
            this.toast(r.error || 'Failed to unblock user', 'error');
        }
    },
    
    async deleteVoiceRecording(recordingId) {
        if (!confirm('Delete this voice recording? This cannot be undone.')) return;
        const r = await this.api('voice-recordings', 'delete', 'POST', { recording_id: recordingId });
        if (r.success) {
            this.toast('üóëÔ∏è Recording deleted', 'success');
            // Reload profile to show updated recordings
            if (this.user) {
                this.showMyProfile();
            }
        } else {
            this.toast(r.error || 'Failed to delete recording', 'error');
        }
    },
    
    async editVoiceMessage(messageId) {
        const newTitle = prompt('New title:');
        if (!newTitle) return;
        const newDesc = prompt('New description (optional):');
        const r = await this.api('voice-messages', 'edit', 'POST', { 
            message_id: messageId, 
            title: newTitle,
            description: newDesc || ''
        });
        if (r.success) {
            this.toast('‚úÖ Message updated', 'success');
            this.loadVoiceMessages(document.querySelector('[id^="vm-filter-"][style*="primary"]')?.id.replace('vm-filter-', '') || 'all');
        }
    },
    
    formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${String(secs).padStart(2, '0')}`;
    },
    
    // ==================== BLOCKING ====================
    
    async blockUser(userId) {
        if (!this.user) return;
        if (userId === this.user.id) {
            this.toast('Cannot block yourself', 'error');
            return;
        }
        
        const reason = prompt('Reason for blocking (optional):');
        if (reason === null) return; // User cancelled
        
        const r = await this.api('social', 'block-user', 'POST', { blocked_id: userId, reason });
        if (r.success) {
            this.toast('üö´ User blocked', 'success');
            this.loadVoiceMessages('all'); // Refresh to hide blocked user content
        }
    },
    
    async showBlockedUsers() {
        this.showModal('blocked-users');
        this.loadBlockedUsers();
    },
    
    async loadBlockedUsers() {
        const container = document.getElementById('blocked-users-list');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.api('social', 'get-blocked-users', 'GET');
        const blocked = r.data?.blocked || [];
        
        if (!blocked.length) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><h3>No blocked users</h3><p>You haven\'t blocked anyone yet</p></div>';
            return;
        }
        
        container.innerHTML = blocked.map(b => `
            <div class="blocked-user-item" style="display:flex;align-items:center;justify-content:space-between;padding:15px;background:var(--darker);border-radius:8px;margin-bottom:10px">
                <div style="display:flex;align-items:center;gap:15px">
                    <div style="width:50px;height:50px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:20px">
                        ${b.username?.charAt(0).toUpperCase() || '?'}
                    </div>
                    <div>
                        <div style="font-weight:600">${this.esc(b.username)}</div>
                        <div style="font-size:12px;color:#888">Blocked ${this.timeAgo(b.created_at)}</div>
                        ${b.reason ? `<div style="font-size:11px;color:#666;margin-top:4px">Reason: ${this.esc(b.reason)}</div>` : ''}
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="APP.unblockUser(${b.blocked_id})">Unblock</button>
            </div>
        `).join('');
    },
    
    async unblockUser(userId) {
        if (!confirm('Unblock this user?')) return;
        const r = await this.api('social', 'unblock-user', 'POST', { blocked_id: userId });
        if (r.success) {
            this.toast('‚úÖ User unblocked', 'success');
            this.loadBlockedUsers();
        }
    },
    
    // ==================== ADMIN CREATE USER ====================
    
    showCreateUser() {
        if (!this.user?.is_admin) {
            this.toast('Admin access required', 'error');
            return;
        }
        this.showModal('create-user');
        // Reset form
        document.getElementById('create-user-form').reset();
    },
    
    async createUserSubmit(e) {
        e.preventDefault();
        
        const username = document.getElementById('cu-username').value.trim();
        const email = document.getElementById('cu-email').value.trim();
        const password = document.getElementById('cu-password').value;
        const gender = document.getElementById('cu-gender').value;
        const dob = document.getElementById('cu-dob').value;
        const isPremium = document.getElementById('cu-premium').checked;
        const isAdmin = document.getElementById('cu-admin').checked;
        
        if (!username || !email || !password) {
            this.toast('Please fill all required fields', 'error');
            return false;
        }
        
        if (password.length < 6) {
            this.toast('Password must be at least 6 characters', 'error');
            return false;
        }
        
        const r = await this.api('admin', 'create-user', 'POST', {
            username,
            email,
            password,
            gender,
            date_of_birth: dob,
            subscription_type: isPremium ? 'premium' : 'free',
            is_admin: isAdmin ? 1 : 0
        });
        
        if (r.success) {
            this.toast('‚úÖ User created successfully!', 'success');
            this.closeModal('create-user');
            this.loadAdminUsers();
        } else {
            this.toast(r.error || 'Failed to create user', 'error');
        }
        
        return false;
    },
    
    showGiftShop() { this.toast('Gift shop coming soon!', 'info'); },
    showMyGifts() { this.toast('My gifts coming soon!', 'info'); },
    showBuyCoins() { 
        this.showModal('membership');
        this.initPayPalButtons();
    },
    showMembership() { 
        this.showModal('membership');
        this.initPayPalButtons();
    },

    showView(name) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        const view = document.getElementById(`view-${name}`);
        if (view) view.style.display = 'block';
        document.querySelector(`.sidebar-item[data-view="${name}"]`)?.classList.add('active');
        this.currentView = name;
        if (name === 'messages' && this.user) this.loadConversations();
        if (name === 'favorites' && this.user) this.loadFavorites();
        if (name === 'winks' && this.user) this.loadWinks();
        if (name === 'visitors' && this.user) this.loadVisitors();
        if (name === 'voice-messages' && this.user) this.loadVoiceMessages('all');
        if (name === 'rooms') this.loadRooms();
        if (name === 'gallery') this.loadGallery();
        if (name === 'stories') this.loadStories();
        if (name === 'hotornot') this.loadHotOrNot();
        if (name === 'admin' && this.user?.is_admin) this.loadAdminOverview();
    },

    showModal(name) { document.getElementById(`modal-${name}`)?.classList.add('show'); },
    closeModal(name) { 
        document.getElementById(`modal-${name}`)?.classList.remove('show');
        if (name === 'chat-room') this.leaveChatRoom();
    },
    toggleUserDropdown() { document.getElementById('user-dropdown')?.classList.toggle('show'); },

    confirmAge() { localStorage.setItem('age_verified', 'true'); this.closeModal('age'); this.init(); },
    exitSite() { window.location.href = 'https://google.com'; },
    
    showLegalModal(type) {
        // Don't close age modal when showing legal modals from landing page
        const ageModal = document.getElementById('modal-age');
        const wasAgeModalOpen = ageModal?.classList.contains('show');
        
        this.showModal(type);
        
        // Keep age modal visible in background
        if (wasAgeModalOpen) {
            ageModal.classList.add('show');
        }
    },

    toast(msg, type = 'info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
    },

    esc(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; },

    timeAgo(ts) {
        if (!ts) return '';
        const diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h';
        return Math.floor(diff / 86400) + 'd';
    },

    // ==================== PROFILE EDITING ====================
    profilePhotos: [],
    profileVoiceRecordings: [],
    maxPhotos: 12,
    maxVoiceRecordings: 5,
    profileVoiceRecorder: null,
    profileVoiceChunks: [],
    profileVoiceRecordingTimer: null,
    profileVoiceRecordingStartTime: 0,

    async showEditProfile() {
        if (!this.user) return this.showModal('login');
        
        // Show modal with loading state
        this.showModal('edit-profile');
        const container = document.getElementById('edit-profile-form');
        if (container) {
            container.style.opacity = '0.5';
            container.style.pointerEvents = 'none';
        }
        
        // Load profile data
        await this.loadProfileForEdit();
        
        // Remove loading state
        if (container) {
            container.style.opacity = '1';
            container.style.pointerEvents = 'auto';
        }
    },

    async loadProfileForEdit() {
        console.log('[LOAD PROFILE] Starting loadProfileForEdit for user:', this.user.id);
        
        const r = await this.apiGet('profile', 'get', { user_id: this.user.id });
        
        console.log('[LOAD PROFILE] Response:', r);
        
        if (r.success) {
            const p = r.data?.profile || r.profile;
            const photos = r.data?.photos || r.photos || [];
            const voiceRecordings = r.data?.voice_recordings || r.voice_recordings || [];
            
            console.log('[LOAD PROFILE] Profile data:', p);
            console.log('[LOAD PROFILE] Photos:', photos);
            console.log('[LOAD PROFILE] Voice recordings:', voiceRecordings);
            
            // Populate form fields
            document.getElementById('edit-display-name').value = p.display_name || p.username || '';
            document.getElementById('edit-tagline').value = p.tagline || '';
            document.getElementById('edit-about-me').value = p.about_me || '';
            document.getElementById('edit-gender').value = p.gender || '';
            document.getElementById('edit-orientation').value = p.orientation || '';
            document.getElementById('edit-country').value = p.country || '';
            document.getElementById('edit-city').value = p.city || '';
            document.getElementById('edit-body-type').value = p.body_type || '';
            document.getElementById('edit-height').value = p.height || '';
            document.getElementById('edit-hair-color').value = p.hair_color || '';
            document.getElementById('edit-eye-color').value = p.eye_color || '';
            document.getElementById('edit-relationship-status').value = p.relationship_status || '';
            document.getElementById('edit-smoker').value = p.smoker || '';
            document.getElementById('edit-drinker').value = p.drinker || '';
            document.getElementById('edit-occupation').value = p.occupation || '';
            document.getElementById('edit-age-pref-min').value = p.age_pref_min || '';
            document.getElementById('edit-age-pref-max').value = p.age_pref_max || '';
            document.getElementById('edit-interests').value = p.interests || '';
            document.getElementById('edit-kinks').value = p.kinks || '';
            
            const lookingFor = (p.looking_for || '').split(',').filter(x => x);
            ['friendship', 'fun', 'dating', 'relationship', 'couples', 'groups'].forEach(val => {
                const el = document.getElementById(`looking-${val}`);
                if (el) el.checked = lookingFor.includes(val);
            });
            
            document.getElementById('privacy-show-age').checked = p.show_age !== false;
            document.getElementById('privacy-show-location').checked = p.show_location !== false;
            document.getElementById('privacy-show-online').checked = p.show_online !== false;
            document.getElementById('privacy-profile-visitors').checked = p.allow_visitors !== false;
            
            this.profilePhotos = photos;
            this.profileVoiceRecordings = voiceRecordings;
            
            console.log('[LOAD PROFILE] Set profilePhotos to:', this.profilePhotos);
            console.log('[LOAD PROFILE] Set profileVoiceRecordings to:', this.profileVoiceRecordings);
            
            this.renderProfilePhotoSlots();
            this.renderProfileVoiceRecordings();
            
            console.log('[LOAD PROFILE] Complete!');
        } else {
            console.error('[LOAD PROFILE] Failed:', r.error);
            this.toast('Failed to load profile: ' + (r.error || 'Unknown error'), 'error');
        }
    },

    renderProfilePhotoSlots() {
        const container = document.getElementById('profile-photo-slots');
        if (!container) {
            console.error('[RENDER PHOTOS] Container not found!');
            return;
        }
        
        console.log('[RENDER PHOTOS] Rendering', this.profilePhotos.length, 'photos');
        console.log('[RENDER PHOTOS] Photos data:', this.profilePhotos);
        
        let html = '';
        
        this.profilePhotos.forEach((photo, i) => {
            const isPrimary = photo && photo.is_primary;
            const photoUrl = photo.photo_url.startsWith('http') ? photo.photo_url : `https://kinkntease.com${photo.photo_url}`;
            console.log('[RENDER PHOTOS] Photo', i, '- URL:', photoUrl, 'Primary:', isPrimary);
            html += `
                <div class="photo-slot has-photo ${isPrimary ? 'primary-photo' : ''}" data-index="${i}">
                    <img src="${photoUrl}" alt="Profile photo">
                    <div class="photo-slot-actions">
                        ${!isPrimary ? `<button type="button" class="photo-mini-btn" onclick="APP.setPrimaryPhoto(${i})" title="Set as primary">‚≠ê</button>` : ''}
                        <button type="button" class="photo-mini-btn" onclick="APP.deleteProfilePhoto(${i})" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        
        if (this.profilePhotos.length < this.maxPhotos) {
            html += `
                <div class="photo-slot" onclick="document.getElementById('profile-photo-input').click()">
                    <div style="font-size:30px;color:#666">+</div>
                    <div style="font-size:10px;color:#888;margin-top:5px">${this.profilePhotos.length}/${this.maxPhotos}</div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        console.log('[RENDER PHOTOS] Rendered HTML length:', html.length);
    },
    
    async addWatermark(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                img.onload = () => {
                    // Create canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size to image size
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Calculate watermark size and position
                    const fontSize = Math.max(20, img.width / 30);
                    const padding = fontSize;
                    
                    // Watermark text
                    const watermarkText = 'KinkNTease.com';
                    
                    // Configure text
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'bottom';
                    
                    // Measure text
                    const textMetrics = ctx.measureText(watermarkText);
                    const textWidth = textMetrics.width;
                    const textHeight = fontSize;
                    
                    // Position (bottom right with padding)
                    const x = canvas.width - padding;
                    const y = canvas.height - padding;
                    
                    // Draw semi-transparent background
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(
                        x - textWidth - padding/2, 
                        y - textHeight - padding/4, 
                        textWidth + padding, 
                        textHeight + padding/2
                    );
                    
                    // Draw watermark text
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fillText(watermarkText, x - padding/4, y - padding/4);
                    
                    // Convert canvas to blob
                    canvas.toBlob((blob) => {
                        if (blob) {
                            // Create file from blob with original filename
                            const watermarkedFile = new File([blob], file.name, {
                                type: file.type,
                                lastModified: Date.now()
                            });
                            resolve(watermarkedFile);
                        } else {
                            reject(new Error('Failed to create watermarked image'));
                        }
                    }, file.type, 0.92); // 92% quality
                };
                
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = e.target.result;
            };
            
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
        });
    },

    async handleProfilePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        console.log('[PHOTO UPLOAD] Selected file:', file.name, file.size, file.type);
        
        if (!file.type.startsWith('image/')) {
            this.toast('‚ùå Please select an image file (JPG, PNG, GIF, WebP)', 'error');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            this.toast('‚ùå File too large. Maximum 10MB allowed', 'error');
            return;
        }
        
        if (this.profilePhotos.length >= this.maxPhotos) {
            this.toast(`‚ùå Maximum ${this.maxPhotos} photos allowed`, 'error');
            return;
        }
        
        // Ask if user wants watermark
        const addWatermark = confirm('Add watermark to this photo?\n\n"KinkNTease.com" will be added to the bottom of the image.');
        
        // Show uploading message
        this.toast('üì§ Uploading photo...', 'info');
        
        // Apply watermark if requested
        let photoToUpload = file;
        if (addWatermark) {
            try {
                photoToUpload = await this.addWatermark(file);
            } catch (error) {
                console.error('[WATERMARK] Error:', error);
                this.toast('‚ö†Ô∏è Could not add watermark, uploading original', 'warning');
            }
        }
        
        const formData = new FormData();
        formData.append('photo', photoToUpload);
        formData.append('is_primary', this.profilePhotos.length === 0 ? 'true' : 'false');
        
        console.log('[PHOTO UPLOAD] FormData created. Is primary:', this.profilePhotos.length === 0);
        console.log('[PHOTO UPLOAD] Uploading to:', `${API}?endpoint=profile&action=upload-photo`);
        
        try {
            const opts = {
                method: 'POST',
                headers: { 'X-API-Key': KEY },
                credentials: 'include',
                body: formData
            };
            
            const resp = await fetch(`${API}?endpoint=profile&action=upload-photo`, opts);
            console.log('[PHOTO UPLOAD] Response status:', resp.status);
            
            const r = await resp.json();
            console.log('[PHOTO UPLOAD] Response:', r);
            
            if (r.success) {
                this.toast('‚úÖ Photo uploaded successfully!', 'success');
                await this.loadProfileForEdit(); // Reload to show new photo
                this.updateHeaderAvatar(); // Update nav avatar if primary
            } else {
                console.error('[PHOTO UPLOAD] Error:', r.error);
                this.toast('‚ùå ' + (r.error || 'Upload failed'), 'error');
            }
        } catch (error) {
            console.error('[PHOTO UPLOAD] Exception:', error);
            this.toast('‚ùå Upload failed: ' + error.message, 'error');
        }
        
        event.target.value = '';
    },

    async setPrimaryPhoto(index) {
        const photo = this.profilePhotos[index];
        if (!photo) return;
        
        const r = await this.api('profile', 'set-primary-photo', 'POST', { photo_id: photo.id });
        
        if (r.success) {
            this.toast('‚úÖ Primary photo updated', 'success');
            this.loadProfileForEdit();
        } else {
            this.toast(r.error || 'Failed to update', 'error');
        }
    },

    async deleteProfilePhoto(index) {
        const photo = this.profilePhotos[index];
        if (!photo) return;
        
        if (!confirm('Delete this photo?')) return;
        
        const r = await this.api('profile', 'delete-photo', 'POST', { photo_id: photo.id });
        
        if (r.success) {
            this.toast('üóëÔ∏è Photo deleted', 'success');
            this.loadProfileForEdit();
        } else {
            this.toast(r.error || 'Failed to delete', 'error');
        }
    },

    // ==================== PROFILE VOICE RECORDINGS ====================
    
    renderProfileVoiceRecordings() {
        const container = document.getElementById('profile-voice-recordings-list');
        
        if (!this.profileVoiceRecordings || this.profileVoiceRecordings.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;font-size:13px">No voice recordings yet</div>';
            return;
        }
        
        let html = '';
        this.profileVoiceRecordings.forEach((v, i) => {
            html += `
                <div class="voice-recording-item">
                    <button class="voice-play-btn" onclick="APP.playVoiceMessage('${v.audio_url}')">‚ñ∂</button>
                    <div class="voice-recording-info">
                        <div class="voice-recording-title">${this.esc(v.title || 'Recording ' + (i+1))}</div>
                        <div class="voice-recording-duration">${v.duration || '0:00'}</div>
                    </div>
                    <div class="voice-recording-actions">
                        <button onclick="APP.deleteProfileVoiceRecording(${v.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    updateHeaderAvatar() {
        // Update the nav avatar with primary photo
        if (this.user && this.profilePhotos && this.profilePhotos.length > 0) {
            const primaryPhoto = this.profilePhotos.find(p => p.is_primary);
            if (primaryPhoto) {
                const avatarEl = document.getElementById('nav-avatar');
                if (avatarEl) {
                    const photoUrl = primaryPhoto.photo_url.startsWith('http') ? 
                        primaryPhoto.photo_url : 
                        `https://kinkntease.com${primaryPhoto.photo_url}`;
                    avatarEl.style.backgroundImage = `url('${photoUrl}')`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.style.backgroundPosition = 'center';
                    avatarEl.textContent = '';
                }
            }
        }
    },

    async startProfileVoiceRecording() {
        if (this.profileVoiceRecordings.length >= this.maxVoiceRecordings) {
            this.toast(`Maximum ${this.maxVoiceRecordings} voice recordings allowed`, 'error');
            return;
        }
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            this.profileVoiceRecorder = new MediaRecorder(stream);
            this.profileVoiceChunks = [];
            
            this.profileVoiceRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) this.profileVoiceChunks.push(e.data);
            };
            
            this.profileVoiceRecorder.start();
            this.profileVoiceRecordingStartTime = Date.now();
            
            // Show recorder UI
            document.getElementById('profile-voice-recorder').style.display = 'block';
            document.getElementById('record-voice-btn').disabled = true;
            
            // Update timer
            this.profileVoiceRecordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - this.profileVoiceRecordingStartTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('profile-recording-time').textContent = `${mins}:${secs}`;
                
                // Auto-stop at 2 minutes
                if (elapsed >= 120) {
                    this.stopProfileVoiceRecording();
                }
            }, 1000);
            
        } catch (err) {
            this.toast('Microphone access denied', 'error');
            console.error(err);
        }
    },

    cancelProfileVoiceRecording() {
        if (this.profileVoiceRecorder && this.profileVoiceRecorder.state !== 'inactive') {
            this.profileVoiceRecorder.stop();
            this.profileVoiceRecorder.stream.getTracks().forEach(track => track.stop());
        }
        
        if (this.profileVoiceRecordingTimer) {
            clearInterval(this.profileVoiceRecordingTimer);
            this.profileVoiceRecordingTimer = null;
        }
        
        document.getElementById('profile-voice-recorder').style.display = 'none';
        document.getElementById('record-voice-btn').disabled = false;
        this.profileVoiceChunks = [];
    },

    async stopProfileVoiceRecording() {
        if (!this.profileVoiceRecorder || this.profileVoiceRecorder.state === 'inactive') return;
        
        return new Promise((resolve) => {
            this.profileVoiceRecorder.onstop = async () => {
                // Stop timer
                if (this.profileVoiceRecordingTimer) {
                    clearInterval(this.profileVoiceRecordingTimer);
                    this.profileVoiceRecordingTimer = null;
                }
                
                // Create audio blob
                const audioBlob = new Blob(this.profileVoiceChunks, { type: 'audio/webm' });
                
                // Stop tracks
                this.profileVoiceRecorder.stream.getTracks().forEach(track => track.stop());
                
                // Hide recorder UI
                document.getElementById('profile-voice-recorder').style.display = 'none';
                document.getElementById('record-voice-btn').disabled = false;
                
                // Get title
                const title = document.getElementById('voice-recording-title').value.trim() || 'Voice Intro';
                
                // Upload voice recording
                await this.uploadProfileVoiceRecording(audioBlob, title);
                
                // Clear title input
                document.getElementById('voice-recording-title').value = '';
                
                this.profileVoiceChunks = [];
                resolve();
            };
            
            this.profileVoiceRecorder.stop();
        });
    },

    async uploadProfileVoiceRecording(audioBlob, title) {
        this.toast('üì§ Uploading voice recording...', 'info');
        
        const formData = new FormData();
        formData.append('voice', audioBlob, 'voice.webm');
        formData.append('title', title);
        
        try {
            const opts = {
                method: 'POST',
                headers: { 'X-API-Key': KEY },
                credentials: 'include',
                body: formData
            };
            
            const resp = await fetch(`${API}?endpoint=profile&action=upload-voice`, opts);
            const r = await resp.json();
            
            if (r.success) {
                this.toast('‚úÖ Voice recording uploaded!', 'success');
                this.loadProfileForEdit();
            } else {
                this.toast(r.error || 'Failed to upload voice recording', 'error');
            }
        } catch (err) {
            this.toast('Failed to upload voice recording', 'error');
            console.error(err);
        }
    },

    async deleteProfileVoiceRecording(voiceId) {
        if (!confirm('Delete this voice recording?')) return;
        
        const r = await this.api('profile', 'delete-voice', 'POST', { voice_id: voiceId });
        
        if (r.success) {
            this.toast('üóëÔ∏è Voice recording deleted', 'success');
            this.loadProfileForEdit();
        } else {
            this.toast(r.error || 'Failed to delete', 'error');
        }
    },

    async saveProfile(e) {
        e.preventDefault();
        
        const errBox = document.getElementById('edit-profile-error');
        const successBox = document.getElementById('edit-profile-success');
        errBox.style.display = 'none';
        successBox.style.display = 'none';
        
        const lookingFor = [];
        ['friendship', 'fun', 'dating', 'relationship', 'couples', 'groups'].forEach(val => {
            if (document.getElementById(`looking-${val}`).checked) lookingFor.push(val);
        });
        
        const profileData = {
            display_name: document.getElementById('edit-display-name').value.trim(),
            tagline: document.getElementById('edit-tagline').value.trim(),
            about_me: document.getElementById('edit-about-me').value.trim(),
            gender: document.getElementById('edit-gender').value,
            orientation: document.getElementById('edit-orientation').value,
            country: document.getElementById('edit-country').value.trim(),
            city: document.getElementById('edit-city').value.trim(),
            body_type: document.getElementById('edit-body-type').value,
            height: document.getElementById('edit-height').value.trim(),
            hair_color: document.getElementById('edit-hair-color').value,
            eye_color: document.getElementById('edit-eye-color').value,
            relationship_status: document.getElementById('edit-relationship-status').value,
            smoker: document.getElementById('edit-smoker').value,
            drinker: document.getElementById('edit-drinker').value,
            occupation: document.getElementById('edit-occupation').value.trim(),
            age_pref_min: document.getElementById('edit-age-pref-min').value,
            age_pref_max: document.getElementById('edit-age-pref-max').value,
            interests: document.getElementById('edit-interests').value.trim(),
            kinks: document.getElementById('edit-kinks').value.trim(),
            looking_for: lookingFor.join(','),
            show_age: document.getElementById('privacy-show-age').checked,
            show_location: document.getElementById('privacy-show-location').checked,
            show_online: document.getElementById('privacy-show-online').checked,
            allow_visitors: document.getElementById('privacy-profile-visitors').checked
        };
        
        const r = await this.api('profile', 'update', 'POST', profileData);
        
        if (r.success) {
            successBox.textContent = '‚úÖ Profile updated successfully!';
            successBox.style.display = 'block';
            
            setTimeout(() => {
                this.closeModal('edit-profile');
                this.toast('Profile updated!', 'success');
            }, 1500);
        } else {
            errBox.textContent = r.error || 'Failed to update profile';
            errBox.style.display = 'block';
        }
        
        return false;
    },

    // ==================== MULTIMEDIA MESSAGING ====================
    
    emojis: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ','‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','üíã','üî•','üíØ','üí¢','üí•','üí´','üí¶','üí®','üï≥Ô∏è','üí¨','üëÅÔ∏è‚Äçüó®Ô∏è','üó®Ô∏è','üóØÔ∏è','üí≠','üí§'],
    
    emojiPickerOpen: null,
    voiceRecordingContext: null,
    voiceRecorder: null,
    voiceChunks: [],
    voiceRecordingTimer: null,
    voiceRecordingStartTime: 0,
    
    videoCallActive: false,
    localStream: null,
    remoteStream: null,
    videoEnabled: true,
    audioEnabled: true,

    toggleEmojiPicker(context) {
        const picker = document.getElementById(`emoji-picker-${context}`);
        
        if (this.emojiPickerOpen === context) {
            picker.classList.remove('show');
            this.emojiPickerOpen = null;
            return;
        }
        
        // Close other pickers
        document.querySelectorAll('.emoji-picker').forEach(p => p.classList.remove('show'));
        
        // Build emoji picker if empty
        if (!picker.innerHTML) {
            const categories = [
                { title: 'Smileys', emojis: this.emojis.slice(0, 64) },
                { title: 'Hearts & Hands', emojis: this.emojis.slice(64, 128) },
                { title: 'Symbols', emojis: this.emojis.slice(128) }
            ];
            
            let html = '';
            categories.forEach(cat => {
                html += `<div class="emoji-category">
                    <div class="emoji-category-title">${cat.title}</div>
                    <div class="emoji-grid">
                        ${cat.emojis.map(e => `<button type="button" class="emoji-btn" onclick="APP.insertEmoji('${e}', '${context}')">${e}</button>`).join('')}
                    </div>
                </div>`;
            });
            picker.innerHTML = html;
        }
        
        picker.classList.add('show');
        this.emojiPickerOpen = context;
    },

    insertEmoji(emoji, context) {
        const inputId = context === 'room' ? 'room-message-input' : 'msg-input';
        const input = document.getElementById(inputId);
        if (!input) return;
        
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        
        input.value = text.substring(0, start) + emoji + text.substring(end);
        input.focus();
        input.selectionStart = input.selectionEnd = start + emoji.length;
        
        // Close picker
        document.getElementById(`emoji-picker-${context}`).classList.remove('show');
        this.emojiPickerOpen = null;
    },

    async sendPhoto(event, context) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            this.toast('Please select an image file', 'error');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            this.toast('Image too large. Max 10MB', 'error');
            return;
        }
        
        this.toast('üì§ Uploading photo...', 'info');
        
        const formData = new FormData();
        formData.append('photo', file);
        
        try {
            let endpoint, action;
            if (context === 'room') {
                formData.append('room_id', this.currentRoom.id);
                endpoint = 'chat-rooms';
                action = 'send-photo';
            } else {
                formData.append('to_user_id', this.currentConv);
                endpoint = 'messages';
                action = 'send-photo';
            }
            
            const opts = {
                method: 'POST',
                headers: { 'X-API-Key': KEY },
                credentials: 'include',
                body: formData
            };
            
            const resp = await fetch(`${API}?endpoint=${endpoint}&action=${action}`, opts);
            const r = await resp.json();
            
            if (r.success) {
                this.toast('‚úÖ Photo sent!', 'success');
                if (context === 'room') {
                    this.loadRoomMessages();
                } else {
                    this.loadMessages(this.currentConv);
                }
            } else {
                this.toast(r.error || 'Failed to send photo', 'error');
            }
        } catch (err) {
            this.toast('Failed to upload photo', 'error');
            console.error(err);
        }
        
        event.target.value = '';
    },

    async startVoiceRecording(context) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            this.voiceRecorder = new MediaRecorder(stream);
            this.voiceChunks = [];
            this.voiceRecordingContext = context;
            
            this.voiceRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) this.voiceChunks.push(e.data);
            };
            
            this.voiceRecorder.start();
            this.voiceRecordingStartTime = Date.now();
            
            // Show recorder UI
            document.getElementById(`voice-recorder-${context}`).classList.add('show');
            
            // Update timer
            this.voiceRecordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - this.voiceRecordingStartTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById(`recording-time-${context}`).textContent = `${mins}:${secs}`;
                
                // Auto-stop at 2 minutes
                if (elapsed >= 120) {
                    this.stopVoiceRecording();
                }
            }, 1000);
            
        } catch (err) {
            this.toast('Microphone access denied', 'error');
            console.error(err);
        }
    },

    cancelVoiceRecording() {
        if (this.voiceRecorder && this.voiceRecorder.state !== 'inactive') {
            this.voiceRecorder.stop();
            this.voiceRecorder.stream.getTracks().forEach(track => track.stop());
        }
        
        if (this.voiceRecordingTimer) {
            clearInterval(this.voiceRecordingTimer);
            this.voiceRecordingTimer = null;
        }
        
        document.querySelectorAll('.voice-recorder').forEach(r => r.classList.remove('show'));
        this.voiceChunks = [];
        this.voiceRecordingContext = null;
    },

    async stopVoiceRecording() {
        if (!this.voiceRecorder || this.voiceRecorder.state === 'inactive') return;
        
        return new Promise((resolve) => {
            this.voiceRecorder.onstop = async () => {
                // Stop timer
                if (this.voiceRecordingTimer) {
                    clearInterval(this.voiceRecordingTimer);
                    this.voiceRecordingTimer = null;
                }
                
                // Create audio blob
                const audioBlob = new Blob(this.voiceChunks, { type: 'audio/webm' });
                
                // Stop tracks
                this.voiceRecorder.stream.getTracks().forEach(track => track.stop());
                
                // Hide recorder UI
                document.querySelectorAll('.voice-recorder').forEach(r => r.classList.remove('show'));
                
                // Send voice message
                await this.sendVoiceMessage(audioBlob, this.voiceRecordingContext);
                
                this.voiceChunks = [];
                this.voiceRecordingContext = null;
                resolve();
            };
            
            this.voiceRecorder.stop();
        });
    },

    async sendVoiceMessage(audioBlob, context) {
        this.toast('üì§ Sending voice message...', 'info');
        
        const formData = new FormData();
        formData.append('voice', audioBlob, 'voice.webm');
        
        try {
            let endpoint, action;
            if (context === 'room') {
                formData.append('room_id', this.currentRoom.id);
                endpoint = 'chat-rooms';
                action = 'send-voice';
            } else {
                formData.append('to_user_id', this.currentConv);
                endpoint = 'messages';
                action = 'send-voice';
            }
            
            const opts = {
                method: 'POST',
                headers: { 'X-API-Key': KEY },
                credentials: 'include',
                body: formData
            };
            
            const resp = await fetch(`${API}?endpoint=${endpoint}&action=${action}`, opts);
            const r = await resp.json();
            
            if (r.success) {
                this.toast('‚úÖ Voice message sent!', 'success');
                if (context === 'room') {
                    this.loadRoomMessages();
                } else {
                    this.loadMessages(this.currentConv);
                }
            } else {
                this.toast(r.error || 'Failed to send voice message', 'error');
            }
        } catch (err) {
            this.toast('Failed to send voice message', 'error');
            console.error(err);
        }
    },

    async startVideoCall(userId) {
        if (!userId) {
            this.toast('Cannot start call', 'error');
            return;
        }
        
        try {
            // Request camera and microphone
            this.localStream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: true 
            });
            
            // Show video modal
            document.getElementById('video-call-modal').classList.add('show');
            
            // Set local video
            const videoSelf = document.getElementById('video-self');
            videoSelf.srcObject = this.localStream;
            
            this.videoCallActive = true;
            document.getElementById('call-status').textContent = 'Connected';
            
            this.toast('üìπ Video call started! (Demo mode)', 'info');
            
            // Note: Full WebRTC implementation would require signaling server
            // This is a UI demo - you'd need to implement WebRTC peer connection
            
        } catch (err) {
            this.toast('Camera/microphone access denied', 'error');
            console.error(err);
        }
    },

    toggleVideo() {
        if (!this.localStream) return;
        
        this.videoEnabled = !this.videoEnabled;
        this.localStream.getVideoTracks().forEach(track => {
            track.enabled = this.videoEnabled;
        });
        
        const btn = document.getElementById('video-toggle');
        btn.style.opacity = this.videoEnabled ? '1' : '0.5';
        this.toast(this.videoEnabled ? 'üìπ Camera on' : 'üìπ Camera off', 'info');
    },

    toggleAudio() {
        if (!this.localStream) return;
        
        this.audioEnabled = !this.audioEnabled;
        this.localStream.getAudioTracks().forEach(track => {
            track.enabled = this.audioEnabled;
        });
        
        const btn = document.getElementById('audio-toggle');
        btn.style.opacity = this.audioEnabled ? '1' : '0.5';
        this.toast(this.audioEnabled ? 'üé§ Mic on' : 'üé§ Mic off', 'info');
    },

    endVideoCall() {
        if (this.localStream) {
            this.localStream.getTracks().forEach(track => track.stop());
            this.localStream = null;
        }
        
        if (this.remoteStream) {
            this.remoteStream.getTracks().forEach(track => track.stop());
            this.remoteStream = null;
        }
        
        document.getElementById('video-call-modal').classList.remove('show');
        this.videoCallActive = false;
        this.videoEnabled = true;
        this.audioEnabled = true;
        
        this.toast('üìû Call ended', 'info');
    },

    playVoiceMessage(url) {
        const audio = new Audio(url);
        audio.play().catch(err => {
            this.toast('Failed to play voice message', 'error');
            console.error(err);
        });
    },

    // ==================== DELETE MEDIA ====================
    
    async deleteMessage(messageId, context) {
        if (!confirm('Delete this message?')) return;
        
        let endpoint, action;
        if (context === 'room') {
            endpoint = 'chat-rooms';
            action = 'delete-message';
        } else {
            endpoint = 'messages';
            action = 'delete';
        }
        
        const r = await this.api(endpoint, action, 'POST', { message_id: messageId });
        
        if (r.success) {
            this.toast('üóëÔ∏è Message deleted', 'success');
            
            // Remove from UI immediately
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) messageElement.remove();
            
            // Reload messages to sync
            if (context === 'room') {
                this.loadRoomMessages();
            } else if (this.currentConv) {
                this.loadMessages(this.currentConv.userId);
            }
        } else {
            this.toast(r.error || 'Failed to delete message', 'error');
        }
    },

    async deleteGalleryPhoto(photoId, category) {
        if (!confirm('Delete this photo from gallery?')) return;
        
        const r = await this.api('gallery', 'delete', 'POST', { photo_id: photoId });
        
        if (r.success) {
            this.toast('üóëÔ∏è Photo deleted', 'success');
            this.openGallery(category); // Reload gallery
        } else {
            this.toast(r.error || 'Failed to delete photo', 'error');
        }
    },

    async deleteStory(storyId) {
        if (!confirm('Delete this story? This cannot be undone.')) return;
        
        const r = await this.api('stories', 'delete', 'POST', { story_id: storyId });
        
        if (r.success) {
            this.toast('üóëÔ∏è Story deleted', 'success');
            this.loadStories(); // Reload stories list
        } else {
            this.toast(r.error || 'Failed to delete story', 'error');
        }
    },

    // ==================== ADMIN PANEL ====================
    
    currentAdminTab: 'overview',
    adminUsers: [],
    adminRooms: [],
    
    showAdminTab(tab) {
        // Hide all tabs
        document.querySelectorAll('.admin-tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
        
        // Show selected tab
        document.getElementById(`admin-tab-${tab}`).style.display = 'block';
        event.target.classList.add('active');
        
        this.currentAdminTab = tab;
        
        // Load data for tab
        if (tab === 'overview') this.loadAdminOverview();
        else if (tab === 'users') this.loadAdminUsers();
        else if (tab === 'rooms') this.loadAdminRooms();
        else if (tab === 'content') this.loadAdminContent();
        else if (tab === 'payments') this.loadAdminPayments();
        else if (tab === 'reports') this.loadAdminReports();
    },
    
    async loadAdminOverview() {
        const r = await this.api('admin', 'stats', 'GET');
        
        if (r.success) {
            const stats = r.data?.stats || r.stats || {};
            document.getElementById('admin-total-users').textContent = stats.total_users || 0;
            document.getElementById('admin-online-users').textContent = stats.online_users || 0;
            document.getElementById('admin-total-messages').textContent = stats.total_messages || 0;
            document.getElementById('admin-total-stories').textContent = stats.total_stories || 0;
            document.getElementById('admin-total-photos').textContent = stats.total_photos || 0;
            document.getElementById('admin-banned-users').textContent = stats.banned_users || 0;
            
            // Load recent activity
            this.loadAdminActivity();
        }
    },
    
    async loadAdminActivity() {
        const r = await this.api('admin', 'activity', 'GET');
        const container = document.getElementById('admin-recent-activity');
        
        if (r.success) {
            const activities = r.data?.activities || r.activities || [];
            
            if (!activities.length) {
                container.innerHTML = '<p style="text-align:center;color:#666">No recent activity</p>';
                return;
            }
            
            container.innerHTML = activities.map(a => `
                <div style="padding:12px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <strong style="color:#fff">${this.esc(a.username)}</strong>
                        <span style="color:#aaa;margin-left:8px">${this.esc(a.action)}</span>
                    </div>
                    <span style="color:#666;font-size:12px">${this.timeAgo(a.created_at)}</span>
                </div>
            `).join('');
        }
    },
    
    async loadAdminUsers() {
        const container = document.getElementById('admin-users-table');
        container.innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr>';
        
        const r = await this.api('admin', 'users', 'GET');
        
        if (r.success) {
            this.adminUsers = r.data?.users || r.users || [];
            this.renderAdminUsers(this.adminUsers);
        }
    },
    
    renderAdminUsers(users) {
        const container = document.getElementById('admin-users-table');
        
        if (!users.length) {
            container.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#666">No users found</td></tr>';
            return;
        }
        
        container.innerHTML = users.map(u => `
            <tr>
                <td>${u.id}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:10px">
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:12px">
                            ${(u.username || '?').charAt(0).toUpperCase()}
                        </div>
                        <span>${this.esc(u.username)}</span>
                    </div>
                </td>
                <td>${this.esc(u.email)}</td>
                <td><span class="status-badge ${u.is_online ? 'online' : 'offline'}">${u.is_online ? 'üü¢ Online' : '‚ö´ Offline'}</span></td>
                <td><span class="user-type ${u.subscription_type || 'free'}">${(u.subscription_type || 'free').toUpperCase()}</span></td>
                <td style="font-size:12px;color:#888">${new Date(u.created_at).toLocaleDateString()}</td>
                <td style="font-size:12px;color:#888">${u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never'}</td>
                <td>
                    <div class="admin-actions">
                        <button class="admin-action-btn" onclick="APP.viewUserAdmin(${u.id})" title="View">üëÅÔ∏è</button>
                        <button class="admin-action-btn" onclick="APP.editUserAdmin(${u.id})" title="Edit">‚úèÔ∏è</button>
                        ${(u.subscription_type || 'free') === 'free' ? 
                            `<button class="admin-action-btn" style="background:var(--secondary)" onclick="APP.grantPremium(${u.id})" title="Grant Premium">üíé</button>` : ''
                        }
                        ${u.is_banned ? 
                            `<button class="admin-action-btn" onclick="APP.unbanUser(${u.id})" title="Unban">‚úÖ</button>` :
                            `<button class="admin-action-btn danger" onclick="APP.banUser(${u.id})" title="Ban">üö´</button>`
                        }
                        <button class="admin-action-btn danger" onclick="APP.deleteUserAdmin(${u.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `).join('');
    },
    
    searchAdminUsers() {
        const query = document.getElementById('admin-user-search').value.toLowerCase();
        const filtered = this.adminUsers.filter(u => 
            (u.username || '').toLowerCase().includes(query) ||
            (u.email || '').toLowerCase().includes(query)
        );
        this.renderAdminUsers(filtered);
    },
    
    filterAdminUsers() {
        const filter = document.getElementById('admin-user-filter').value;
        let filtered = this.adminUsers;
        
        if (filter === 'online') filtered = this.adminUsers.filter(u => u.is_online);
        else if (filter === 'banned') filtered = this.adminUsers.filter(u => u.is_banned);
        else if (filter === 'premium') filtered = this.adminUsers.filter(u => u.subscription_type !== 'free');
        else if (filter === 'new') {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            filtered = this.adminUsers.filter(u => new Date(u.created_at) > weekAgo);
        }
        
        this.renderAdminUsers(filtered);
    },
    
    async viewUserAdmin(userId) {
        await this.viewProfile(userId);
    },
    
    async editUserAdmin(userId) {
        const user = this.adminUsers.find(u => u.id === userId);
        if (!user) return;
        
        const newUsername = prompt('Edit username:', user.username);
        if (!newUsername) return;
        
        const r = await this.api('admin', 'edit-user', 'POST', {
            user_id: userId,
            username: newUsername
        });
        
        if (r.success) {
            this.toast('‚úÖ User updated', 'success');
            this.loadAdminUsers();
        } else {
            this.toast(r.error || 'Failed to update user', 'error');
        }
    },
    
    async banUser(userId) {
        if (!confirm('Ban this user? They will not be able to log in.')) return;
        
        const reason = prompt('Ban reason (optional):') || 'Violated terms of service';
        
        const r = await this.api('admin', 'ban-user', 'POST', {
            user_id: userId,
            reason: reason
        });
        
        if (r.success) {
            this.toast('üö´ User banned', 'success');
            this.loadAdminUsers();
        } else {
            this.toast(r.error || 'Failed to ban user', 'error');
        }
    },
    
    async unbanUser(userId) {
        if (!confirm('Unban this user?')) return;
        
        const r = await this.api('admin', 'unban-user', 'POST', { user_id: userId });
        
        if (r.success) {
            this.toast('‚úÖ User unbanned', 'success');
            this.loadAdminUsers();
        } else {
            this.toast(r.error || 'Failed to unban user', 'error');
        }
    },
    
    async deleteUserAdmin(userId) {
        if (!confirm('‚ö†Ô∏è DELETE this user permanently? This cannot be undone!\n\nAll their content will be deleted.')) return;
        if (!confirm('Are you ABSOLUTELY sure? Type YES in the next prompt.')) return;
        
        const confirmation = prompt('Type YES to confirm deletion:');
        if (confirmation !== 'YES') {
            this.toast('Deletion cancelled', 'info');
            return;
        }
        
        const r = await this.api('admin', 'delete-user', 'POST', { user_id: userId });
        
        if (r.success) {
            this.toast('üóëÔ∏è User deleted permanently', 'success');
            this.loadAdminUsers();
        } else {
            this.toast(r.error || 'Failed to delete user', 'error');
        }
    },
    
    async grantPremium(userId) {
        const duration = prompt('Grant Premium for how long?\n\n1 = 1 month\n3 = 3 months\n12 = 12 months (1 year)\n999 = Lifetime\n\nEnter number of months:', '12');
        
        if (!duration) return;
        
        const months = parseInt(duration);
        if (isNaN(months) || months < 1) {
            this.toast('Invalid duration', 'error');
            return;
        }
        
        if (!confirm(`Grant Premium for ${months === 999 ? 'LIFETIME' : months + ' month(s)'}?`)) return;
        
        const reason = prompt('Reason for granting premium (optional):') || 'Admin grant';
        
        const r = await this.api('admin', 'grant-premium', 'POST', { 
            user_id: userId,
            duration_months: months,
            reason: reason
        });
        
        if (r.success) {
            this.toast(`üíé Premium granted for ${months === 999 ? 'lifetime' : months + ' month(s)'}!`, 'success');
            this.loadAdminUsers();
        } else {
            this.toast(r.error || 'Failed to grant premium', 'error');
        }
    },
    
    async loadAdminRooms() {
        const container = document.getElementById('admin-rooms-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.api('admin', 'rooms', 'GET');
        
        if (r.success) {
            this.adminRooms = r.data?.rooms || r.rooms || [];
            this.renderAdminRooms(this.adminRooms);
        }
    },
    
    renderAdminRooms(rooms) {
        const container = document.getElementById('admin-rooms-container');
        
        if (!rooms.length) {
            container.innerHTML = '<p style="text-align:center;color:#666;padding:40px">No chat rooms</p>';
            return;
        }
        
        container.innerHTML = rooms.map(room => `
            <div class="admin-room-card">
                <div class="admin-room-header">
                    <div>
                        <div class="admin-room-title">${this.esc(room.name)}</div>
                        ${room.description ? `<div style="color:#888;font-size:13px;margin-top:5px">${this.esc(room.description)}</div>` : ''}
                    </div>
                    <div style="text-align:right">
                        <div style="color:var(--secondary);font-size:14px;font-weight:600">${room.member_count || 0} members</div>
                        <div style="color:#666;font-size:11px;margin-top:3px">Created ${this.timeAgo(room.created_at)}</div>
                    </div>
                </div>
                <div class="admin-room-stats">
                    <span>üí¨ ${room.message_count || 0} messages</span>
                    <span>üü¢ ${room.online_count || 0} online</span>
                    <span>üìÖ ${new Date(room.created_at).toLocaleDateString()}</span>
                </div>
                <div class="admin-room-actions">
                    <button class="admin-action-btn" onclick="APP.editRoomAdmin(${room.id})">‚úèÔ∏è Edit</button>
                    <button class="admin-action-btn" onclick="APP.viewRoomMessages(${room.id})">üí¨ View Messages</button>
                    <button class="admin-action-btn danger" onclick="APP.deleteRoomAdmin(${room.id})">üóëÔ∏è Delete</button>
                </div>
            </div>
        `).join('');
    },
    
    showCreateRoom() {
        const name = prompt('Room name:');
        if (!name) return;
        
        const description = prompt('Room description (optional):') || '';
        
        this.createRoomAdmin(name, description);
    },
    
    async createRoomAdmin(name, description) {
        const r = await this.api('admin', 'create-room', 'POST', {
            name: name,
            description: description
        });
        
        if (r.success) {
            this.toast('‚úÖ Room created', 'success');
            this.loadAdminRooms();
        } else {
            this.toast(r.error || 'Failed to create room', 'error');
        }
    },
    
    async editRoomAdmin(roomId) {
        const room = this.adminRooms.find(r => r.id === roomId);
        if (!room) return;
        
        const newName = prompt('Edit room name:', room.name);
        if (!newName) return;
        
        const newDesc = prompt('Edit description:', room.description || '');
        
        const r = await this.api('admin', 'edit-room', 'POST', {
            room_id: roomId,
            name: newName,
            description: newDesc
        });
        
        if (r.success) {
            this.toast('‚úÖ Room updated', 'success');
            this.loadAdminRooms();
        } else {
            this.toast(r.error || 'Failed to update room', 'error');
        }
    },
    
    async viewRoomMessages(roomId) {
        this.currentRoom = roomId;
        this.showView('rooms');
        this.joinRoom(roomId);
    },
    
    async deleteRoomAdmin(roomId) {
        if (!confirm('Delete this chat room? All messages will be deleted.')) return;
        
        const r = await this.api('admin', 'delete-room', 'POST', { room_id: roomId });
        
        if (r.success) {
            this.toast('üóëÔ∏è Room deleted', 'success');
            this.loadAdminRooms();
        } else {
            this.toast(r.error || 'Failed to delete room', 'error');
        }
    },
    
    async loadAdminContent() {
        const type = document.getElementById('admin-content-type').value;
        const container = document.getElementById('admin-content-container');
        
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.api('admin', 'content', 'GET', { type: type });
        
        if (r.success) {
            const content = r.data?.content || r.content || [];
            this.renderAdminContent(content, type);
        }
    },
    
    renderAdminContent(content, type) {
        const container = document.getElementById('admin-content-container');
        
        if (!content.length) {
            container.innerHTML = '<p style="text-align:center;color:#666;padding:40px">No content found</p>';
            return;
        }
        
        if (type === 'stories') {
            container.innerHTML = '<div class="admin-content-grid">' + content.map(item => `
                <div class="admin-content-card">
                    <strong style="color:#fff">${this.esc(item.title)}</strong>
                    <div class="content-preview">${this.esc(item.content).substring(0, 150)}...</div>
                    <div class="content-meta">
                        <span>By ${this.esc(item.username)}</span>
                        <span>${this.timeAgo(item.created_at)}</span>
                    </div>
                    <button class="admin-action-btn danger" style="margin-top:10px" onclick="APP.deleteContentAdmin('story', ${item.id})">üóëÔ∏è Delete</button>
                </div>
            `).join('') + '</div>';
        } else if (type === 'gallery') {
            container.innerHTML = '<div class="admin-content-grid">' + content.map(item => `
                <div class="admin-content-card">
                    <img src="https://kinkntease.com${item.photo_url}" style="width:100%;border-radius:8px;margin-bottom:10px">
                    ${item.caption ? `<div style="color:#aaa;font-size:13px">${this.esc(item.caption)}</div>` : ''}
                    <div class="content-meta">
                        <span>By ${this.esc(item.username)}</span>
                        <span>${this.timeAgo(item.created_at)}</span>
                    </div>
                    <button class="admin-action-btn danger" style="margin-top:10px" onclick="APP.deleteContentAdmin('photo', ${item.id})">üóëÔ∏è Delete</button>
                </div>
            `).join('') + '</div>';
        }
    },
    
    searchAdminContent() {
        // Implement content search
        this.loadAdminContent();
    },
    
    async deleteContentAdmin(type, id) {
        if (!confirm('Delete this content?')) return;
        
        let endpoint, action, param;
        if (type === 'story') {
            endpoint = 'stories';
            action = 'delete';
            param = { story_id: id };
        } else if (type === 'photo') {
            endpoint = 'gallery';
            action = 'delete';
            param = { photo_id: id };
        }
        
        const r = await this.api(endpoint, action, 'POST', param);
        
        if (r.success) {
            this.toast('üóëÔ∏è Content deleted', 'success');
            this.loadAdminContent();
        } else {
            this.toast(r.error || 'Failed to delete content', 'error');
        }
    },
    
    async loadAdminReports() {
        // Placeholder for future reports system
        this.toast('Reports system coming soon', 'info');
    },
    
    async loadAdminPayments() {
        const container = document.getElementById('admin-payments-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        const r = await this.api('payments', 'admin-transactions', 'GET');
        
        if (r.success) {
            const transactions = r.data?.transactions || [];
            this.renderAdminPayments(transactions);
            this.calculatePaymentStats(transactions);
        }
    },
    
    renderAdminPayments(transactions) {
        const container = document.getElementById('admin-payments-container');
        
        if (!transactions.length) {
            container.innerHTML = '<p style="text-align:center;color:#666;padding:40px">No transactions yet</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Subscription ID</th>
                    </tr>
                </thead>
                <tbody>
                    ${transactions.map(t => `
                        <tr>
                            <td>${t.id}</td>
                            <td>
                                <div style="display:flex;align-items:center;gap:10px">
                                    <div style="width:32px;height:32px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:12px">
                                        ${(t.username || '?').charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div>${this.esc(t.username)}</div>
                                        <div style="font-size:11px;color:#666">${this.esc(t.email)}</div>
                                    </div>
                                </div>
                            </td>
                            <td><span class="user-type ${t.plan_name.toLowerCase()}">${t.plan_name}</span></td>
                            <td style="color:var(--secondary);font-weight:600">$${parseFloat(t.amount).toFixed(2)}</td>
                            <td><span class="status-badge ${t.status}">${t.status.toUpperCase()}</span></td>
                            <td style="font-size:12px;color:#888">${new Date(t.created_at).toLocaleString()}</td>
                            <td style="font-size:11px;color:#666;font-family:monospace">${this.esc(t.subscription_id || 'N/A')}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },
    
    calculatePaymentStats(transactions) {
        const totalRevenue = transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        
        // Calculate this month's revenue
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthlyRevenue = transactions
            .filter(t => new Date(t.created_at) >= monthStart)
            .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        
        // Count premium members (from transactions)
        const premiumUsers = new Set(transactions.map(t => t.user_id)).size;
        
        // Update UI
        document.getElementById('admin-total-revenue').textContent = '$' + totalRevenue.toFixed(2);
        document.getElementById('admin-monthly-revenue').textContent = '$' + monthlyRevenue.toFixed(2);
        document.getElementById('admin-paying-users').textContent = premiumUsers;
        document.getElementById('admin-premium-count').textContent = premiumUsers;
        
        // Get free users count from API (total users - premium users)
        // For now, just show placeholder
        document.getElementById('admin-free-count').textContent = '-';
    },

    // ==================== PAYPAL PAYMENTS ====================
    
    paypalInitialized: false,
    
    initPayPalButtons() {
        if (this.paypalInitialized || !window.paypal) {
            console.log('PayPal already initialized or SDK not loaded');
            return;
        }
        
        // Premium plan configurations
        const plans = {
            monthly: {
                plan_id: 'P-2ED96768C0037884JNEWDHLA',
                price: '9.99',
                name: 'Premium',
                period: 'Monthly'
            },
            yearly: {
                plan_id: 'YOUR_YEARLY_PLAN_ID', // Update this after creating yearly plan in PayPal
                price: '99.00',
                name: 'Premium',
                period: 'Annual'
            }
        };
        
        // Initialize PayPal button for each plan
        ['monthly', 'yearly'].forEach(period => {
            const plan = plans[period];
            const container = `#paypal-premium-${period}`;
            
            if (document.querySelector(container)) {
                paypal.Buttons({
                    style: {
                        shape: 'rect',
                        color: 'gold',
                        layout: 'vertical',
                        label: 'subscribe'
                    },
                    
                    createSubscription: (data, actions) => {
                        return actions.subscription.create({
                            'plan_id': plan.plan_id
                        });
                    },
                    
                    onApprove: async (data, actions) => {
                        this.toast('‚úÖ Processing payment...', 'info');
                        
                        // Send subscription data to backend
                        const r = await this.api('payments', 'verify-subscription', 'POST', {
                            subscription_id: data.subscriptionID,
                            plan_name: plan.name,
                            plan_price: plan.price,
                            billing_period: plan.period
                        });
                        
                        if (r.success) {
                            this.toast('üéâ Membership upgraded successfully!', 'success');
                            this.closeModal('membership');
                            
                            // Update user subscription type
                            if (this.user) {
                                this.user.subscription_type = 'premium';
                            }
                            
                            // Reload page to reflect changes
                            setTimeout(() => window.location.reload(), 2000);
                        } else {
                            this.toast(r.error || 'Payment verification failed', 'error');
                        }
                    },
                    
                    onError: (err) => {
                        console.error('PayPal error:', err);
                        this.toast('Payment failed. Please try again.', 'error');
                    }
                }).render(container);
            }
        });
        
        this.paypalInitialized = true;
    },
    
    async cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your premium subscription?')) return;
        
        const r = await this.api('payment', 'cancel_subscription', 'POST');
        if (r.success) {
            this.toast('Subscription cancelled successfully', 'success');
            this.user.is_premium = false;
            this.user.membership_tier = null;
            this.updateAuthUI();
            this.closeModal('premium');
        } else {
            this.toast(r.error || 'Failed to cancel subscription', 'error');
        }
    }
};

document.addEventListener('DOMContentLoaded', () => APP.init());
</script>
</body>
</html>
